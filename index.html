<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>âš½ Quiniela Luan</title>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@400;600;700;900&display=swap');

:root {
  --bg: #0a0a0f;
  --card: #13131a;
  --card2: #1a1a24;
  --border: #2a2a3a;
  --accent: #7c3aed;
  --accent2: #a855f7;
  --green: #10b981;
  --red: #ef4444;
  --yellow: #f59e0b;
  --blue: #3b82f6;
  --text: #f1f0ff;
  --muted: #6b6b8a;
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

body {
  font-family: 'Outfit', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  padding: 12px;
}

/* TYPOGRAPHY */
.title-font { font-family: 'Bebas Neue', sans-serif; letter-spacing: 2px; }

/* LAYOUT */
.container { max-width: 480px; margin: 0 auto; }
.wide { max-width: 900px; margin: 0 auto; }

/* CARDS */
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 12px;
}

.card-glow {
  background: linear-gradient(135deg, #1a0a2e, #0a0a1e);
  border: 1px solid #3d1a6e;
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 12px;
  box-shadow: 0 0 30px rgba(124,58,237,0.2);
}

/* BUTTONS */
.btn {
  display: block;
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: 12px;
  font-family: 'Outfit', sans-serif;
  font-weight: 700;
  font-size: 0.95em;
  cursor: pointer;
  transition: all 0.2s;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.btn-purple {
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: white;
  box-shadow: 0 4px 20px rgba(124,58,237,0.4);
}
.btn-purple:hover { transform: translateY(-1px); box-shadow: 0 6px 25px rgba(124,58,237,0.5); }

.btn-green {
  background: linear-gradient(135deg, #059669, var(--green));
  color: white;
  box-shadow: 0 4px 15px rgba(16,185,129,0.3);
}

.btn-red {
  background: linear-gradient(135deg, #dc2626, var(--red));
  color: white;
}

.btn-gray {
  background: var(--card2);
  color: var(--muted);
  border: 1px solid var(--border);
}

.btn-sm {
  display: inline-block;
  width: auto;
  padding: 8px 16px;
  font-size: 0.8em;
}

.btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }

/* INPUTS */
.field { margin-bottom: 14px; }
.field label {
  display: block;
  font-size: 0.78em;
  font-weight: 700;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 6px;
}
.field input, .field select, .field textarea {
  width: 100%;
  padding: 12px 14px;
  background: var(--card2);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text);
  font-family: 'Outfit', sans-serif;
  font-size: 0.95em;
  font-weight: 600;
  transition: border-color 0.2s;
}
.field input:focus, .field select:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(124,58,237,0.15);
}

/* ALERTS */
.alert {
  padding: 12px 16px;
  border-radius: 10px;
  font-weight: 700;
  font-size: 0.9em;
  margin-bottom: 14px;
  border-left: 3px solid;
}
.alert-success { background: rgba(16,185,129,0.1); border-color: var(--green); color: var(--green); }
.alert-error { background: rgba(239,68,68,0.1); border-color: var(--red); color: var(--red); }
.alert-info { background: rgba(59,130,246,0.1); border-color: var(--blue); color: var(--blue); }
.alert-warning { background: rgba(245,158,11,0.1); border-color: var(--yellow); color: var(--yellow); }

/* HIDDEN */
.hidden { display: none !important; }

/* NAV TABS */
.tabs {
  display: flex;
  gap: 6px;
  overflow-x: auto;
  padding-bottom: 2px;
  margin-bottom: 14px;
  scrollbar-width: none;
}
.tabs::-webkit-scrollbar { display: none; }
.tab {
  flex-shrink: 0;
  padding: 8px 14px;
  border-radius: 8px;
  background: var(--card2);
  border: 1px solid var(--border);
  color: var(--muted);
  font-weight: 700;
  font-size: 0.8em;
  cursor: pointer;
  transition: all 0.2s;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.tab.active {
  background: var(--accent);
  border-color: var(--accent);
  color: white;
  box-shadow: 0 2px 10px rgba(124,58,237,0.4);
}

/* MATCH CARD */
.match-item {
  background: var(--card2);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px;
  margin-bottom: 10px;
  transition: border-color 0.2s;
}
.match-item:hover { border-color: var(--accent); }
.match-item.live { border-color: var(--red); background: rgba(239,68,68,0.05); }
.match-item.finished { border-color: var(--green); background: rgba(16,185,129,0.05); }

.match-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  font-size: 0.72em;
  font-weight: 700;
  color: var(--muted);
  text-transform: uppercase;
}

.match-teams {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
}

.team-side { text-align: center; }
.team-flag { font-size: 1.8em; display: block; margin-bottom: 4px; }
.team-name { font-size: 0.7em; font-weight: 700; color: var(--muted); text-transform: uppercase; }
.team-score-big { font-family: 'Bebas Neue', sans-serif; font-size: 2.5em; color: var(--accent2); line-height: 1; }

.vs-divider { font-family: 'Bebas Neue', sans-serif; font-size: 1.2em; color: var(--border); }

.score-row {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 12px;
}

.score-box {
  width: 64px;
  height: 64px;
  text-align: center;
  font-family: 'Bebas Neue', sans-serif;
  font-size: 2em;
  background: var(--card);
  border: 2px solid var(--accent);
  border-radius: 10px;
  color: var(--text);
  -moz-appearance: textfield;
}
.score-box::-webkit-outer-spin-button,
.score-box::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
.score-box:focus { outline: none; border-color: var(--accent2); box-shadow: 0 0 0 3px rgba(168,85,247,0.2); }

.score-dash { font-family: 'Bebas Neue', sans-serif; font-size: 1.5em; color: var(--muted); }

/* BADGE */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 8px;
  border-radius: 6px;
  font-size: 0.7em;
  font-weight: 700;
  text-transform: uppercase;
}
.badge-live { background: rgba(239,68,68,0.2); color: var(--red); border: 1px solid var(--red); animation: pulse 2s infinite; }
.badge-done { background: rgba(16,185,129,0.2); color: var(--green); border: 1px solid var(--green); }
.badge-admin { background: rgba(245,158,11,0.2); color: var(--yellow); border: 1px solid var(--yellow); }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.6} }

/* RANKING */
.rank-row {
  display: grid;
  grid-template-columns: 40px 1fr auto auto;
  align-items: center;
  gap: 10px;
  padding: 12px 14px;
  background: var(--card2);
  border: 1px solid var(--border);
  border-radius: 10px;
  margin-bottom: 8px;
  transition: all 0.2s;
}
.rank-row:hover { border-color: var(--accent); }
.rank-row.me { border-color: var(--yellow); background: rgba(245,158,11,0.08); }
.rank-pos { font-family: 'Bebas Neue', sans-serif; font-size: 1.4em; text-align: center; }
.rank-name { font-weight: 700; font-size: 0.9em; }
.rank-exact { font-size: 0.8em; color: var(--muted); text-align: center; }
.rank-pts { font-family: 'Bebas Neue', sans-serif; font-size: 1.6em; color: var(--accent2); }

/* HEADER */
.app-header {
  background: linear-gradient(135deg, #1a0a2e, #0d0d1a);
  border: 1px solid #3d1a6e;
  border-radius: 16px;
  padding: 16px 20px;
  margin-bottom: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* CHAT */
.chat-box {
  background: var(--card2);
  border: 1px solid var(--border);
  border-radius: 12px;
  height: 400px;
  overflow-y: auto;
  padding: 14px;
  margin-bottom: 10px;
  scroll-behavior: smooth;
}
.msg {
  margin-bottom: 10px;
  max-width: 80%;
  animation: fadeIn 0.3s ease;
}
.msg.own { margin-left: auto; text-align: right; }
.msg-bubble {
  display: inline-block;
  padding: 8px 14px;
  border-radius: 14px;
  font-size: 0.88em;
  font-weight: 600;
  word-break: break-word;
}
.msg.own .msg-bubble { background: var(--accent); color: white; border-bottom-right-radius: 4px; }
.msg.other .msg-bubble { background: var(--card); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
.msg-user { font-size: 0.72em; color: var(--muted); margin-bottom: 3px; font-weight: 700; }
.chat-input-row { display: flex; gap: 8px; }
.chat-input-row input {
  flex: 1;
  padding: 12px 14px;
  background: var(--card2);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text);
  font-family: 'Outfit', sans-serif;
  font-weight: 600;
}
.chat-input-row input:focus { outline: none; border-color: var(--accent); }
.chat-send {
  padding: 12px 18px;
  background: var(--accent);
  border: none;
  border-radius: 10px;
  color: white;
  font-size: 1.1em;
  cursor: pointer;
  transition: all 0.2s;
}
.chat-send:hover { background: var(--accent2); }

/* TOAST */
.toast-wrap { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 8px; align-items: center; }
.toast-msg {
  background: var(--card2);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 10px 20px;
  font-weight: 700;
  font-size: 0.88em;
  box-shadow: 0 8px 25px rgba(0,0,0,0.5);
  animation: slideUp 0.3s ease;
  white-space: nowrap;
}
@keyframes slideUp { from{transform:translateY(20px);opacity:0} to{transform:translateY(0);opacity:1} }
@keyframes fadeIn { from{opacity:0} to{opacity:1} }

/* MODAL */
.modal { display:none; position:fixed; z-index:9999; inset:0; background:rgba(0,0,0,0.85); backdrop-filter:blur(8px); overflow-y:auto; padding:20px; }
.modal-box { background:var(--card); border:1px solid var(--border); border-radius:20px; padding:24px; max-width:480px; margin:0 auto; position:relative; }
.modal-close { position:absolute; top:16px; right:16px; background:none; border:none; color:var(--muted); font-size:1.4em; cursor:pointer; }

/* EMPTY */
.empty { text-align:center; padding:40px 20px; color:var(--muted); }
.empty .icon { font-size:3em; margin-bottom:12px; display:block; }

/* DIVIDER */
.divider { border:none; border-top:1px solid var(--border); margin:16px 0; }

/* GRID */
.grid2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }

/* COUNTDOWN */
.countdown-box {
  background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(245,158,11,0.05));
  border: 1px solid rgba(245,158,11,0.3);
  border-radius: 12px;
  padding: 14px 18px;
  margin-bottom: 14px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.countdown-time {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 2.2em;
  color: var(--yellow);
  line-height: 1;
}

/* PREDICTION RESULT */
.pred-item {
  background: var(--card2);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 12px 14px;
  margin-bottom: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
}
.pred-match { font-size: 0.82em; font-weight: 700; flex: 1; }
.pred-score { font-family: 'Bebas Neue', sans-serif; font-size: 1.5em; color: var(--accent2); min-width: 60px; text-align: center; }
.pred-pts { font-size: 0.8em; font-weight: 700; }

/* GROUP CARD */
.group-card {
  background: var(--card2);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 10px;
}

/* ADMIN GRID */
.admin-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:16px; }
.admin-btn {
  padding: 14px;
  border-radius: 10px;
  background: var(--card2);
  border: 1px solid var(--border);
  color: var(--text);
  font-family: 'Outfit', sans-serif;
  font-weight: 700;
  font-size: 0.82em;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
}
.admin-btn:hover { border-color: var(--accent); color: var(--accent2); }

/* VZ TIME */
.vz-time { font-family:'Bebas Neue',sans-serif; font-size:1.3em; color:var(--accent2); }

@media(max-width:400px) {
  .score-box { width:56px; height:56px; font-size:1.7em; }
  .rank-row { grid-template-columns:32px 1fr auto auto; }
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     AUTH SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="authScreen" class="container">
  <div style="text-align:center;padding:40px 0 30px;">
    <div style="font-size:3.5em;margin-bottom:12px;">âš½</div>
    <h1 class="title-font" style="font-size:2.8em;background:linear-gradient(135deg,#a855f7,#7c3aed);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">QUINIELA LUAN</h1>
    <p style="color:var(--muted);font-size:0.85em;margin-top:6px;font-weight:600;">V16 ULTIMATE Â· SISTEMA MULTI-TORNEO</p>
  </div>

  <div id="alertAuth"></div>

  <div class="tabs" style="margin-bottom:20px;">
    <div class="tab active" onclick="showTab('loginTab','loginTabBtn')" id="loginTabBtn">ğŸ”‘ Entrar</div>
    <div class="tab" onclick="showTab('registerTab','registerTabBtn')" id="registerTabBtn">âœ¨ Registro</div>
  </div>

  <!-- LOGIN -->
  <div id="loginTab" class="card">
    <div class="field">
      <label>ğŸ“§ Email</label>
      <input type="email" id="loginEmail" placeholder="tu@email.com" autocomplete="email">
    </div>
    <div class="field">
      <label>ğŸ”‘ ContraseÃ±a</label>
      <input type="password" id="loginPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" onkeydown="if(event.key==='Enter') doLogin()">
    </div>
    <button class="btn btn-purple" onclick="doLogin()" id="loginBtn">ğŸš€ Iniciar SesiÃ³n</button>
    <p style="text-align:center;margin-top:14px;font-size:0.82em;">
      <a href="#" onclick="showResetPass()" style="color:var(--accent2);font-weight:700;">Â¿Olvidaste tu contraseÃ±a?</a>
    </p>
  </div>

  <!-- REGISTER -->
  <div id="registerTab" class="card hidden">
    <div class="card-glow" style="margin-bottom:14px;padding:12px 16px;">
      <p style="font-size:0.8em;color:var(--yellow);font-weight:700;">ğŸ‘‘ CÃ“DIGO ADMIN: <span style="color:white;">70484251307</span></p>
      <p style="font-size:0.75em;color:var(--muted);margin-top:4px;">Usa este cÃ³digo si eres el administrador. Otros necesitan cÃ³digo de invitaciÃ³n.</p>
    </div>
    <div class="field"><label>ğŸ‘¤ Nombre</label><input type="text" id="regName" placeholder="Luis LÃ¡rez"></div>
    <div class="field"><label>ğŸ“§ Email</label><input type="email" id="regEmail" placeholder="tu@email.com" autocomplete="email"></div>
    <div class="field"><label>ğŸ® Usuario</label><input type="text" id="regUser" placeholder="alias en la quiniela" autocomplete="username"></div>
    <div class="field"><label>ğŸ†” CÃ©dula</label><input type="text" id="regCedula" placeholder="12345678"></div>
    <div class="field"><label>ğŸ”‘ ContraseÃ±a</label><input type="password" id="regPass" placeholder="mÃ­nimo 6 caracteres" autocomplete="new-password"></div>
    <div class="field"><label>ğŸ”‘ Confirmar</label><input type="password" id="regPass2" placeholder="repite la contraseÃ±a" autocomplete="new-password"></div>
    <div class="field"><label>ğŸŸï¸ CÃ³digo de acceso</label><input type="text" id="regCode" placeholder="Admin o invitaciÃ³n"></div>
    <div id="regSteps" style="margin-bottom:12px;"></div>
    <button class="btn btn-green" onclick="doRegister()" id="regBtn">âœ¨ Crear Cuenta</button>
    <button class="btn btn-gray" onclick="showTab('loginTab','loginTabBtn')" style="margin-top:8px;">â† Volver</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="mainScreen" class="wide hidden">

  <!-- HEADER -->
  <div class="app-header">
    <div>
      <div style="font-size:0.75em;color:var(--muted);font-weight:700;text-transform:uppercase;">Bienvenido</div>
      <div style="font-weight:900;font-size:1.1em;">
        <span id="hdrName">â€”</span>
        <span id="hdrAdmin" class="badge badge-admin hidden" style="margin-left:8px;">ğŸ‘‘ Admin</span>
      </div>
      <div style="font-size:0.75em;color:var(--muted);margin-top:2px;">InvitaciÃ³n: <strong id="hdrCode" style="color:var(--accent2);">â€”</strong></div>
    </div>
    <div style="text-align:right;">
      <div class="vz-time" id="vzTime">00:00:00</div>
      <div style="font-size:0.7em;color:var(--muted);">Venezuela</div>
      <button class="btn btn-red btn-sm" onclick="doLogout()" style="margin-top:6px;width:auto;padding:6px 14px;font-size:0.75em;">ğŸšª Salir</button>
    </div>
  </div>

  <!-- NAV -->
  <div class="tabs">
    <div class="tab active" onclick="showScreen('matches')">âš½ Partidos</div>
    <div class="tab" onclick="showScreen('predictions')">ğŸ¯ Predicciones</div>
    <div class="tab" onclick="showScreen('ranking')">ğŸ“Š Pizarra</div>
    <div class="tab" onclick="showScreen('chat')">ğŸ’¬ Chat</div>
    <div class="tab" onclick="showScreen('tournaments')">ğŸ† Torneos</div>
    <div class="tab" onclick="showScreen('groups')">ğŸ‘¥ Grupos</div>
    <div class="tab hidden" id="adminTab" onclick="showScreen('admin')">âš™ï¸ Admin</div>
  </div>

  <div id="mainAlert"></div>

  <!-- â”€â”€ PARTIDOS â”€â”€ -->
  <div id="matchesScreen">
    <div class="countdown-box">
      <div>
        <div style="font-size:0.72em;color:var(--muted);font-weight:700;text-transform:uppercase;">â° Cierre de predicciones</div>
        <div style="font-size:0.82em;font-weight:700;margin-top:2px;" id="cdMatch">â€”</div>
      </div>
      <div class="countdown-time" id="cdTimer">--:--:--</div>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <h2 class="title-font" style="font-size:1.8em;">PARTIDOS</h2>
      <button class="btn btn-gray btn-sm" onclick="syncAPI()">ğŸ”„ Sync</button>
    </div>
    <div id="matchesList"></div>
    <button class="btn btn-green" onclick="savePreds()" style="margin-top:8px;">ğŸ’¾ Guardar Predicciones</button>
  </div>

  <!-- â”€â”€ PREDICCIONES â”€â”€ -->
  <div id="predictionsScreen" class="hidden">
    <h2 class="title-font" style="font-size:1.8em;margin-bottom:14px;">MIS PREDICCIONES</h2>

    <div class="card" style="margin-bottom:14px;">
      <p style="font-weight:700;margin-bottom:10px;font-size:0.88em;">ğŸ” Ver predicciones de otros jugadores</p>
      <div class="grid2" style="margin-bottom:8px;">
        <div class="field" style="margin:0;"><input type="text" id="su1" placeholder="Jugador 1"></div>
        <div class="field" style="margin:0;"><input type="text" id="su2" placeholder="Jugador 2"></div>
      </div>
      <div class="field" style="margin-bottom:8px;"><input type="text" id="su3" placeholder="Jugador 3 (opcional)"></div>
      <button class="btn btn-purple" onclick="searchPreds()">ğŸ” Buscar</button>
    </div>

    <div id="searchRes" class="hidden"></div>
    <hr class="divider">
    <h3 style="font-weight:800;margin-bottom:12px;font-size:0.95em;">ğŸ“‹ TUS PREDICCIONES</h3>
    <div id="myPredsList"></div>
  </div>

  <!-- â”€â”€ PIZARRA â”€â”€ -->
  <div id="rankingScreen" class="hidden">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
      <h2 class="title-font" style="font-size:1.8em;">PIZARRA</h2>
      <button class="btn btn-gray btn-sm" onclick="loadRanking()">ğŸ”„</button>
    </div>
    <div id="rankingList"></div>
  </div>

  <!-- â”€â”€ CHAT â”€â”€ -->
  <div id="chatScreen" class="hidden">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
      <h2 class="title-font" style="font-size:1.8em;">CHAT GLOBAL</h2>
      <button class="btn btn-red btn-sm hidden" id="clearChatBtn" onclick="clearChat()">ğŸ—‘ï¸ Limpiar</button>
    </div>
    <div class="chat-box" id="chatBox"></div>
    <div class="chat-input-row">
      <input type="text" id="chatInput" placeholder="Escribe un mensaje..." onkeydown="if(event.key==='Enter')sendMsg()">
      <button class="chat-send" onclick="sendMsg()">â¤</button>
    </div>
  </div>

  <!-- â”€â”€ TORNEOS â”€â”€ -->
  <div id="tournamentsScreen" class="hidden">
    <h2 class="title-font" style="font-size:1.8em;margin-bottom:14px;">TORNEOS</h2>
    <div id="tournamentsList"></div>
    <button class="btn btn-green" onclick="saveTournaments()">ğŸ’¾ Guardar selecciÃ³n</button>
  </div>

  <!-- â”€â”€ GRUPOS â”€â”€ -->
  <div id="groupsScreen" class="hidden">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
      <h2 class="title-font" style="font-size:1.8em;">GRUPOS</h2>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-purple btn-sm" onclick="openModal('createGrpModal')">â• Crear</button>
        <button class="btn btn-gray btn-sm" onclick="openModal('joinGrpModal')">ğŸ”— Unirse</button>
      </div>
    </div>
    <div id="groupsList"></div>
  </div>

  <!-- â”€â”€ ADMIN â”€â”€ -->
  <div id="adminScreen" class="hidden">
    <h2 class="title-font" style="font-size:1.8em;margin-bottom:14px;">PANEL ADMIN</h2>
    <div class="admin-grid">
      <button class="admin-btn" onclick="adminUsers()">ğŸ‘¥ Ver Usuarios</button>
      <button class="admin-btn" onclick="adminEval()">âš¡ Evaluar Partidos</button>
      <button class="admin-btn" onclick="adminPoints()">ğŸ¯ Config Puntos</button>
      <button class="admin-btn" onclick="adminReset()">ğŸ—‘ï¸ Borrar Datos</button>
    </div>
    <div id="adminContent"></div>
  </div>

</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- Reset pass -->
<div class="modal" id="resetPassModal">
  <div class="modal-box">
    <button class="modal-close" onclick="closeModal('resetPassModal')">âœ•</button>
    <h3 style="font-weight:900;margin-bottom:16px;">ğŸ” Recuperar ContraseÃ±a</h3>
    <div class="field"><label>ğŸ“§ Tu Email</label><input type="email" id="resetEmail" placeholder="tu@email.com"></div>
    <button class="btn btn-purple" onclick="sendReset()">ğŸ“¤ Enviar enlace</button>
  </div>
</div>

<!-- Create group -->
<div class="modal" id="createGrpModal">
  <div class="modal-box">
    <button class="modal-close" onclick="closeModal('createGrpModal')">âœ•</button>
    <h3 style="font-weight:900;margin-bottom:16px;">ğŸ‘¥ Crear Grupo</h3>
    <div class="field"><label>Nombre del grupo</label><input type="text" id="grpName" placeholder="Ej: Familia PÃ©rez" maxlength="30"></div>
    <div class="field"><label>MÃ¡ximo miembros</label>
      <select id="grpMax"><option value="10">10</option><option value="20" selected>20</option><option value="50">50</option></select>
    </div>
    <button class="btn btn-green" onclick="createGroup()">ğŸ‰ Crear Grupo</button>
  </div>
</div>

<!-- Join group -->
<div class="modal" id="joinGrpModal">
  <div class="modal-box">
    <button class="modal-close" onclick="closeModal('joinGrpModal')">âœ•</button>
    <h3 style="font-weight:900;margin-bottom:16px;">ğŸ”— Unirse a Grupo</h3>
    <div class="field"><label>CÃ³digo del grupo (6 caracteres)</label><input type="text" id="grpCode" placeholder="ABC123" maxlength="6" style="text-transform:uppercase;"></div>
    <button class="btn btn-purple" onclick="joinGroup()">âœ… Unirse</button>
  </div>
</div>

<!-- Group ranking -->
<div class="modal" id="grpRankModal">
  <div class="modal-box">
    <button class="modal-close" onclick="closeModal('grpRankModal')">âœ•</button>
    <h3 style="font-weight:900;margin-bottom:6px;" id="grpRankTitle">ğŸ† Grupo</h3>
    <p style="font-size:0.8em;color:var(--muted);margin-bottom:16px;">CÃ³digo: <strong id="grpRankCode" style="color:var(--accent2);">â€”</strong></p>
    <div id="grpRankList"></div>
  </div>
</div>

<!-- Points config -->
<div class="modal" id="pointsModal">
  <div class="modal-box">
    <button class="modal-close" onclick="closeModal('pointsModal')">âœ•</button>
    <h3 style="font-weight:900;margin-bottom:16px;">ğŸ¯ Configurar Puntos</h3>
    <div class="field"><label>â­ Exacto (puntos)</label>
      <select id="ptExact"></select>
    </div>
    <div class="field"><label>âœ… Resultado correcto (puntos)</label>
      <select id="ptResult"></select>
    </div>
    <button class="btn btn-green" onclick="savePoints()">ğŸ’¾ Guardar</button>
  </div>
</div>

<!-- Toast container -->
<div class="toast-wrap" id="toastWrap"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JAVASCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FIREBASE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FB_CFG = {
  apiKey: "AIzaSyCGfPIf-Q1x90hTne1tCMWNFuS0hio4CtA",
  authDomain: "quiniela-luan-25.firebaseapp.com",
  projectId: "quiniela-luan-25",
  storageBucket: "quiniela-luan-25.firebasestorage.app",
  messagingSenderId: "360325608839",
  appId: "1:360325608839:web:900af9bafc56bbcbfacf22"
};

const ADMIN_CODE = "70484251307";
const API_KEY    = "333289";

firebase.initializeApp(FB_CFG);
const auth = firebase.auth();
const db   = firebase.firestore();
// Persistencia desactivada â€” causaba bloqueos silenciosos en mÃ³vil

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let me = null;
let manualLogin = false;
let allMatches = [];
let dayMatches = [];
let ptsCfg = { exactScore: 5, correctResult: 3 };
let myTournaments = ['champions','europa','bundesliga','ligue1','seriea','premier','laliga'];
let cdInterval = null;
let vzInterval = null;

const TOURNAMENTS = [
  { id:'champions', name:'âš½ Champions League', lid:'4480' },
  { id:'europa',    name:'ğŸŒ Europa League',    lid:'4481' },
  { id:'bundesliga',name:'ğŸ‡©ğŸ‡ª Bundesliga',      lid:'4331' },
  { id:'ligue1',    name:'ğŸ‡«ğŸ‡· Ligue 1',         lid:'4334' },
  { id:'seriea',    name:'ğŸ‡®ğŸ‡¹ Serie A',          lid:'4332' },
  { id:'premier',   name:'ğŸ´ Premier League',   lid:'4328' },
  { id:'laliga',    name:'ğŸ‡ªğŸ‡¸ LaLiga',           lid:'4335' }
];

const FLAGS = {
  'Switzerland':'ğŸ‡¨ğŸ‡­','Mexico':'ğŸ‡²ğŸ‡½','Chile':'ğŸ‡¨ğŸ‡±','Canada':'ğŸ‡¨ğŸ‡¦','South Africa':'ğŸ‡¿ğŸ‡¦',
  'Croatia':'ğŸ‡­ğŸ‡·','Japan':'ğŸ‡¯ğŸ‡µ','Morocco':'ğŸ‡²ğŸ‡¦','Belgium':'ğŸ‡§ğŸ‡ª','Portugal':'ğŸ‡µğŸ‡¹',
  'Italy':'ğŸ‡®ğŸ‡¹','Brazil':'ğŸ‡§ğŸ‡·','South Korea':'ğŸ‡°ğŸ‡·','Germany':'ğŸ‡©ğŸ‡ª','Colombia':'ğŸ‡¨ğŸ‡´',
  'England':'ğŸ´ó §ó ¢ó ¥ó ®ó §ó ¿','Panama':'ğŸ‡µğŸ‡¦','Ireland':'ğŸ‡®ğŸ‡ª','Paraguay':'ğŸ‡µğŸ‡¾','Australia':'ğŸ‡¦ğŸ‡º',
  'Saudi Arabia':'ğŸ‡¸ğŸ‡¦','New Zealand':'ğŸ‡³ğŸ‡¿','United States':'ğŸ‡ºğŸ‡¸','France':'ğŸ‡«ğŸ‡·',
  'Poland':'ğŸ‡µğŸ‡±','Austria':'ğŸ‡¦ğŸ‡¹','Spain':'ğŸ‡ªğŸ‡¸','Argentina':'ğŸ‡¦ğŸ‡·','Venezuela':'ğŸ‡»ğŸ‡ª',
  'Suiza':'ğŸ‡¨ğŸ‡­','MÃ©xico':'ğŸ‡²ğŸ‡½','Costa Rica':'ğŸ‡¨ğŸ‡·','CanadÃ¡':'ğŸ‡¨ğŸ‡¦','SudÃ¡frica':'ğŸ‡¿ğŸ‡¦',
  'Croacia':'ğŸ‡­ğŸ‡·','JapÃ³n':'ğŸ‡¯ğŸ‡µ','Marruecos':'ğŸ‡²ğŸ‡¦','BÃ©lgica':'ğŸ‡§ğŸ‡ª','Qatar':'ğŸ‡¶ğŸ‡¦',
  'TÃºnez':'ğŸ‡¹ğŸ‡³','Honduras':'ğŸ‡­ğŸ‡³','Corea del Sur':'ğŸ‡°ğŸ‡·','Alemania':'ğŸ‡©ğŸ‡ª','PanamÃ¡':'ğŸ‡µğŸ‡¦',
  'Irlanda':'ğŸ‡®ğŸ‡ª','Arabia Saudita':'ğŸ‡¸ğŸ‡¦','Nueva Zelanda':'ğŸ‡³ğŸ‡¿','Estados Unidos':'ğŸ‡ºğŸ‡¸',
  'Francia':'ğŸ‡«ğŸ‡·','Polonia':'ğŸ‡µğŸ‡±','EspaÃ±a':'ğŸ‡ªğŸ‡¸','MalÃ­':'ğŸ‡²ğŸ‡±'
};

const USER_COLORS = ['#7c3aed','#ec4899','#10b981','#f59e0b','#3b82f6','#ef4444','#06b6d4'];
let colorMap = {};
function getColor(uid) {
  if (!colorMap[uid]) colorMap[uid] = USER_COLORS[Object.keys(colorMap).length % USER_COLORS.length];
  return colorMap[uid];
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UTILS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function $(id) { return document.getElementById(id); }

function alert_(msg, type='info', el='mainAlert') {
  const c = $(el);
  if (!c) return;
  c.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
  setTimeout(() => { if(c) c.innerHTML = ''; }, 5000);
}

function toast(msg, type='success') {
  const w = $('toastWrap');
  const t = document.createElement('div');
  const colors = { success:'#10b981', error:'#ef4444', warning:'#f59e0b', info:'#3b82f6' };
  t.className = 'toast-msg';
  t.style.borderLeft = `3px solid ${colors[type]||colors.info}`;
  t.textContent = msg;
  w.appendChild(t);
  setTimeout(() => t.remove(), 3200);
}

function openModal(id) { $(id).style.display = 'block'; }
function closeModal(id) { $(id).style.display = 'none'; }
window.onclick = e => { if (e.target.classList.contains('modal')) e.target.style.display = 'none'; };

function vzTime(utc) {
  if (!utc) return '--:--';
  const [h,m] = utc.split(':').map(Number);
  let vh = h - 4; if (vh < 0) vh += 24;
  return `${String(vh).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
}

function randCode(len=6) { const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let r=''; for(let i=0;i<len;i++) r+=chars[Math.floor(Math.random()*chars.length)]; return r; }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TABS (auth screen)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showTab(tabId, btnId) {
  ['loginTab','registerTab'].forEach(t => $(t).classList.add('hidden'));
  document.querySelectorAll('#authScreen .tab').forEach(b => b.classList.remove('active'));
  $(tabId).classList.remove('hidden');
  $(btnId).classList.add('active');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// AUTH â€” REGISTER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doRegister() {
  const name   = $('regName').value.trim();
  const email  = $('regEmail').value.trim();
  const user   = $('regUser').value.trim();
  const cedula = $('regCedula').value.trim();
  const pass   = $('regPass').value;
  const pass2  = $('regPass2').value;
  const code   = $('regCode').value.trim();

  // Validaciones bÃ¡sicas
  if (!name||!email||!user||!cedula||!pass||!pass2||!code) {
    alert_('âŒ Completa todos los campos','error','alertAuth'); return;
  }
  if (pass.length < 6) { alert_('âŒ ContraseÃ±a mÃ­nimo 6 caracteres','error','alertAuth'); return; }
  if (pass !== pass2)  { alert_('âŒ Las contraseÃ±as no coinciden','error','alertAuth'); return; }

  const isAdmin = (code === ADMIN_CODE);
  const btn = $('regBtn');
  btn.disabled = true;

  const steps = $('regSteps');
  const step = (msg, type='info') => { steps.innerHTML = `<div class="alert alert-${type}" style="font-size:0.82em;">${msg}</div>`; };

  try {
    step('â³ Verificando cÃ³digo...');

    // Verificar cÃ³digo (solo si NO es admin)
    if (!isAdmin) {
      try {
        const snap = await db.collection('users')
          .where('personalInviteCode','==', code.toUpperCase())
          .limit(1).get();
        if (snap.empty) {
          step('âŒ CÃ³digo de invitaciÃ³n invÃ¡lido','error');
          btn.disabled = false; return;
        }
      } catch(queryErr) {
        // Si falla la consulta, buscar en todos los usuarios manualmente
        const allUsers = await db.collection('users').get();
        const found = allUsers.docs.find(d => d.data().personalInviteCode === code.toUpperCase());
        if (!found) {
          step('âŒ CÃ³digo de invitaciÃ³n invÃ¡lido','error');
          btn.disabled = false; return;
        }
      }
    }

    step('â³ Creando cuenta en Firebase...');

    // Crear en Auth
    let fbUser;
    try {
      const cred = await auth.createUserWithEmailAndPassword(email, pass);
      fbUser = cred.user;
    } catch(authErr) {
      let msg = 'âŒ Error: ' + authErr.message;
      if (authErr.code==='auth/email-already-in-use') msg = 'âŒ Este email ya estÃ¡ registrado';
      if (authErr.code==='auth/invalid-email') msg = 'âŒ Email invÃ¡lido';
      if (authErr.code==='auth/weak-password') msg = 'âŒ ContraseÃ±a muy dÃ©bil (mÃ­nimo 6 caracteres)';
      step(msg,'error'); btn.disabled=false; return;
    }

    step('â³ Guardando perfil...');

    // Guardar en Firestore â€” con retry
    const invCode = randCode(6);
    const data = {
      name, username: user, email, cedula,
      personalInviteCode: invCode,
      isAdmin,
      points: 0, exactPredictions: 0, correctResults: 0,
      invitedBy: isAdmin ? 'MASTER' : code.toUpperCase(),
      tournaments: myTournaments,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    let saved = false;
    for (let attempt = 1; attempt <= 3; attempt++) {
      try {
        await db.collection('users').doc(fbUser.uid).set(data);
        saved = true; break;
      } catch(dbErr) {
        if (attempt === 3) {
          step(`âŒ Error Firestore (intento ${attempt}): ${dbErr.code} â€” ${dbErr.message}`,'error');
          btn.disabled = false; return;
        }
        await new Promise(r => setTimeout(r, 1000 * attempt));
      }
    }

    if (!saved) return;

    me = { uid: fbUser.uid, ...data };
    step(`âœ… ${isAdmin ? 'ğŸ‘‘ Â¡ADMIN CREADO!' : 'Â¡Cuenta creada!'} Entrando...`,'success');

    setTimeout(() => enterApp(), 1200);

  } catch(err) {
    step(`âŒ Error inesperado: ${err.message}`,'error');
    btn.disabled = false;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// AUTH â€” LOGIN
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doLogin() {
  const email = $('loginEmail').value.trim();
  const pass  = $('loginPass').value;

  if (!email || !pass) { alert_('âŒ Completa email y contraseÃ±a','error','alertAuth'); return; }

  const btn = $('loginBtn');
  btn.disabled = true;
  btn.textContent = 'â³ Entrando...';
  alert_('â³ Verificando...','info','alertAuth');
  manualLogin = true;

  try {
    // Login en Firebase Auth
    let fbUser;
    try {
      const cred = await auth.signInWithEmailAndPassword(email, pass);
      fbUser = cred.user;
    } catch(authErr) {
      let msg = 'âŒ Error al iniciar sesiÃ³n';
      const c = authErr.code;
      if (c==='auth/user-not-found'||c==='auth/invalid-credential') msg = 'âŒ Email o contraseÃ±a incorrectos';
      else if (c==='auth/wrong-password') msg = 'âŒ ContraseÃ±a incorrecta';
      else if (c==='auth/too-many-requests') msg = 'âŒ Demasiados intentos. Espera unos minutos.';
      else if (c==='auth/network-request-failed') msg = 'âŒ Sin conexiÃ³n a internet';
      alert_(msg,'error','alertAuth');
      manualLogin = false; btn.disabled=false; btn.textContent='ğŸš€ Iniciar SesiÃ³n'; return;
    }

    // Obtener perfil de Firestore
    let userDoc;
    try {
      userDoc = await db.collection('users').doc(fbUser.uid).get();
    } catch(dbErr) {
      alert_(`âŒ Error cargando perfil: ${dbErr.message}`,'error','alertAuth');
      btn.disabled=false; btn.textContent='ğŸš€ Iniciar SesiÃ³n'; return;
    }

    if (!userDoc.exists) {
      // Usuario en Auth pero sin perfil en Firestore
      alert_('âŒ Perfil no encontrado. Contacta al admin.','error','alertAuth');
      await auth.signOut();
      btn.disabled=false; btn.textContent='ğŸš€ Iniciar SesiÃ³n'; return;
    }

    me = { uid: fbUser.uid, ...userDoc.data() };
    enterApp();

  } catch(err) {
    alert_(`âŒ Error: ${err.message}`,'error','alertAuth');
    manualLogin=false; btn.disabled=false; btn.textContent='ğŸš€ Iniciar SesiÃ³n';
  }
}

// Auto-login SOLO al recargar pÃ¡gina (no durante login manual)
auth.onAuthStateChanged(async user => {
  if (manualLogin) return; // Si estamos en login manual, ignorar
  if (user && !me) {
    try {
      const doc = await db.collection('users').doc(user.uid).get();
      if (doc.exists) { me = { uid: user.uid, ...doc.data() }; enterApp(); }
      else await auth.signOut();
    } catch(e) { /* sin conexiÃ³n, ignorar */ }
  }
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ENTER APP
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function enterApp() {
  $('authScreen').classList.add('hidden');
  $('mainScreen').classList.remove('hidden');

  $('hdrName').textContent = me.username;
  $('hdrCode').textContent = me.personalInviteCode || 'â€”';
  if (me.isAdmin) {
    $('hdrAdmin').classList.remove('hidden');
    $('adminTab').classList.remove('hidden');
    $('clearChatBtn').classList.remove('hidden');
  }
  if (me.tournaments) myTournaments = me.tournaments;

  startVzTime();
  loadPtsCfg();
  syncAPI();
  showScreen('matches');
  toast(`ğŸ‰ Â¡Bienvenido ${me.username}!`,'success');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LOGOUT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doLogout() {
  clearInterval(cdInterval);
  clearInterval(vzInterval);
  await auth.signOut();
  me = null; allMatches = []; dayMatches = [];
  $('mainScreen').classList.add('hidden');
  $('authScreen').classList.remove('hidden');
  $('loginBtn').disabled = false;
  $('loginBtn').textContent = 'ğŸš€ Iniciar SesiÃ³n';
  alert_('ğŸ‘‹ SesiÃ³n cerrada','info','alertAuth');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RESET PASSWORD
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showResetPass() { openModal('resetPassModal'); }
async function sendReset() {
  const email = $('resetEmail').value.trim();
  if (!email) { toast('âŒ Ingresa tu email','error'); return; }
  try {
    await auth.sendPasswordResetEmail(email);
    toast('âœ… Enlace enviado. Revisa tu correo.','success');
    closeModal('resetPassModal');
  } catch(e) { toast('âŒ Email no registrado','error'); }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// VENEZUELA TIME + COUNTDOWN
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startVzTime() {
  const update = () => {
    const now = new Date();
    $('vzTime').textContent = now.toLocaleTimeString('es-VE',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  };
  update();
  vzInterval = setInterval(update, 1000);
  cdInterval = setInterval(updateCountdown, 1000);
  updateCountdown();
}

function updateCountdown() {
  const el = $('cdTimer'); const mel = $('cdMatch');
  if (!el) return;
  const pending = dayMatches.filter(m => m.status === 'Not Started');
  if (!pending.length) { el.textContent = '-- : -- : --'; return; }
  const first = pending.sort((a,b)=>(a.time||'23:59').localeCompare(b.time||'23:59'))[0];
  mel.textContent = `${first.home} vs ${first.away}`;
  const dt = new Date(`${first.date}T${first.time||'23:59'}`);
  const diff = dt - Date.now() - 4*3600000;
  if (diff <= 0) { el.textContent = 'CERRADO'; return; }
  const h=Math.floor(diff/3600000), m=Math.floor((diff%3600000)/60000), s=Math.floor((diff%60000)/1000);
  el.textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SCREEN NAVIGATION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SCREENS = ['matches','predictions','ranking','chat','tournaments','groups','admin'];
function showScreen(name) {
  SCREENS.forEach(s => $(s+'Screen').classList.add('hidden'));
  document.querySelectorAll('#mainScreen .tabs .tab').forEach(t => t.classList.remove('active'));
  $(name+'Screen').classList.remove('hidden');

  const tabs = [...document.querySelectorAll('#mainScreen .tabs .tab')];
  const map = { matches:0, predictions:1, ranking:2, chat:3, tournaments:4, groups:5, admin:6 };
  if (tabs[map[name]]) tabs[map[name]].classList.add('active');

  if (name==='predictions') loadMyPreds();
  if (name==='ranking')     loadRanking();
  if (name==='chat')        loadChat();
  if (name==='tournaments') renderTournaments();
  if (name==='groups')      loadGroups();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// API SYNC
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function syncAPI() {
  alert_('ğŸ”„ Sincronizando partidos...','info');
  const found = [];
  try {
    for (const t of TOURNAMENTS) {
      if (!myTournaments.includes(t.id)) continue;
      const res = await fetch(`https://www.thesportsdb.com/api/v1/json/${API_KEY}/eventsnextleague.php?id=${t.lid}`);
      if (!res.ok) continue;
      const data = await res.json();
      (data?.events || []).forEach(ev => found.push({
        id: ev.idEvent, home: ev.strHomeTeam, away: ev.strAwayTeam,
        homeFlag: FLAGS[ev.strHomeTeam]||'âš½', awayFlag: FLAGS[ev.strAwayTeam]||'âš½',
        date: ev.dateEvent, time: ev.strTime||'00:00',
        homeScore: ev.intHomeScore!=null ? +ev.intHomeScore : null,
        awayScore: ev.intAwayScore!=null ? +ev.intAwayScore : null,
        status: ev.strStatus||'Not Started',
        venue: ev.strVenue||'â€”', round: ev.intRound||1,
        tournamentId: t.id, tournamentName: t.name
      }));
    }
    if (found.length) {
      allMatches = found;
      const b = db.batch();
      found.forEach(m => b.set(db.collection('matches').doc(m.id), m, {merge:true}));
      await b.commit();
      loadDayMatches();
      alert_(`âœ… ${found.length} partidos sincronizados`,'success');
    } else {
      alert_('âš ï¸ Sin partidos disponibles. Prueba en otro momento.','warning');
    }
  } catch(e) {
    alert_('âš ï¸ Error de red. Cargando datos guardados...','warning');
    // Load from Firestore cache
    try {
      const snap = await db.collection('matches').get();
      allMatches = snap.docs.map(d=>({id:d.id,...d.data()}));
      loadDayMatches();
    } catch(e2) { console.error(e2); }
  }
}

function loadDayMatches() {
  const today = new Date().toISOString().split('T')[0];
  const upcoming = allMatches.filter(m => m.date >= today);
  const pool = upcoming.length
    ? allMatches.filter(m => m.date === [...new Set(upcoming.map(m=>m.date))].sort()[0])
    : allMatches.filter(m => m.date === [...allMatches].sort((a,b)=>b.date.localeCompare(a.date))[0]?.date);
  dayMatches = pool;
  renderMatches(dayMatches);
  updateCountdown();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RENDER MATCHES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMatches(list) {
  const el = $('matchesList');
  if (!list.length) {
    el.innerHTML = `<div class="empty"><span class="icon">ğŸ“­</span>Sin partidos. Pulsa Sync.</div>`;
    return;
  }
  const sorted = [...list].sort((a,b)=>(a.time||'23:59').localeCompare(b.time||'23:59'));
  el.innerHTML = '';
  sorted.forEach(m => el.appendChild(buildMatchCard(m)));
}

function buildMatchCard(m) {
  const div = document.createElement('div');
  div.className = 'match-item' + (m.status==='In Play'?' live':m.status==='Match Finished'?' finished':'');

  const isLive     = m.status === 'In Play';
  const isFinished = m.status === 'Match Finished';

  const badge = isLive
    ? `<span class="badge badge-live">ğŸ”´ En Vivo</span>`
    : isFinished
    ? `<span class="badge badge-done">âœ… Final</span>`
    : `<span style="font-family:'Bebas Neue',sans-serif;font-size:1.1em;color:var(--accent2);">â° ${vzTime(m.time)}</span>`;

  const scoreArea = (isLive||isFinished)
    ? ''
    : `<div class="score-row">
        <input type="number" min="0" max="20" value="0" id="hs_${m.id}" class="score-box">
        <span class="score-dash">â€”</span>
        <input type="number" min="0" max="20" value="0" id="as_${m.id}" class="score-box">
       </div>`;

  div.innerHTML = `
    <div class="match-meta">
      <span>${m.tournamentName||'Torneo'}</span>
      ${badge}
    </div>
    <div class="match-teams">
      <div class="team-side">
        <span class="team-flag">${m.homeFlag}</span>
        <span class="team-name">${m.home}</span>
        ${isLive||isFinished?`<span class="team-score-big">${m.homeScore??0}</span>`:''}
      </div>
      <div class="vs-divider">VS</div>
      <div class="team-side">
        <span class="team-flag">${m.awayFlag}</span>
        <span class="team-name">${m.away}</span>
        ${isLive||isFinished?`<span class="team-score-big">${m.awayScore??0}</span>`:''}
      </div>
    </div>
    ${scoreArea}`;
  return div;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SAVE PREDICTIONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function savePreds() {
  if (!me?.uid) return;
  const jDate = dayMatches[0]?.date;
  if (!jDate) { alert_('âŒ No hay partidos cargados','error'); return; }

  const preds = [];
  dayMatches.forEach(m => {
    const hi = $(`hs_${m.id}`), ai = $(`as_${m.id}`);
    if (hi && ai) preds.push({ matchId:m.id, h:+hi.value||0, a:+ai.value||0, match:m });
  });
  if (!preds.length) { alert_('âŒ Sin predicciones para guardar','error'); return; }

  try {
    const b = db.batch();
    preds.forEach(p => b.set(db.collection('predictions').doc(), {
      userId:me.uid, username:me.username,
      matchId:p.matchId, predictedHomeScore:p.h, predictedAwayScore:p.a,
      home:p.match.home, away:p.match.away, homeFlag:p.match.homeFlag, awayFlag:p.match.awayFlag,
      tournamentId:p.match.tournamentId, jornadaDate:jDate,
      evaluated:false, timestamp:firebase.firestore.FieldValue.serverTimestamp()
    }));
    await b.commit();
    toast(`âœ… ${preds.length} predicciones guardadas`,'success');
  } catch(e) { toast(`âŒ Error: ${e.message}`,'error'); }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MY PREDICTIONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadMyPreds() {
  const el = $('myPredsList');
  el.innerHTML = `<div class="empty"><span class="icon">â³</span>Cargando...</div>`;
  try {
    const snap = await db.collection('predictions').where('userId','==',me.uid).limit(50).get();
    if (snap.empty) { el.innerHTML=`<div class="empty"><span class="icon">ğŸ“­</span>Sin predicciones aÃºn</div>`; return; }
    const preds = snap.docs.map(d=>({id:d.id,...d.data()}))
      .sort((a,b)=>(b.timestamp?.toDate()||0)-(a.timestamp?.toDate()||0));
    el.innerHTML = '';
    preds.forEach(p => {
      const match = allMatches.find(m=>m.id===p.matchId);
      const div = document.createElement('div');
      div.className = 'pred-item';
      div.innerHTML = `
        <div class="pred-match">${p.homeFlag} ${p.home}<br><span style="color:var(--muted);font-size:0.82em;">vs ${p.away} ${p.awayFlag}</span></div>
        <div class="pred-score">${p.predictedHomeScore}â€“${p.predictedAwayScore}</div>
        ${match&&match.homeScore!=null?`<div style="text-align:center;font-size:0.8em;color:var(--muted);">Real<br><strong style="color:var(--green);font-size:1.2em;">${match.homeScore}â€“${match.awayScore}</strong></div>`:''}
        <div class="pred-pts" style="color:${p.evaluated?'var(--green)':'var(--muted)'};">${p.evaluated?`+${p.pointsAwarded||0}pts`:'â³'}</div>`;
      el.appendChild(div);
    });
  } catch(e) { el.innerHTML=`<div class="empty"><span class="icon">âŒ</span>${e.message}</div>`; }
}

// SEARCH OTHER PLAYERS
async function searchPreds() {
  const names = [$('su1'),$('su2'),$('su3')].map(i=>i.value.trim()).filter(Boolean);
  if (!names.length) { toast('âŒ Escribe al menos un nombre','error'); return; }
  const el = $('searchRes');
  el.classList.remove('hidden');
  el.innerHTML = `<div class="empty"><span class="icon">â³</span>Buscando...</div>`;
  let html = '';
  for (const uname of names) {
    let snap = await db.collection('users').where('username','==',uname).limit(1).get();
    if (snap.empty) snap = await db.collection('users').where('username','==',uname.toLowerCase()).limit(1).get();
    if (snap.empty) { html+=`<div class="card" style="border-color:var(--red);margin-bottom:10px;"><p style="color:var(--red);font-weight:700;">âŒ "${uname}" no encontrado</p></div>`; continue; }
    const user={id:snap.docs[0].id,...snap.docs[0].data()};
    const color=getColor(user.id);
    const ps=await db.collection('predictions').where('userId','==',user.id).limit(30).get();
    html+=`<div class="card" style="border-left:3px solid ${color};margin-bottom:10px;">
      <div style="display:flex;justify-content:space-between;margin-bottom:12px;">
        <strong style="color:${color};">ğŸ‘¤ ${user.username}</strong>
        <span style="background:${color};color:white;padding:3px 10px;border-radius:6px;font-size:0.82em;font-weight:700;">${user.points||0} pts</span>
      </div>`;
    if (ps.empty) { html+=`<p style="color:var(--muted);font-size:0.85em;">Sin predicciones</p>`; }
    else {
      ps.docs.map(d=>({id:d.id,...d.data()})).forEach(p=>{
        const m=allMatches.find(x=>x.id===p.matchId);
        html+=`<div class="pred-item" style="border-color:${color}30;">
          <div class="pred-match">${p.homeFlag} ${p.home} <span style="color:var(--muted);">vs</span> ${p.away} ${p.awayFlag}</div>
          <div class="pred-score" style="color:${color};">${p.predictedHomeScore}â€“${p.predictedAwayScore}</div>
          ${m&&m.homeScore!=null?`<div style="font-size:0.8em;text-align:center;color:var(--green);">Real<br><strong>${m.homeScore}â€“${m.awayScore}</strong></div>`:''}
        </div>`;
      });
    }
    html+=`</div>`;
  }
  el.innerHTML = html || `<div class="empty"><span class="icon">ğŸ”</span>Sin resultados</div>`;
  el.scrollIntoView({behavior:'smooth'});
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RANKING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadRanking() {
  const el = $('rankingList');
  el.innerHTML = `<div class="empty"><span class="icon">â³</span>Cargando...</div>`;
  try {
    const snap = await db.collection('users').orderBy('points','desc').limit(50).get();
    if (snap.empty) { el.innerHTML=`<div class="empty"><span class="icon">ğŸ“­</span>Sin jugadores aÃºn</div>`; return; }
    el.innerHTML='';
    snap.docs.forEach((doc,i)=>{
      const u=doc.data(); const isMe=doc.id===me.uid;
      const medal=i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':`#${i+1}`;
      const div=document.createElement('div');
      div.className='rank-row'+(isMe?' me':'');
      div.innerHTML=`
        <div class="rank-pos" style="color:${i<3?'var(--yellow)':'var(--muted)'};">${medal}</div>
        <div class="rank-name">${u.username}${isMe?' <span style="font-size:0.75em;color:var(--yellow);">(TÃš)</span>':''}</div>
        <div class="rank-exact" title="Exactos">${u.exactPredictions||0} â­</div>
        <div class="rank-pts">${u.points||0}</div>`;
      el.appendChild(div);
    });
  } catch(e) { el.innerHTML=`<div class="empty"><span class="icon">âŒ</span>${e.message}</div>`; }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CHAT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadChat() {
  const box = $('chatBox');
  try {
    const snap = await db.collection('chat').orderBy('timestamp','desc').limit(60).get();
    box.innerHTML='';
    const msgs=[]; snap.forEach(d=>msgs.unshift(d.data()));
    if (!msgs.length) { box.innerHTML=`<div class="empty" style="padding:20px;"><span class="icon" style="font-size:2em;">ğŸ’¬</span>Sin mensajes aÃºn</div>`; return; }
    msgs.forEach(msg=>{
      const isOwn=msg.userId===me.uid;
      const color=msg.userColor||getColor(msg.userId);
      const div=document.createElement('div');
      div.className=`msg ${isOwn?'own':'other'}`;
      div.innerHTML=`${!isOwn?`<div class="msg-user" style="color:${color};">${msg.username}</div>`:''}
        <div class="msg-bubble">${msg.message}</div>`;
      box.appendChild(div);
    });
    box.scrollTop=box.scrollHeight;
  } catch(e) { console.error(e); }
}

async function sendMsg() {
  const input=$('chatInput'); const msg=input.value.trim();
  if (!msg) return;
  try {
    await db.collection('chat').add({
      userId:me.uid, username:me.username, message:msg,
      userColor:getColor(me.uid),
      timestamp:firebase.firestore.FieldValue.serverTimestamp()
    });
    input.value='';
    await loadChat();
  } catch(e) { toast('âŒ Error enviando','error'); }
}

async function clearChat() {
  if (!me.isAdmin||!confirm('Â¿Limpiar todo el chat?')) return;
  const snap=await db.collection('chat').get();
  const b=db.batch(); snap.docs.forEach(d=>b.delete(d.ref)); await b.commit();
  await loadChat(); toast('âœ… Chat limpiado','success');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TOURNAMENTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTournaments() {
  const el=$('tournamentsList'); el.innerHTML='';
  TOURNAMENTS.forEach(t=>{
    const sel=myTournaments.includes(t.id);
    const div=document.createElement('div');
    div.className='group-card';
    div.style.borderColor=sel?'var(--accent)':'var(--border)';
    div.style.cursor='pointer';
    div.onclick=()=>{
      const idx=myTournaments.indexOf(t.id);
      if(idx>-1) myTournaments.splice(idx,1); else myTournaments.push(t.id);
      renderTournaments();
    };
    div.innerHTML=`<div style="display:flex;align-items:center;gap:12px;">
      <div style="width:20px;height:20px;border-radius:4px;background:${sel?'var(--accent)':'var(--border)'};display:flex;align-items:center;justify-content:center;font-size:0.75em;">${sel?'âœ“':''}</div>
      <span style="font-weight:700;">${t.name}</span>
    </div>`;
    el.appendChild(div);
  });
}

async function saveTournaments() {
  try {
    await db.collection('users').doc(me.uid).update({tournaments:myTournaments});
    toast(`âœ… ${myTournaments.length} torneos guardados`,'success');
    await syncAPI();
  } catch(e) { toast('âŒ Error','error'); }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// GROUPS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadGroups() {
  const el=$('groupsList');
  el.innerHTML=`<div class="empty"><span class="icon">â³</span>Cargando...</div>`;
  try {
    const snap=await db.collection('groups').get();
    el.innerHTML='';
    let found=0;
    snap.forEach(doc=>{
      const g=doc.data();
      if (!g.members?.some(m=>m.userId===me.uid)) return;
      found++;
      const isAdmin=g.members.find(m=>m.userId===me.uid)?.isAdmin;
      const div=document.createElement('div');
      div.className='group-card';
      div.innerHTML=`
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <strong style="font-size:1.05em;">${g.name}</strong>
          ${isAdmin?`<span class="badge badge-admin">ğŸ‘‘ Admin</span>`:''}
        </div>
        <p style="font-size:0.82em;color:var(--muted);margin-bottom:10px;">ğŸ” CÃ³digo: <strong style="color:var(--accent2);">${g.code}</strong> Â· ğŸ‘¥ ${g.members.length}/${g.maxMembers}</p>
        <button class="btn btn-purple" style="font-size:0.82em;padding:10px;" onclick="viewGroup('${doc.id}')">ğŸ† Ver ClasificaciÃ³n</button>`;
      el.appendChild(div);
    });
    if (!found) el.innerHTML=`<div class="empty"><span class="icon">ğŸ‘¥</span>No perteneces a ningÃºn grupo aÃºn</div>`;
  } catch(e) { el.innerHTML=`<div class="empty"><span class="icon">âŒ</span>${e.message}</div>`; }
}

async function viewGroup(gid) {
  const gdoc=await db.collection('groups').doc(gid).get();
  const g=gdoc.data();
  const ids=g.members.map(m=>m.userId);
  const usnap=await db.collection('users').where(firebase.firestore.FieldPath.documentId(),'in',ids).get();
  const users=usnap.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(b.points||0)-(a.points||0));

  $('grpRankTitle').textContent=`ğŸ† ${g.name}`;
  $('grpRankCode').textContent=g.code;
  const el=$('grpRankList'); el.innerHTML='';
  users.forEach((u,i)=>{
    const isMe=u.id===me.uid;
    const medal=i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':`#${i+1}`;
    const div=document.createElement('div');
    div.className='rank-row'+(isMe?' me':'');
    div.innerHTML=`
      <div class="rank-pos">${medal}</div>
      <div class="rank-name">${u.username}${isMe?' (TÃš)':''}</div>
      <div class="rank-exact">${u.exactPredictions||0} â­</div>
      <div class="rank-pts">${u.points||0}</div>`;
    el.appendChild(div);
  });
  openModal('grpRankModal');
}

async function createGroup() {
  const name=$('grpName').value.trim(), max=$('grpMax').value;
  if (!name) { toast('âŒ Nombre requerido','error'); return; }
  const code=randCode(6);
  await db.collection('groups').add({
    name, code, maxMembers:+max,
    createdBy:me.uid, createdAt:new Date().toISOString(),
    members:[{userId:me.uid,username:me.username,joinedAt:new Date().toISOString(),isAdmin:true}]
  });
  closeModal('createGrpModal');
  alert(`ğŸ‰ Grupo creado!\n\nNombre: ${name}\nğŸ” CÃ³digo: ${code}\n\nComparte el cÃ³digo con tus amigos.`);
  loadGroups();
}

async function joinGroup() {
  const code=$('grpCode').value.trim().toUpperCase();
  if (code.length!==6) { toast('âŒ CÃ³digo de 6 caracteres','error'); return; }
  const snap=await db.collection('groups').where('code','==',code).limit(1).get();
  if (snap.empty) { toast('âŒ Grupo no encontrado','error'); return; }
  const gdoc=snap.docs[0]; const g=gdoc.data();
  if (g.members.some(m=>m.userId===me.uid)) { toast('âš ï¸ Ya eres miembro','warning'); return; }
  await gdoc.ref.update({members:firebase.firestore.FieldValue.arrayUnion({userId:me.uid,username:me.username,joinedAt:new Date().toISOString(),isAdmin:false})});
  closeModal('joinGrpModal');
  toast('âœ… Â¡Unido al grupo!','success');
  loadGroups();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// POINTS CONFIG
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPtsCfg() {
  try {
    const doc=await db.collection('system').doc('pointsConfig').get();
    if (doc.exists) ptsCfg={...ptsCfg,...doc.data()};
  } catch(e) { /* usa defaults */ }
}

function adminPoints() {
  const es=$('ptExact'), rs=$('ptResult');
  es.innerHTML=''; rs.innerHTML='';
  for(let i=2;i<=10;i++){const o=document.createElement('option');o.value=i;o.textContent=`${i} pts`;if(i===ptsCfg.exactScore)o.selected=true;es.appendChild(o);}
  for(let i=1;i<=9;i++){const o=document.createElement('option');o.value=i;o.textContent=`${i} pts`;if(i===ptsCfg.correctResult)o.selected=true;rs.appendChild(o);}
  openModal('pointsModal');
}

async function savePoints() {
  ptsCfg={exactScore:+$('ptExact').value, correctResult:+$('ptResult').value};
  await db.collection('system').doc('pointsConfig').set(ptsCfg);
  toast('âœ… Puntos guardados','success');
  closeModal('pointsModal');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ADMIN FUNCTIONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function adminUsers() {
  const el=$('adminContent');
  el.innerHTML=`<div class="empty"><span class="icon">â³</span>Cargando...</div>`;
  const snap=await db.collection('users').orderBy('points','desc').get();
  let html=`<p style="font-weight:700;margin-bottom:10px;font-size:0.88em;">ğŸ‘¥ ${snap.size} usuarios registrados</p>`;
  snap.docs.forEach(doc=>{
    const u=doc.data();
    html+=`<div class="rank-row" style="margin-bottom:6px;">
      <div style="font-size:1em;">ğŸ‘¤</div>
      <div><div style="font-weight:700;font-size:0.88em;">${u.username} ${u.isAdmin?'ğŸ‘‘':''}</div>
        <div style="font-size:0.72em;color:var(--muted);">${u.email} Â· Inv: ${u.personalInviteCode}</div></div>
      <div style="font-size:0.8em;color:var(--muted);">${u.exactPredictions||0}â­</div>
      <div class="rank-pts">${u.points||0}</div>
    </div>`;
  });
  el.innerHTML=html;
}

async function adminEval() {
  if (!confirm('Â¿Evaluar todos los partidos finalizados?')) return;
  alert_('â³ Evaluando...','info');
  const fin=allMatches.filter(m=>m.status==='Match Finished'&&m.homeScore!=null);
  if (!fin.length) { alert_('âš ï¸ Sin partidos finalizados','warning'); return; }
  let total=0, pts=0;
  for (const match of fin) {
    const psnap=await db.collection('predictions').where('matchId','==',match.id).where('evaluated','==',false).get();
    for (const pd of psnap.docs) {
      const p=pd.data(); let points=0;
      if (p.predictedHomeScore===match.homeScore&&p.predictedAwayScore===match.awayScore) {
        points=ptsCfg.exactScore;
        await db.collection('users').doc(p.userId).update({exactPredictions:firebase.firestore.FieldValue.increment(1)});
      } else if (Math.sign(p.predictedHomeScore-p.predictedAwayScore)===Math.sign(match.homeScore-match.awayScore)) {
        points=ptsCfg.correctResult;
      }
      if (points>0) { await db.collection('users').doc(p.userId).update({points:firebase.firestore.FieldValue.increment(points)}); pts+=points; }
      await pd.ref.update({evaluated:true,pointsAwarded:points}); total++;
    }
  }
  alert_(`âœ… ${total} evaluadas Â· ${pts} puntos distribuidos`,'success');
  loadRanking();
}

async function adminReset() {
  const opt=confirm('MODO A: Solo predicciones (OK)\nMODO B: Todo (Cancelar)');
  if (opt===null) return;
  if (opt) { // Modo A
    if (!confirm('Â¿Borrar predicciones y resetear puntos?')) return;
    const ps=await db.collection('predictions').get();
    const b=db.batch(); ps.docs.forEach(d=>b.delete(d.ref)); await b.commit();
    const us=await db.collection('users').get();
    const b2=db.batch(); us.docs.forEach(d=>b2.update(d.ref,{points:0,exactPredictions:0,correctResults:0})); await b2.commit();
    toast('âœ… Predicciones borradas','success');
  } else { // Modo B
    const code=prompt('Escribe BORRAR-TODO para confirmar eliminaciÃ³n completa:');
    if (code!=='BORRAR-TODO') { toast('âŒ Cancelado','error'); return; }
    for (const col of ['users','predictions','groups','chat']) {
      const s=await db.collection(col).get();
      const b=db.batch(); s.docs.forEach(d=>b.delete(d.ref)); await b.commit();
    }
    toast('âœ… Base de datos limpiada','success');
    doLogout();
  }
}

// Online/offline
window.addEventListener('online',  ()=>toast('âœ… ConexiÃ³n restaurada','success'));
window.addEventListener('offline', ()=>toast('âš ï¸ Sin conexiÃ³n','warning'));

console.log('%câš½ QUINIELA LUAN V2 â€” REESCRITURA COMPLETA','color:#a855f7;font-size:16px;font-weight:bold;');
</script>
</body>
</html>
