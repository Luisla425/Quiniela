<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0d0d14">
<title>âš½ Quiniela Luan</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOKENS & RESET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg:       #0d0d14;
  --surface:  #13131f;
  --surface2: #1a1a2e;
  --border:   rgba(255,255,255,0.07);
  --border2:  rgba(255,255,255,0.12);
  --primary:  #6c47ff;
  --primary2: #9d7dff;
  --gold:     #f5c542;
  --green:    #00e5a0;
  --red:      #ff4d6d;
  --orange:   #ff8c42;
  --blue:     #3b9eff;
  --text:     #f0eeff;
  --muted:    #5e5e8a;
  --muted2:   #8888aa;
  --font-h:   'Syne', sans-serif;
  --font-b:   'DM Sans', sans-serif;
  --r:        14px;
  --r-sm:     10px;
  --shadow:   0 8px 32px rgba(0,0,0,0.5);
}
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html { scroll-behavior: smooth; }
body {
  font-family: var(--font-b);
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}
.hidden { display:none !important; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BACKGROUND GLOW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
body::before {
  content:'';
  position:fixed; inset:0; z-index:0; pointer-events:none;
  background:
    radial-gradient(ellipse 60% 40% at 20% 10%, rgba(108,71,255,0.15) 0%, transparent 60%),
    radial-gradient(ellipse 40% 30% at 80% 80%, rgba(61,158,255,0.10) 0%, transparent 60%);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#app { position:relative; z-index:1; max-width:500px; margin:0 auto; min-height:100vh; display:flex; flex-direction:column; }
.screen { flex:1; display:flex; flex-direction:column; padding:16px; padding-bottom:90px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH SCREENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#authScreen {
  min-height:100vh; display:flex; flex-direction:column;
  justify-content:center; padding:24px; gap:0;
}
.auth-logo {
  text-align:center; margin-bottom:40px;
}
.auth-logo-icon {
  font-size:3.5em; display:block; margin-bottom:8px;
  filter: drop-shadow(0 0 20px rgba(108,71,255,0.6));
}
.auth-logo h1 {
  font-family:var(--font-h); font-size:2.4em; font-weight:800;
  background: linear-gradient(135deg, var(--primary2), var(--blue));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  letter-spacing:2px;
}
.auth-logo p { color:var(--muted2); font-size:0.88em; margin-top:4px; }

.auth-tabs {
  display:flex; background:var(--surface); border-radius:var(--r);
  padding:4px; margin-bottom:24px; border:1px solid var(--border);
}
.auth-tab {
  flex:1; padding:10px; text-align:center; border-radius:10px;
  font-weight:700; font-size:0.85em; cursor:pointer; transition:all 0.2s;
  color:var(--muted2); text-transform:uppercase; letter-spacing:1px;
}
.auth-tab.active {
  background:var(--primary); color:#fff;
  box-shadow:0 4px 16px rgba(108,71,255,0.4);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORM ELEMENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.field { margin-bottom:14px; }
.field label {
  display:block; font-size:0.72em; font-weight:700;
  color:var(--muted2); text-transform:uppercase; letter-spacing:1.5px; margin-bottom:6px;
}
.field input, .field select, .field textarea {
  width:100%; padding:13px 16px;
  background:var(--surface2); border:1px solid var(--border2);
  border-radius:var(--r-sm); color:var(--text);
  font-family:var(--font-b); font-size:0.95em; font-weight:500;
  transition:border-color 0.2s, box-shadow 0.2s;
}
.field input:focus, .field select:focus, .field textarea:focus {
  outline:none; border-color:var(--primary);
  box-shadow:0 0 0 3px rgba(108,71,255,0.2);
}
.field select { cursor:pointer; }
.field textarea { resize:none; min-height:80px; }

.phone-row { display:flex; gap:8px; }
.country-btn {
  padding:13px 12px; background:var(--surface2); border:1px solid var(--border2);
  border-radius:var(--r-sm); color:var(--text); font-family:var(--font-b);
  font-weight:700; font-size:0.88em; cursor:pointer; white-space:nowrap;
  min-width:96px; transition:border-color 0.2s;
}
.country-btn:hover { border-color:var(--primary); }
.country-dropdown {
  position:absolute; z-index:9999; background:var(--surface);
  border:1px solid var(--border2); border-radius:var(--r);
  width:280px; max-height:300px; overflow-y:auto;
  box-shadow:var(--shadow); margin-top:4px;
}
.country-search {
  width:100%; padding:12px 16px; background:var(--surface2);
  border:none; border-bottom:1px solid var(--border); color:var(--text);
  font-family:var(--font-b); font-weight:600;
}
.country-search:focus { outline:none; }
.country-option {
  padding:10px 16px; cursor:pointer; font-size:0.88em;
  font-weight:600; display:flex; align-items:center; gap:10px;
  transition:background 0.15s;
}
.country-option:hover { background:var(--surface2); }
.country-option .dial { color:var(--primary2); font-weight:800; min-width:44px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUTTONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn {
  display:block; width:100%; padding:14px 20px;
  border:none; border-radius:var(--r-sm);
  font-family:var(--font-b); font-weight:700; font-size:0.92em;
  cursor:pointer; transition:all 0.2s; text-transform:uppercase;
  letter-spacing:1px; text-align:center;
}
.btn:disabled { opacity:0.4; cursor:not-allowed; transform:none !important; }
.btn:active { transform:scale(0.98); }
.btn-primary {
  background:linear-gradient(135deg, var(--primary), var(--primary2));
  color:#fff; box-shadow:0 4px 20px rgba(108,71,255,0.4);
}
.btn-primary:hover { box-shadow:0 6px 28px rgba(108,71,255,0.6); transform:translateY(-1px); }
.btn-green { background:linear-gradient(135deg,#00b37a,var(--green)); color:#000; }
.btn-red { background:linear-gradient(135deg,#cc2244,var(--red)); color:#fff; }
.btn-ghost {
  background:transparent; color:var(--muted2);
  border:1px solid var(--border2);
}
.btn-ghost:hover { border-color:var(--primary2); color:var(--primary2); }
.btn-sm { width:auto; display:inline-block; padding:8px 14px; font-size:0.78em; }
.btn-wa {
  background:rgba(37,211,102,0.15); border:1px solid #25d366;
  color:#25d366; border-radius:var(--r-sm);
  font-family:var(--font-b); font-weight:700; font-size:0.8em;
  padding:9px 14px; cursor:pointer; transition:all 0.2s;
}
.btn-wa:hover { background:rgba(37,211,102,0.25); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.header {
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 16px; position:sticky; top:0; z-index:100;
  background:rgba(13,13,20,0.85); backdrop-filter:blur(16px);
  border-bottom:1px solid var(--border);
}
.header-left { display:flex; flex-direction:column; gap:2px; }
.header-greeting {
  font-size:0.68em; color:var(--muted2); font-weight:600; text-transform:uppercase; letter-spacing:1px;
}
.header-name {
  font-family:var(--font-h); font-size:1.1em; font-weight:800;
  color:var(--text); display:flex; align-items:center; gap:6px;
}
.header-badge {
  font-size:0.65em; background:var(--primary); color:#fff;
  padding:2px 7px; border-radius:20px; font-family:var(--font-b); font-weight:700;
}
.header-info { display:flex; flex-direction:column; align-items:flex-end; gap:2px; }
.header-clock { font-family:var(--font-h); font-size:0.95em; color:var(--primary2); }
.header-inv { font-size:0.68em; color:var(--muted); }
.header-logout {
  background:none; border:none; color:var(--muted); cursor:pointer;
  font-size:1.2em; padding:6px; border-radius:8px; transition:color 0.2s;
}
.header-logout:hover { color:var(--red); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTTOM NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.nav {
  position:fixed; bottom:0; left:50%; transform:translateX(-50%);
  width:100%; max-width:500px; z-index:200;
  background:rgba(13,13,20,0.92); backdrop-filter:blur(20px);
  border-top:1px solid var(--border);
  display:flex; align-items:center;
  padding:6px 4px env(safe-area-inset-bottom, 6px);
}
.nav-item {
  flex:1; display:flex; flex-direction:column; align-items:center;
  gap:3px; padding:6px 2px; cursor:pointer; border-radius:10px;
  transition:all 0.2s; color:var(--muted); border:none; background:none;
}
.nav-item .nav-icon { font-size:1.3em; transition:transform 0.2s; }
.nav-item .nav-label { font-size:0.6em; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; }
.nav-item.active { color:var(--primary2); }
.nav-item.active .nav-icon { transform:scale(1.15); }
.nav-item:hover { color:var(--primary2); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#toastContainer {
  position:fixed; top:70px; left:50%; transform:translateX(-50%);
  z-index:9000; display:flex; flex-direction:column; gap:8px;
  align-items:center; width:90%; max-width:440px; pointer-events:none;
}
.toast {
  padding:12px 18px; border-radius:var(--r-sm); font-weight:700;
  font-size:0.85em; box-shadow:var(--shadow); pointer-events:auto;
  animation:slideDown 0.3s ease; border-left:3px solid;
  background:var(--surface); max-width:100%;
}
@keyframes slideDown { from{opacity:0;transform:translateY(-12px)} to{opacity:1;transform:translateY(0)} }
.toast-success { border-color:var(--green); color:var(--green); }
.toast-error   { border-color:var(--red); color:var(--red); }
.toast-info    { border-color:var(--blue); color:var(--blue); }
.toast-warning { border-color:var(--orange); color:var(--orange); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay {
  position:fixed; inset:0; z-index:5000;
  background:rgba(0,0,0,0.7); backdrop-filter:blur(4px);
  display:flex; align-items:flex-end; justify-content:center;
}
.modal-box {
  background:var(--surface); border-radius:24px 24px 0 0;
  width:100%; max-width:500px; padding:24px;
  max-height:90vh; overflow-y:auto;
  border-top:1px solid var(--border2);
  animation:slideUp 0.3s ease;
}
@keyframes slideUp { from{transform:translateY(60px);opacity:0} to{transform:translateY(0);opacity:1} }
.modal-handle {
  width:40px; height:4px; background:var(--border2);
  border-radius:2px; margin:0 auto 20px;
}
.modal-title {
  font-family:var(--font-h); font-size:1.4em; font-weight:800;
  margin-bottom:16px; color:var(--text);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card {
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--r); padding:16px; margin-bottom:10px;
}
.card-glow {
  background:linear-gradient(135deg,rgba(108,71,255,0.12),rgba(61,158,255,0.06));
  border:1px solid rgba(108,71,255,0.3);
  border-radius:var(--r); padding:16px; margin-bottom:10px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MATCH CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.match-card {
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--r); padding:14px; margin-bottom:10px;
  transition:border-color 0.2s;
}
.match-card.live {
  border-color:rgba(255,77,109,0.5);
  background:linear-gradient(135deg,rgba(255,77,109,0.06),var(--surface));
}
.match-card.finished {
  border-color:rgba(0,229,160,0.3);
  background:linear-gradient(135deg,rgba(0,229,160,0.04),var(--surface));
}
.match-meta {
  display:flex; justify-content:space-between; align-items:center;
  margin-bottom:10px; font-size:0.7em; font-weight:700;
  color:var(--muted); text-transform:uppercase; letter-spacing:0.8px;
}
.badge-live {
  background:rgba(255,77,109,0.2); color:var(--red);
  padding:3px 10px; border-radius:20px; border:1px solid rgba(255,77,109,0.3);
  font-size:0.85em; animation:pulse 2s infinite;
}
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.6} }
.badge-done { background:rgba(0,229,160,0.15); color:var(--green); padding:3px 10px; border-radius:20px; }
.badge-time { color:var(--primary2); font-family:var(--font-h); font-size:1em; }

.match-teams {
  display:grid; grid-template-columns:1fr auto 1fr;
  align-items:center; gap:8px; margin-bottom:10px;
}
.team { text-align:center; }
.team-flag { font-size:2em; display:block; margin-bottom:4px; }
.team-name { font-size:0.68em; font-weight:700; color:var(--muted2); text-transform:uppercase; letter-spacing:0.5px; }
.team-score { font-family:var(--font-h); font-size:2.2em; font-weight:800; }
.score-live { color:var(--red); }
.score-final { color:var(--green); }
.vs-divider { font-family:var(--font-h); font-size:1.4em; color:var(--muted); text-align:center; }

/* PREDICTION INPUTS */
.pred-row { display:flex; align-items:center; justify-content:center; gap:12px; }
.pred-input {
  width:56px; height:56px; text-align:center;
  background:var(--surface2); border:2px solid var(--border2);
  border-radius:12px; color:var(--text);
  font-family:var(--font-h); font-size:1.6em; font-weight:800;
  transition:border-color 0.2s, box-shadow 0.2s;
}
.pred-input:focus {
  outline:none; border-color:var(--primary);
  box-shadow:0 0 0 3px rgba(108,71,255,0.2);
}
.pred-dash { font-family:var(--font-h); font-size:1.4em; color:var(--muted); }

/* GOAL DETAILS */
.goal-list { margin-top:8px; padding-top:8px; border-top:1px solid var(--border); }
.goal-item {
  display:flex; align-items:center; gap:6px;
  font-size:0.75em; color:var(--muted2); padding:3px 0; font-weight:600;
}
.goal-home { color:var(--text); }
.goal-away { color:var(--blue); }

/* STATS BTN */
.stats-btn {
  width:100%; padding:9px; margin-top:8px;
  background:rgba(108,71,255,0.15); border:1px solid rgba(108,71,255,0.3);
  border-radius:var(--r-sm); color:var(--primary2);
  font-family:var(--font-b); font-weight:700; font-size:0.78em;
  cursor:pointer; transition:all 0.2s; text-transform:uppercase; letter-spacing:1px;
}
.stats-btn:hover { background:rgba(108,71,255,0.25); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RANKING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.rank-row {
  display:flex; align-items:center; gap:12px;
  padding:12px; border-radius:var(--r-sm); margin-bottom:6px;
  background:var(--surface2); border:1px solid var(--border);
  transition:border-color 0.2s;
}
.rank-row.me { border-color:var(--primary); background:rgba(108,71,255,0.1); }
.rank-row:first-child { border-color:var(--gold); background:rgba(245,197,66,0.07); }
.rank-pos { font-family:var(--font-h); font-size:1.2em; min-width:32px; text-align:center; }
.rank-name { flex:1; font-weight:700; font-size:0.9em; }
.rank-sub { font-size:0.7em; color:var(--muted2); font-weight:500; margin-top:2px; }
.rank-pts { font-family:var(--font-h); font-size:1.4em; color:var(--primary2); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PREDICTIONS SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.pred-item {
  display:grid; grid-template-columns:1fr auto auto auto;
  align-items:center; gap:10px;
  padding:12px; border-radius:var(--r-sm); margin-bottom:6px;
  background:var(--surface2); border:1px solid var(--border);
}
.pred-match-name { font-weight:700; font-size:0.82em; }
.pred-match-sub { font-size:0.7em; color:var(--muted2); }
.pred-score-box {
  font-family:var(--font-h); font-size:1.2em; font-weight:800;
  background:rgba(108,71,255,0.15); padding:4px 10px;
  border-radius:8px; color:var(--primary2);
}
.pred-real-box { font-size:0.75em; text-align:center; color:var(--muted2); }
.pred-real-score { font-family:var(--font-h); font-size:1.1em; color:var(--green); display:block; }
.pred-pts-box {
  font-weight:800; font-size:0.85em; padding:4px 10px;
  border-radius:8px; text-align:center;
}
.pts-5 { background:rgba(0,229,160,0.2); color:var(--green); }
.pts-3 { background:rgba(59,158,255,0.2); color:var(--blue); }
.pts-0 { background:rgba(255,77,109,0.15); color:var(--red); }
.pts-pending { background:rgba(245,197,66,0.15); color:var(--gold); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#chatScreen { padding:0; padding-bottom:0; }
.chat-header {
  padding:16px; border-bottom:1px solid var(--border);
  display:flex; align-items:center; gap:12px;
  background:rgba(13,13,20,0.9); backdrop-filter:blur(16px);
  position:sticky; top:0; z-index:10;
}
.chat-header-info h3 { font-family:var(--font-h); font-size:1.1em; }
.chat-header-info p { font-size:0.72em; color:var(--muted2); }
.chat-online { width:8px; height:8px; border-radius:50%; background:var(--green); animation:pulse 2s infinite; }
.chat-messages {
  flex:1; overflow-y:auto; padding:16px;
  display:flex; flex-direction:column; gap:8px;
  min-height:0; padding-bottom:80px;
}
.chat-msg { max-width:80%; display:flex; flex-direction:column; gap:3px; }
.chat-msg.mine { align-self:flex-end; align-items:flex-end; }
.chat-msg.theirs { align-self:flex-start; align-items:flex-start; }
.chat-bubble {
  padding:10px 14px; border-radius:18px;
  font-size:0.88em; font-weight:500; line-height:1.5;
  position:relative; word-break:break-word;
}
.chat-msg.mine .chat-bubble {
  background:linear-gradient(135deg,var(--primary),var(--primary2));
  color:#fff; border-bottom-right-radius:4px;
}
.chat-msg.theirs .chat-bubble {
  background:var(--surface2); color:var(--text);
  border:1px solid var(--border2); border-bottom-left-radius:4px;
}
.chat-name { font-size:0.68em; font-weight:700; color:var(--primary2); margin-bottom:2px; padding-left:4px; }
.chat-time { font-size:0.65em; color:var(--muted); padding:0 4px; }
.chat-input-bar {
  position:fixed; bottom:0; left:50%; transform:translateX(-50%);
  width:100%; max-width:500px; padding:10px 16px;
  padding-bottom:env(safe-area-inset-bottom, 10px);
  background:rgba(13,13,20,0.95); backdrop-filter:blur(20px);
  border-top:1px solid var(--border);
  display:flex; gap:8px; align-items:flex-end; z-index:200;
}
.chat-input {
  flex:1; padding:11px 16px; background:var(--surface2);
  border:1px solid var(--border2); border-radius:22px;
  color:var(--text); font-family:var(--font-b); font-size:0.9em;
  resize:none; max-height:100px; font-weight:500;
}
.chat-input:focus { outline:none; border-color:var(--primary); }
.chat-send {
  width:42px; height:42px; border-radius:50%;
  background:linear-gradient(135deg,var(--primary),var(--primary2));
  border:none; color:#fff; font-size:1.1em; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  flex-shrink:0; transition:transform 0.2s, box-shadow 0.2s;
}
.chat-send:hover { transform:scale(1.08); box-shadow:0 4px 16px rgba(108,71,255,0.5); }
.chat-system {
  text-align:center; font-size:0.72em; color:var(--muted);
  padding:4px 12px; background:var(--surface2); border-radius:20px;
  align-self:center; font-weight:600;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOURNAMENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tourn-item {
  display:flex; align-items:center; justify-content:space-between;
  padding:14px 16px; border-radius:var(--r-sm); margin-bottom:8px;
  background:var(--surface2); border:1px solid var(--border);
  cursor:pointer; transition:all 0.2s;
}
.tourn-item.selected { border-color:var(--primary); background:rgba(108,71,255,0.1); }
.tourn-item:hover { border-color:var(--border2); }
.tourn-left { display:flex; align-items:center; gap:12px; font-weight:700; font-size:0.9em; }
.tourn-check {
  width:22px; height:22px; border-radius:6px; border:2px solid var(--border2);
  display:flex; align-items:center; justify-content:center;
  font-size:0.8em; transition:all 0.2s;
}
.tourn-item.selected .tourn-check { background:var(--primary); border-color:var(--primary); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GROUPS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.group-card {
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--r); padding:16px; margin-bottom:10px;
}
.group-card-header {
  display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:10px;
}
.group-name { font-family:var(--font-h); font-size:1.1em; font-weight:800; }
.group-code {
  background:var(--surface2); border:1px solid var(--border2);
  border-radius:8px; padding:4px 10px; text-align:center;
}
.group-code-label { font-size:0.6em; color:var(--muted); font-weight:700; text-transform:uppercase; letter-spacing:1px; display:block; }
.group-code-val { font-family:var(--font-h); font-size:1.2em; color:var(--primary2); letter-spacing:3px; }
.group-meta { font-size:0.75em; color:var(--muted2); margin-bottom:12px; }
.group-actions { display:flex; gap:8px; }
.btn-del {
  padding:8px 12px; background:rgba(255,77,109,0.15); border:1px solid rgba(255,77,109,0.3);
  color:var(--red); border-radius:var(--r-sm); font-family:var(--font-b);
  font-weight:700; font-size:0.75em; cursor:pointer; transition:all 0.2s;
}
.btn-del:hover { background:rgba(255,77,109,0.25); }
.btn-rank {
  flex:1; padding:9px; background:rgba(108,71,255,0.15); border:1px solid rgba(108,71,255,0.3);
  color:var(--primary2); border-radius:var(--r-sm); font-family:var(--font-b);
  font-weight:700; font-size:0.78em; cursor:pointer; transition:all 0.2s; text-align:center;
}
.btn-rank:hover { background:rgba(108,71,255,0.25); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADMIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.admin-grid {
  display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:16px;
}
.admin-btn {
  padding:16px 12px; background:var(--surface2);
  border:1px solid var(--border2); border-radius:var(--r-sm);
  color:var(--text); font-family:var(--font-b); font-weight:700;
  font-size:0.82em; cursor:pointer; transition:all 0.2s;
  text-align:center; line-height:1.4;
}
.admin-btn:hover { border-color:var(--primary2); color:var(--primary2); background:rgba(108,71,255,0.08); }
.admin-btn.full { grid-column:span 2; }
.admin-btn.accent { border-color:var(--primary2); color:var(--primary2); }
.admin-btn.warn { border-color:var(--orange); color:var(--orange); }
.admin-btn.danger { border-color:var(--red); color:var(--red); }
.admin-output {
  background:var(--surface2); border:1px solid var(--border);
  border-radius:var(--r); padding:14px; min-height:60px;
  font-size:0.85em;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COUNTDOWN BANNER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.countdown-banner {
  background:rgba(245,197,66,0.12); border:1px solid rgba(245,197,66,0.3);
  border-radius:var(--r-sm); padding:10px 14px; margin-bottom:12px;
  display:flex; justify-content:space-between; align-items:center;
  font-size:0.8em;
}
.countdown-label { color:var(--gold); font-weight:700; }
.countdown-match { color:var(--muted2); }
.countdown-status { color:var(--red); font-weight:800; font-size:0.9em; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTION HEADERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.section-header {
  display:flex; justify-content:space-between; align-items:center;
  margin-bottom:14px; padding-bottom:10px; border-bottom:1px solid var(--border);
}
.section-title { font-family:var(--font-h); font-size:1.2em; font-weight:800; }
.section-sub { font-size:0.75em; color:var(--muted2); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   JOIN GROUP MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.code-input {
  font-family:var(--font-h); font-size:2em; font-weight:800;
  text-align:center; letter-spacing:8px; text-transform:uppercase;
  padding:16px; background:var(--surface2); border:2px solid var(--border2);
  border-radius:var(--r-sm); color:var(--primary2); width:100%;
  transition:border-color 0.2s;
}
.code-input:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(108,71,255,0.2); }
.join-status { min-height:44px; margin:10px 0; }
.status-box {
  padding:10px 14px; border-radius:var(--r-sm);
  font-weight:700; font-size:0.85em; border-left:3px solid;
}
.status-success { background:rgba(0,229,160,0.1); border-color:var(--green); color:var(--green); }
.status-error { background:rgba(255,77,109,0.1); border-color:var(--red); color:var(--red); }
.status-info { background:rgba(59,158,255,0.1); border-color:var(--blue); color:var(--blue); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROFILE PILL (header)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.player-num {
  font-size:0.62em; color:var(--muted); font-weight:700;
  background:var(--surface2); padding:2px 7px; border-radius:10px;
  border:1px solid var(--border);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MISC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.empty {
  text-align:center; padding:40px 20px; color:var(--muted);
}
.empty-icon { font-size:2.5em; display:block; margin-bottom:10px; }
.empty-text { font-weight:600; font-size:0.9em; }
.divider { border:none; border-top:1px solid var(--border); margin:14px 0; }
.big-stat {
  text-align:center; padding:16px 0;
}
.big-stat-num { font-family:var(--font-h); font-size:3em; color:var(--primary2); display:block; }
.big-stat-label { font-size:0.78em; color:var(--muted2); font-weight:700; text-transform:uppercase; letter-spacing:1px; }

.info-row {
  display:flex; justify-content:space-between; align-items:center;
  padding:8px 0; border-bottom:1px solid var(--border); font-size:0.85em;
}
.info-row:last-child { border:none; }
.info-label { color:var(--muted2); font-weight:600; }
.info-val { font-weight:700; }

/* Search unlock */
.locked-box {
  text-align:center; padding:20px;
  background:rgba(245,197,66,0.07); border-radius:var(--r-sm);
  border:1px solid rgba(245,197,66,0.2); margin-bottom:14px;
}
.locked-box .lock-icon { font-size:2em; display:block; margin-bottom:8px; }
.locked-box p { color:var(--gold); font-weight:700; font-size:0.85em; }
.locked-box small { color:var(--muted2); font-size:0.78em; }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â• TOAST CONTAINER â•â•â•â•â•â•â•â•â•â•â• -->
<div id="toastContainer"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â• AUTH SCREEN â•â•â•â•â•â•â•â•â•â•â• -->
<div id="authScreen">
  <div class="auth-logo">
    <span class="auth-logo-icon">âš½</span>
    <h1>QUINIELA LUAN</h1>
    <p>La quiniela de los campeones</p>
  </div>

  <div class="auth-tabs">
    <div class="auth-tab active" id="tabLogin" onclick="switchAuthTab('login')">Entrar</div>
    <div class="auth-tab" id="tabReg" onclick="switchAuthTab('register')">Registrarse</div>
  </div>

  <!-- LOGIN -->
  <div id="formLogin">
    <div class="field">
      <label>TelÃ©fono</label>
      <div class="phone-row" style="position:relative;">
        <button type="button" class="country-btn" id="loginCountryBtn" onclick="openCountryPicker('login')">ğŸ‡»ğŸ‡ª +58 â–¾</button>
        <input type="tel" id="loginPhone" placeholder="4141234567" style="flex:1;" onkeydown="if(event.key==='Enter')doLogin()">
      </div>
    </div>
    <div class="field">
      <label>ContraseÃ±a</label>
      <input type="password" id="loginPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter')doLogin()">
    </div>
    <button class="btn btn-primary" onclick="doLogin()">Entrar â†’</button>
    <button class="btn btn-ghost" style="margin-top:8px;" onclick="showReset()">Â¿Olvidaste tu contraseÃ±a?</button>
  </div>

  <!-- REGISTER -->
  <div id="formRegister" class="hidden">
    <div class="field">
      <label>Nombre completo</label>
      <input type="text" id="regName" placeholder="Tu nombre">
    </div>
    <div class="field">
      <label>Apodo (mÃ¡x. 8 caracteres)</label>
      <input type="text" id="regUsername" placeholder="LUISLA" maxlength="8" style="text-transform:uppercase;" oninput="this.value=this.value.toUpperCase()">
    </div>
    <div class="field">
      <label>TelÃ©fono</label>
      <div class="phone-row" style="position:relative;">
        <button type="button" class="country-btn" id="regCountryBtn" onclick="openCountryPicker('reg')">ğŸ‡»ğŸ‡ª +58 â–¾</button>
        <input type="tel" id="regPhone" placeholder="4141234567" style="flex:1;">
      </div>
    </div>
    <div class="field">
      <label>ContraseÃ±a</label>
      <input type="password" id="regPass" placeholder="MÃ­nimo 6 caracteres">
    </div>
    <div class="field">
      <label>CÃ³digo de invitaciÃ³n (opcional)</label>
      <input type="text" id="regInvite" placeholder="ABC123" style="text-transform:uppercase;" oninput="this.value=this.value.toUpperCase()">
    </div>
    <button class="btn btn-primary" onclick="doRegister()">Crear cuenta â†’</button>
  </div>

  <!-- RESET -->
  <div id="formReset" class="hidden">
    <p style="color:var(--muted2);font-size:0.85em;margin-bottom:16px;">Ingresa tu telÃ©fono y te enviaremos un enlace para restablecer tu contraseÃ±a.</p>
    <div class="field">
      <label>TelÃ©fono</label>
      <div class="phone-row" style="position:relative;">
        <button type="button" class="country-btn" id="resetCountryBtn" onclick="openCountryPicker('reset')">ğŸ‡»ğŸ‡ª +58 â–¾</button>
        <input type="tel" id="resetPhone" placeholder="4141234567" style="flex:1;">
      </div>
    </div>
    <button class="btn btn-primary" onclick="doReset()">Enviar enlace</button>
    <button class="btn btn-ghost" style="margin-top:8px;" onclick="switchAuthTab('login')">â† Volver</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• MAIN APP â•â•â•â•â•â•â•â•â•â•â• -->
<div id="mainApp" class="hidden">

  <!-- HEADER -->
  <div class="header">
    <div class="header-left">
      <span class="header-greeting">Bienvenido</span>
      <div class="header-name">
        <span id="hdrPlayerNum" class="player-num"></span>
        <span id="hdrName">â€”</span>
        <span id="hdrAdminBadge" class="header-badge hidden">ğŸ‘‘ Admin</span>
      </div>
      <div style="font-size:0.68em;color:var(--muted);">InvitaciÃ³n: <strong id="hdrCode" style="color:var(--primary2);">â€”</strong></div>
    </div>
    <div class="header-info">
      <div class="header-clock" id="hdrClock">--:--</div>
      <div style="font-size:0.65em;color:var(--muted);">Venezuela</div>
      <div style="display:flex;gap:6px;align-items:center;">
        <button class="header-logout" onclick="openModal('changePassModal')" title="Cambiar contraseÃ±a" style="font-size:1em;">ğŸ”‘</button>
        <button class="header-logout" onclick="doLogout()" title="Salir">ğŸšª</button>
      </div>
    </div>
  </div>

  <!-- SCREENS -->
  <div id="screenMatches" class="screen"></div>
  <div id="screenPreds" class="screen hidden"></div>
  <div id="screenChat" class="screen hidden" style="padding:0;padding-bottom:0;"></div>
  <div id="screenTournaments" class="screen hidden"></div>
  <div id="screenGroups" class="screen hidden"></div>
  <div id="screenAdmin" class="screen hidden"></div>
  <div id="screenChangePass" class="screen hidden"></div>

  <!-- BOTTOM NAV -->
  <nav class="nav">
    <button class="nav-item active" id="nav-matches" onclick="showScreen('matches')">
      <span class="nav-icon">âš½</span><span class="nav-label">Partidos</span>
    </button>
    <button class="nav-item" id="nav-preds" onclick="showScreen('preds')">
      <span class="nav-icon">ğŸ¯</span><span class="nav-label">Predecir</span>
    </button>
    <button class="nav-item" id="nav-chat" onclick="showScreen('chat')">
      <span class="nav-icon">ğŸ’¬</span><span class="nav-label">Chat</span>
    </button>
    <button class="nav-item" id="nav-tournaments" onclick="showScreen('tournaments')">
      <span class="nav-icon">ğŸ†</span><span class="nav-label">Torneos</span>
    </button>
    <button class="nav-item" id="nav-groups" onclick="showScreen('groups')">
      <span class="nav-icon">ğŸ‘¥</span><span class="nav-label">Grupos</span>
    </button>
    <button class="nav-item hidden" id="nav-admin" onclick="showScreen('admin')">
      <span class="nav-icon">âš™ï¸</span><span class="nav-label">Admin</span>
    </button>
  </nav>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â•â•â•â•â• -->

<!-- Country Picker -->
<div class="modal-overlay hidden" id="countryModal" onclick="closeCountryPicker(event)">
  <div class="modal-box" onclick="e=>e.stopPropagation()">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸŒ PaÃ­s</div>
    <div class="field"><input type="text" id="countrySearch" placeholder="Buscar paÃ­s..." oninput="filterCountries(this.value)" class="field input"></div>
    <div id="countryList" style="max-height:280px;overflow-y:auto;"></div>
  </div>
</div>

<!-- Join Group -->
<div class="modal-overlay hidden" id="joinModal">
  <div class="modal-box">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ”— Unirse a Grupo</div>
    <p style="color:var(--muted2);font-size:0.85em;margin-bottom:16px;">Escribe el cÃ³digo de 6 letras que te compartiÃ³ el admin</p>
    <div class="field">
      <label>CÃ³digo del grupo</label>
      <input type="text" id="joinCode" class="code-input" maxlength="6" oninput="this.value=this.value.toUpperCase();document.getElementById('joinStatus').innerHTML=''">
    </div>
    <div class="join-status" id="joinStatus"></div>
    <button class="btn btn-primary" id="joinBtn" onclick="doJoinGroup()">âœ… Unirse al Grupo</button>
    <button class="btn btn-ghost" style="margin-top:8px;" onclick="closeModal('joinModal')">Cancelar</button>
  </div>
</div>

<!-- Create Group -->
<div class="modal-overlay hidden" id="createModal">
  <div class="modal-box">
    <div class="modal-handle"></div>
    <div class="modal-title">â• Crear Grupo</div>
    <div class="field">
      <label>Nombre del grupo</label>
      <input type="text" id="createName" placeholder="Ej: Champions Squad">
    </div>
    <div class="field">
      <label>MÃ¡ximo de jugadores</label>
      <select id="createMax">
        <option value="10">10</option>
        <option value="20">20</option>
        <option value="50" selected>50</option>
        <option value="100">100</option>
      </select>
    </div>
    <button class="btn btn-primary" id="createBtn" onclick="doCreateGroup()">ğŸ‰ Crear Grupo</button>
    <button class="btn btn-ghost" style="margin-top:8px;" onclick="closeModal('createModal')">Cancelar</button>
  </div>
</div>

<!-- Group Selector (for predictions) -->
<div class="modal-overlay hidden" id="grpPickModal">
  <div class="modal-box">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ‘¥ Â¿Para quÃ© grupo?</div>
    <p style="color:var(--muted2);font-size:0.85em;margin-bottom:16px;">EstÃ¡s en varios grupos. Elige para cuÃ¡l predices esta jornada.</p>
    <div id="grpPickList"></div>
    <button class="btn btn-ghost" style="margin-top:8px;" onclick="closeModal('grpPickModal')">Cancelar</button>
  </div>
</div>

<!-- Group Ranking -->
<div class="modal-overlay hidden" id="rankModal">
  <div class="modal-box">
    <div class="modal-handle"></div>
    <div id="rankModalTitle" class="modal-title"></div>
    <div id="rankModalCode" style="font-size:0.78em;color:var(--muted2);margin-bottom:16px;"></div>
    <div id="rankModalList"></div>
    <button class="btn btn-ghost" style="margin-top:16px;" onclick="closeModal('rankModal')">Cerrar</button>
  </div>
</div>

<!-- Change Password Modal -->
<div class="modal-overlay hidden" id="changePassModal">
  <div class="modal-box">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ”‘ Cambiar ContraseÃ±a</div>
    <div class="field">
      <label>ContraseÃ±a actual</label>
      <input type="password" id="cpOld" placeholder="Tu contraseÃ±a actual">
    </div>
    <div class="field">
      <label>Nueva contraseÃ±a</label>
      <input type="password" id="cpNew" placeholder="MÃ­nimo 6 caracteres">
    </div>
    <div class="field">
      <label>Confirmar nueva contraseÃ±a</label>
      <input type="password" id="cpNew2" placeholder="Repite la nueva contraseÃ±a">
    </div>
    <button class="btn btn-primary" onclick="doChangePass()">ğŸ”‘ Cambiar ContraseÃ±a</button>
    <button class="btn btn-ghost" style="margin-top:8px;" onclick="closeModal('changePassModal')">Cancelar</button>
  </div>
</div>

<!-- Stats Modal -->
<div class="modal-overlay hidden" id="statsModal">
  <div class="modal-box">
    <div class="modal-handle"></div>
    <div id="statsContent"></div>
    <button class="btn btn-ghost" style="margin-top:16px;" onclick="closeModal('statsModal')">Cerrar</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const fbConfig = {
  apiKey:"AIzaSyCGfPIf-Q1x90hTne1tCMWNFuS0hio4CtA",
  authDomain:"quiniela-luan-25.firebaseapp.com",
  projectId:"quiniela-luan-25",
  storageBucket:"quiniela-luan-25.firebasestorage.app",
  messagingSenderId:"360325608839",
  appId:"1:360325608839:web:900af9bafc56bbcbfacf22"
};
firebase.initializeApp(fbConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API_KEY = '333289';
const API_V1  = `https://www.thesportsdb.com/api/v1/json/${API_KEY}`;
const API_V2  = `https://www.thesportsdb.com/api/v2/json`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOURNAMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TOURNAMENTS = [
  { id:'ucl',      name:'Champions League', flag:'â­', lid:'4480' },
  { id:'uel',      name:'Europa League',    flag:'ğŸŒ', lid:'4481' },
  { id:'bundesliga', name:'Bundesliga',     flag:'ğŸ‡©ğŸ‡ª', lid:'4331' },
  { id:'ligue1',   name:'Ligue 1',          flag:'ğŸ‡«ğŸ‡·', lid:'4334' },
  { id:'seriea',   name:'Serie A',          flag:'ğŸ‡®ğŸ‡¹', lid:'4332' },
  { id:'premier',  name:'Premier League',   flag:'ğŸ´', lid:'4328' },
  { id:'laliga',   name:'LaLiga',           flag:'ğŸ‡ªğŸ‡¸', lid:'4335' },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COUNTRIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const COUNTRIES = [
  {f:'ğŸ‡»ğŸ‡ª',n:'Venezuela',d:'+58'},{f:'ğŸ‡ºğŸ‡¸',n:'Estados Unidos',d:'+1'},
  {f:'ğŸ‡²ğŸ‡½',n:'MÃ©xico',d:'+52'},{f:'ğŸ‡¨ğŸ‡´',n:'Colombia',d:'+57'},
  {f:'ğŸ‡µğŸ‡ª',n:'PerÃº',d:'+51'},{f:'ğŸ‡¦ğŸ‡·',n:'Argentina',d:'+54'},
  {f:'ğŸ‡¨ğŸ‡±',n:'Chile',d:'+56'},{f:'ğŸ‡ªğŸ‡¨',n:'Ecuador',d:'+593'},
  {f:'ğŸ‡§ğŸ‡´',n:'Bolivia',d:'+591'},{f:'ğŸ‡µğŸ‡¾',n:'Paraguay',d:'+595'},
  {f:'ğŸ‡ºğŸ‡¾',n:'Uruguay',d:'+598'},{f:'ğŸ‡§ğŸ‡·',n:'Brasil',d:'+55'},
  {f:'ğŸ‡µğŸ‡¦',n:'PanamÃ¡',d:'+507'},{f:'ğŸ‡¨ğŸ‡·',n:'Costa Rica',d:'+506'},
  {f:'ğŸ‡¬ğŸ‡¹',n:'Guatemala',d:'+502'},{f:'ğŸ‡­ğŸ‡³',n:'Honduras',d:'+504'},
  {f:'ğŸ‡¸ğŸ‡»',n:'El Salvador',d:'+503'},{f:'ğŸ‡³ğŸ‡®',n:'Nicaragua',d:'+505'},
  {f:'ğŸ‡©ğŸ‡´',n:'Rep. Dominicana',d:'+1809'},{f:'ğŸ‡¨ğŸ‡º',n:'Cuba',d:'+53'},
  {f:'ğŸ‡µğŸ‡·',n:'Puerto Rico',d:'+1787'},{f:'ğŸ‡ªğŸ‡¸',n:'EspaÃ±a',d:'+34'},
  {f:'ğŸ‡¬ğŸ‡§',n:'Reino Unido',d:'+44'},{f:'ğŸ‡©ğŸ‡ª',n:'Alemania',d:'+49'},
  {f:'ğŸ‡«ğŸ‡·',n:'Francia',d:'+33'},{f:'ğŸ‡®ğŸ‡¹',n:'Italia',d:'+39'},
  {f:'ğŸ‡³ğŸ‡±',n:'PaÃ­ses Bajos',d:'+31'},{f:'ğŸ‡µğŸ‡¹',n:'Portugal',d:'+351'},
  {f:'ğŸ‡¨ğŸ‡¦',n:'CanadÃ¡',d:'+1'},{f:'ğŸ‡¦ğŸ‡º',n:'Australia',d:'+61'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let me = null;
let myTournaments = [];
let allMatches = [];
let dayMatches = [];
let userEnteringPreds = false;
let syncTimer = null;
let chatUnsub = null;
let currentCountryTarget = null;
let selectedCountry = { login: COUNTRIES[0], reg: COUNTRIES[0], reset: COUNTRIES[0] };

// â”€â”€ CACHE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Saves Firestore reads by keeping data in memory + localStorage
const CACHE_KEY_MATCHES  = 'ql_matches_v3';
const CACHE_KEY_SYNC     = 'ql_last_sync';
const CACHE_TTL_MATCHES  = 5 * 60 * 1000;   // 5 min between API syncs
const CACHE_TTL_LIVE     = 30 * 1000;        // 30s when live games active
const CHAT_PAGE_SIZE     = 40;               // Only load last 40 chat messages

function cacheSet(key, data) {
  try { localStorage.setItem(key, JSON.stringify({t: Date.now(), d: data})); } catch(e) {}
}
function cacheGet(key, maxAge) {
  try {
    const raw = localStorage.getItem(key);
    if (!raw) return null;
    const {t, d} = JSON.parse(raw);
    if (Date.now() - t > maxAge) return null;
    return d;
  } catch(e) { return null; }
}
function cacheInvalidate(key) {
  try { localStorage.removeItem(key); } catch(e) {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const $ = id => document.getElementById(id);
const randCode = () => Math.random().toString(36).substring(2,8).toUpperCase();

function toast(msg, type='info', dur=3500) {
  const t = document.createElement('div');
  t.className = `toast toast-${type}`;
  t.textContent = msg;
  $('toastContainer').appendChild(t);
  setTimeout(() => t.remove(), dur);
}

function openModal(id) { $(id).classList.remove('hidden'); }
function closeModal(id) { $(id).classList.add('hidden'); }

function isLive(status) {
  return ['1H','2H','HT','ET','P','In Play','LIVE'].includes(status);
}
function isFinished(status) {
  const s = (status||'').toUpperCase();
  return ['FT','AET','AP','PEN','MATCH FINISHED','FINISHED'].includes(s);
}
function statusLabel(s) {
  const map = {'1H':'â± 1er Tiempo','HT':'â¸ Descanso','2H':'â± 2do Tiempo',
               'ET':'â± T. Extra','P':'ğŸ¥… Penaltis','FT':'âœ… Final',
               'AET':'âœ… Final (TE)','AP':'âœ… Final (Pen)','PEN':'âœ… Final (Pen)',
               'Match Finished':'âœ… Final','MATCH FINISHED':'âœ… Final'};
  return map[s] || s;
}

function escapeHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// Venezuela time
function vzNow() { return new Date(Date.now() - 4*3600000); }
function vzDate() { return vzNow().toISOString().split('T')[0]; }
function vzTime(t) {
  if (!t) return '--:--';
  const [h,m] = t.split(':');
  const hv = (+h - 4 + 24) % 24;
  return `${String(hv).padStart(2,'0')}:${m}`;
}

// Clock
function startClock() {
  const tick = () => {
    const now = vzNow();
    $('hdrClock').textContent = now.toLocaleTimeString('es-VE',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  };
  tick(); setInterval(tick, 1000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COUNTRY PICKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openCountryPicker(target) {
  currentCountryTarget = target;
  filterCountries('');
  openModal('countryModal');
  setTimeout(()=>$('countrySearch').focus(), 100);
}
function closeCountryPicker(e) {
  if (e.target.id === 'countryModal') closeModal('countryModal');
}
function filterCountries(q) {
  const list = $('countryList');
  const filtered = q ? COUNTRIES.filter(c=>c.n.toLowerCase().includes(q.toLowerCase())||c.d.includes(q)) : COUNTRIES;
  list.innerHTML = filtered.map(c=>`
    <div class="country-option" onclick="selectCountry('${c.d}','${c.f}','${c.n}')">
      <span>${c.f}</span><span class="dial">${c.d}</span><span>${c.n}</span>
    </div>`).join('');
}
function selectCountry(dial, flag, name) {
  selectedCountry[currentCountryTarget] = {d:dial,f:flag,n:name};
  const btnId = currentCountryTarget==='login'?'loginCountryBtn':currentCountryTarget==='reg'?'regCountryBtn':'resetCountryBtn';
  $(btnId).textContent = `${flag} ${dial} â–¾`;
  closeModal('countryModal');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchAuthTab(tab) {
  ['login','register','reset'].forEach(t=>{
    $(`form${t.charAt(0).toUpperCase()+t.slice(1)}`)?.classList.add('hidden');
    $(`tab${t.charAt(0).toUpperCase()+t.slice(1)}`)?.classList.remove('active');
  });
  $(`form${tab.charAt(0).toUpperCase()+tab.slice(1)}`).classList.remove('hidden');
  if (tab!=='reset') {
    $(`tab${tab.charAt(0).toUpperCase()+tab.slice(1)}`).classList.add('active');
  }
}

function showReset() {
  $('formLogin').classList.add('hidden');
  $('formReset').classList.remove('hidden');
}

function phoneToEmail(phone, target) {
  const raw = phone.replace(/\D/g,'');
  const code = selectedCountry[target].d.replace('+','');
  return code + raw.replace(/^0/,'') + '@quiniela.app';
}

async function doLogin() {
  const phone = $('loginPhone').value.trim();
  const pass  = $('loginPass').value;
  if (!phone) { toast('Ingresa tu telÃ©fono','error'); return; }
  if (!pass)  { toast('Ingresa tu contraseÃ±a','error'); return; }

  const btn = document.querySelector('#formLogin .btn-primary');
  if (btn) { btn.disabled = true; btn.textContent = 'â³ Entrando...'; }

  const email = phoneToEmail(phone, 'login');
  try {
    await auth.signInWithEmailAndPassword(email, pass);
    // onAuthStateChanged handles the rest
  } catch(e) {
    const msg = e.code==='auth/wrong-password' ? 'âŒ ContraseÃ±a incorrecta'
              : e.code==='auth/user-not-found'  ? 'âŒ TelÃ©fono no registrado'
              : e.code==='auth/too-many-requests'? 'âŒ Demasiados intentos. Espera unos minutos'
              : e.code==='auth/network-request-failed' ? 'âŒ Sin conexiÃ³n'
              : 'âŒ Error: ' + e.message;
    toast(msg,'error');
    if (btn) { btn.disabled = false; btn.textContent = 'Entrar â†’'; }
  }
}

async function doRegister() {
  const name     = $('regName').value.trim();
  const username = $('regUsername').value.trim().toUpperCase();
  const phone    = $('regPhone').value.trim();
  const pass     = $('regPass').value;
  const invite   = $('regInvite').value.trim().toUpperCase();

  if (!name)           { toast('Ingresa tu nombre','error'); return; }
  if (!username)       { toast('Ingresa un apodo','error'); return; }
  if (username.length > 8) { toast('Apodo mÃ¡ximo 8 caracteres','error'); return; }
  if (!phone)          { toast('Ingresa tu telÃ©fono','error'); return; }
  if (pass.length < 6) { toast('ContraseÃ±a mÃ­nimo 6 caracteres','error'); return; }

  // Disable button to prevent double tap
  const btn = document.querySelector('#formRegister .btn-primary');
  if (btn) { btn.disabled = true; btn.textContent = 'â³ Registrando...'; }

  try {
    const email = phoneToEmail(phone, 'reg');
    const countryCode = selectedCountry.reg.d.replace('+','');
    const fullPhone = '+' + countryCode + phone.replace(/^0/,'').replace(/\D/g,'');

    // Step 1: Create auth user first (no Firestore needed yet)
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    const uid  = cred.user.uid;

    // Step 2: Now authenticated â€” check username unique
    const uCheck = await db.collection('users').where('username','==',username).limit(1).get();
    if (!uCheck.empty) {
      // Username taken â€” delete the auth user we just created and abort
      await cred.user.delete();
      toast('âŒ Ese apodo ya estÃ¡ en uso','error');
      if (btn) { btn.disabled=false; btn.textContent='Crear cuenta â†’'; }
      return;
    }

    // Step 3: Get player number
    const allSnap = await db.collection('users').get();
    const playerNumber = allSnap.size + 1;
    const isFirst = allSnap.empty;

    // Step 4: Save profile to Firestore
    await db.collection('users').doc(uid).set({
      name, username,
      phone: fullPhone,
      phoneDisplay: `${selectedCountry.reg.f} ${selectedCountry.reg.d} ${phone.replace(/^0/,'')}`,
      personalInviteCode: randCode(),
      isAdmin: isFirst,
      playerNumber,
      points: 0, exactPredictions: 0, correctResults: 0,
      invitedBy: invite || 'DIRECT',
      tournaments: ['ucl','uel'],
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    toast('âœ… Cuenta creada. Entrando...','success');
    // onAuthStateChanged fires automatically and calls enterApp()

  } catch(e) {
    const msg = e.code==='auth/email-already-in-use' ? 'Ese telÃ©fono ya estÃ¡ registrado'
              : e.code==='auth/weak-password' ? 'ContraseÃ±a muy dÃ©bil (mÃ­n. 6 caracteres)'
              : e.code==='auth/network-request-failed' ? 'Sin conexiÃ³n. Revisa tu internet'
              : e.message;
    toast('âŒ '+msg,'error');
  } finally {
    if (btn) { btn.disabled = false; btn.textContent = 'Crear cuenta â†’'; }
  }
}

async function doReset() {
  const phone = $('resetPhone').value.trim();
  if (!phone) { toast('Ingresa tu telÃ©fono','error'); return; }
  const email = phoneToEmail(phone, 'reset');
  try {
    await auth.sendPasswordResetEmail(email);
    toast('âœ… Enlace enviado','success');
  } catch(e) {
    toast('TelÃ©fono no encontrado','error');
  }
}

async function doLogout() {
  clearTimeout(syncTimer);
  if (chatUnsub) chatUnsub();
  await auth.signOut();
}

async function doChangePass() {
  const oldPass = $('cpOld').value;
  const newPass = $('cpNew').value;
  const newPass2 = $('cpNew2').value;
  if (!oldPass || !newPass) { toast('Completa todos los campos','error'); return; }
  if (newPass.length < 6) { toast('MÃ­nimo 6 caracteres','error'); return; }
  if (newPass !== newPass2) { toast('Las contraseÃ±as no coinciden','error'); return; }
  try {
    // Re-authenticate first
    const user = auth.currentUser;
    const cred = firebase.auth.EmailAuthProvider.credential(user.email, oldPass);
    await user.reauthenticateWithCredential(cred);
    await user.updatePassword(newPass);
    closeModal('changePassModal');
    toast('âœ… ContraseÃ±a cambiada exitosamente','success');
  } catch(e) {
    if (e.code==='auth/wrong-password') toast('âŒ ContraseÃ±a actual incorrecta','error');
    else toast('Error: '+e.message,'error');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
auth.onAuthStateChanged(async user => {
  if (user) {
    // Retry up to 5 times â€” doc may not be saved yet after registration
    let doc = null;
    for (let i = 0; i < 5; i++) {
      doc = await db.collection('users').doc(user.uid).get();
      if (doc.exists) break;
      await new Promise(r => setTimeout(r, 600)); // wait 600ms and retry
    }
    if (!doc || !doc.exists) {
      toast('âŒ Error al cargar tu perfil. Intenta de nuevo.','error');
      await auth.signOut();
      return;
    }
    me = { uid: user.uid, ...doc.data() };
    myTournaments = me.tournaments || ['ucl','uel'];
    enterApp();
  } else {
    $('authScreen').classList.remove('hidden');
    $('mainApp').classList.add('hidden');
    // Reset login button
    const btn = document.querySelector('#formLogin .btn-primary');
    if (btn) { btn.disabled = false; btn.textContent = 'Entrar â†’'; }
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENTER APP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function enterApp() {
  $('authScreen').classList.add('hidden');
  $('mainApp').classList.remove('hidden');

  // Check if user has a pending temp password reset
  try {
    const resetDoc = await db.collection('passResets').doc(me.uid).get();
    if (resetDoc.exists && !resetDoc.data().used) {
      setTimeout(() => {
        toast('ğŸ”‘ Entraste con contraseÃ±a temporal. CÃ¡mbiala ahora.','warning', 6000);
        openModal('changePassModal');
        // Mark as used
        db.collection('passResets').doc(me.uid).update({used: true});
      }, 1500);
    }
  } catch(e) {}

  // Header
  $('hdrName').textContent = me.username;
  $('hdrCode').textContent = me.personalInviteCode || 'â€”';
  if (me.playerNumber) $('hdrPlayerNum').textContent = '#' + me.playerNumber;
  if (me.isAdmin) {
    $('hdrAdminBadge').classList.remove('hidden');
    $('nav-admin').classList.remove('hidden');
  }

  startClock();
  showScreen('matches');
  loadMatches();

  // Adaptive auto-sync:
  // â€¢ Live games: every 45s
  // â€¢ No live games today: every 5 minutes (saves reads)
  // â€¢ User typing: skip
  function scheduleNextSync() {
    const hasLive = dayMatches.some(m => isLive(m.status));
    const interval = hasLive ? 45000 : 300000;
    syncTimer = setTimeout(async () => {
      if (!userEnteringPreds) {
        const hasTodayGames = dayMatches.length > 0;
        if (hasTodayGames) await doSync();
        else await autoEval();
      }
      scheduleNextSync();
    }, interval);
  }
  scheduleNextSync();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREEN NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(name) {
  ['matches','preds','chat','tournaments','groups','admin'].forEach(s => {
    $(`screen${s.charAt(0).toUpperCase()+s.slice(1)}`)?.classList.add('hidden');
    $(`nav-${s}`)?.classList.remove('active');
  });
  $(`screen${name.charAt(0).toUpperCase()+name.slice(1)}`).classList.remove('hidden');
  $(`nav-${name}`)?.classList.add('active');

  if (name==='preds')        renderPreds();
  if (name==='chat')         initChat();
  if (name==='tournaments')  renderTournaments();
  if (name==='groups')       renderGroups();
  if (name==='admin')        renderAdmin();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MATCHES â€” SYNC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadMatches() {
  // 1) Try memory cache first (zero Firestore reads)
  const cached = cacheGet(CACHE_KEY_MATCHES, CACHE_TTL_MATCHES);
  if (cached && cached.length) {
    allMatches = cached;
    setDayMatches();
    renderMatches();
    // Only sync if cache is old or there are live games
    const hasLive = dayMatches.some(m => isLive(m.status));
    const lastSync = +localStorage.getItem(CACHE_KEY_SYNC) || 0;
    const sinceLast = Date.now() - lastSync;
    if (sinceLast < CACHE_TTL_MATCHES && !hasLive) return; // Cache fresh, no sync needed
  }
  // 2) No cache or stale â€” sync from API + Firestore
  await doSync();
}

async function doSync() {
  const found = new Map();

  // 1) Try V2 livescore first (fastest for live games)
  try {
    const res = await fetch(`${API_V2}/livescore/soccer`);
    if (res.ok) {
      const data = await res.json();
      const lives = data?.livescore || data?.events || [];
      lives.forEach(ev => {
        const t = TOURNAMENTS.find(t => t.lid === ev.idLeague);
        if (t && myTournaments.includes(t.id)) found.set(ev.idEvent, parseEvent(ev,t));
      });
    }
  } catch(e) {}

  // 2) V1 next + past per tournament
  for (const t of TOURNAMENTS) {
    if (!myTournaments.includes(t.id)) continue;
    try {
      const r = await fetch(`${API_V1}/eventsnextleague.php?id=${t.lid}`);
      if (r.ok) { const d=await r.json(); (d?.events||[]).forEach(ev=>found.set(ev.idEvent,parseEvent(ev,t))); }
    } catch(e) {}
    try {
      const r = await fetch(`${API_V1}/eventspastleague.php?id=${t.lid}`);
      if (r.ok) { const d=await r.json(); (d?.events||[]).forEach(ev=>found.set(ev.idEvent,parseEvent(ev,t))); }
    } catch(e) {}
  }

  // 3) Merge with Firestore
  try {
    const fsSnap = await db.collection('matches').get();
    fsSnap.docs.forEach(d=>{
      if (!found.has(d.id)) found.set(d.id,{id:d.id,...d.data()});
    });
  } catch(e) {}

  if (!found.size) { renderMatches(); return; }

  allMatches = Array.from(found.values());

  // 4) lookupevent ONLY for today's matches (not all matches)
  await refreshDayScores();

  // 5) Save to Firestore â€” only matches from today (reduce writes)
  const today = vzDate();
  const toWrite = Array.from(found.values()).filter(m => m.date === today);
  if (toWrite.length) {
    try {
      const b = db.batch();
      toWrite.forEach(m => b.set(db.collection('matches').doc(String(m.id)), m, {merge:true}));
      await b.commit();
    } catch(e) {}
  }

  // 6) Update cache
  cacheSet(CACHE_KEY_MATCHES, allMatches);
  localStorage.setItem(CACHE_KEY_SYNC, Date.now());

  setDayMatches();
  renderMatches();
  await autoEval();
}

async function refreshDayScores() {
  const today = vzDate();
  const targets = allMatches.filter(m => m.date===today || m.date===vzDate());
  if (!targets.length) return;

  const batch = db.batch();
  for (const m of targets) {
    try {
      const r = await fetch(`${API_V1}/lookupevent.php?id=${m.id}`);
      if (!r.ok) continue;
      const data = await r.json();
      const ev = data?.events?.[0];
      if (!ev) continue;
      const upd = {
        homeScore: ev.intHomeScore!=null?+ev.intHomeScore:null,
        awayScore: ev.intAwayScore!=null?+ev.intAwayScore:null,
        status: ev.strStatus||'Not Started',
        minute: ev.strProgress||ev.intProgress||null,
        homeGoals: ev.strHomeGoalDetails||'',
        awayGoals: ev.strAwayGoalDetails||'',
      };
      const idx = allMatches.findIndex(x=>String(x.id)===String(m.id));
      if (idx!==-1) allMatches[idx]={...allMatches[idx],...upd};
      batch.set(db.collection('matches').doc(String(m.id)),upd,{merge:true});
    } catch(e) {}
  }
  try { await batch.commit(); } catch(e) {}
}

function parseEvent(ev, t) {
  const hs = ev.intHomeScore??ev.homeScore??null;
  const as = ev.intAwayScore??ev.awayScore??null;
  return {
    id: String(ev.idEvent||ev.id),
    home: ev.strHomeTeam||ev.home_team,
    away: ev.strAwayTeam||ev.away_team,
    date: ev.dateEvent||ev.date,
    time: ev.strTime||ev.time||'00:00',
    homeScore: hs!=null?+hs:null,
    awayScore: as!=null?+as:null,
    status: ev.strStatus||'Not Started',
    minute: ev.strProgress||ev.intProgress||null,
    homeGoals: ev.strHomeGoalDetails||'',
    awayGoals: ev.strAwayGoalDetails||'',
    tournamentId: t.id,
    tournamentName: t.name,
    tournamentFlag: t.flag,
    round: ev.intRound||1,
  };
}

function setDayMatches() {
  const today = vzDate();
  let pool = allMatches.filter(m=>m.date===today);
  if (!pool.length) {
    const upcoming = allMatches.filter(m=>m.date>today).sort((a,b)=>a.date.localeCompare(b.date));
    const nextDate = upcoming[0]?.date;
    pool = nextDate ? allMatches.filter(m=>m.date===nextDate) : [];
  }
  dayMatches = pool.sort((a,b)=>(a.time||'').localeCompare(b.time||''));
}

function bettingClosed() {
  return dayMatches.some(m => isLive(m.status) || isFinished(m.status));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER MATCHES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMatches() {
  const el = $('screenMatches');
  if (!el) return;

  // Save typed predictions
  const saved = {};
  dayMatches.forEach(m=>{
    const hi=$(`hi_${m.id}`),ai=$(`ai_${m.id}`);
    if(hi&&ai&&(hi.value!=='0'||ai.value!=='0')) saved[m.id]={h:hi.value,a:ai.value};
  });

  const closed = bettingClosed();
  const nextClose = !closed ? dayMatches.find(m=>m.status==='Not Started') : null;

  let html = `
    <div class="section-header">
      <span class="section-title">âš½ Partidos</span>
      <button class="btn btn-ghost btn-sm" onclick="doSync()">ğŸ”„ Sync</button>
    </div>`;

  // Countdown banner
  if (nextClose) {
    html += `<div class="countdown-banner">
      <div><div class="countdown-label">â° PrÃ³ximo cierre</div>
      <div class="countdown-match" style="font-size:0.85em;">${nextClose.home} vs ${nextClose.away}</div></div>
      <div class="countdown-status">${vzTime(nextClose.time)}</div>
    </div>`;
  }
  if (closed) {
    html += `<div class="countdown-banner" style="background:rgba(255,77,109,0.08);border-color:rgba(255,77,109,0.3);">
      <span style="color:var(--red);font-weight:800;">ğŸ”´ Predicciones CERRADAS</span>
      <span style="font-size:0.78em;color:var(--muted2);">Partidos en curso</span>
    </div>`;
  }

  if (!dayMatches.length) {
    html += `<div class="empty"><span class="empty-icon">ğŸ“­</span><span class="empty-text">Sin partidos. Pulsa Sync.</span></div>`;
  } else {
    dayMatches.forEach(m => { html += buildMatchCard(m, closed); });
    if (!closed) {
      html += `<button class="btn btn-primary" style="margin-top:8px;" onclick="savePreds()">ğŸ’¾ Guardar Predicciones</button>`;
    }
  }

  el.innerHTML = html;

  // Restore typed predictions
  Object.entries(saved).forEach(([mid,v])=>{
    const hi=$(`hi_${mid}`),ai=$(`ai_${mid}`);
    if(hi)hi.value=v.h; if(ai)ai.value=v.a;
  });
}

function buildMatchCard(m, closed) {
  const live = isLive(m.status);
  const done = isFinished(m.status);
  const showScore = live || done;
  const cls = live?'live':done?'finished':'';

  let badge = '';
  if (live) badge = `<span class="badge-live">ğŸ”´ ${statusLabel(m.status)}</span>`;
  else if (done) badge = `<span class="badge-done">${statusLabel(m.status)}</span>`;
  else badge = `<span class="badge-time">${vzTime(m.time)}</span>`;

  let centerContent = '';
  if (showScore) {
    centerContent = `
      <div style="text-align:center;">
        <div style="display:flex;align-items:center;justify-content:center;gap:8px;">
          <span class="team-score ${live?'score-live':'score-final'}">${m.homeScore??'?'}</span>
          <span style="color:var(--muted);font-family:var(--font-h);font-size:1.2em;">â€”</span>
          <span class="team-score ${live?'score-live':'score-final'}">${m.awayScore??'?'}</span>
        </div>
        ${m.minute?`<div style="font-size:0.72em;color:var(--red);font-weight:700;margin-top:2px;">â± ${m.minute}'</div>`:''}
      </div>`;
  } else {
    centerContent = `<span class="vs-divider">VS</span>`;
  }

  // Goals detail
  let goalsHtml = '';
  if (showScore && (m.homeGoals||m.awayGoals)) {
    goalsHtml = `<div class="goal-list">`;
    if (m.homeGoals) m.homeGoals.split(';').filter(Boolean).forEach(g=>{
      goalsHtml += `<div class="goal-item goal-home">âš½ ${g.trim()}</div>`;
    });
    if (m.awayGoals) m.awayGoals.split(';').filter(Boolean).forEach(g=>{
      goalsHtml += `<div class="goal-item goal-away">âš½ ${g.trim()}</div>`;
    });
    goalsHtml += `</div>`;
  }

  const statsBtn = showScore ? `<button class="stats-btn" onclick="openStats('${m.id}')">ğŸ“Š EstadÃ­sticas & Goles</button>` : '';

  const predRow = (!showScore && !closed) ? `
    <div class="pred-row" style="margin-top:8px;">
      <input type="number" min="0" max="20" value="0" id="hi_${m.id}" class="pred-input" oninput="userEnteringPreds=true">
      <span class="pred-dash">â€”</span>
      <input type="number" min="0" max="20" value="0" id="ai_${m.id}" class="pred-input" oninput="userEnteringPreds=true">
    </div>` : '';

  return `
    <div class="match-card ${cls}">
      <div class="match-meta">
        <span>${m.tournamentFlag||'ğŸŒ'} ${m.tournamentName}</span>
        ${badge}
      </div>
      <div class="match-teams">
        <div class="team">
          <span class="team-flag">âš½</span>
          <span class="team-name">${m.home}</span>
        </div>
        ${centerContent}
        <div class="team">
          <span class="team-flag">âš½</span>
          <span class="team-name">${m.away}</span>
        </div>
      </div>
      ${goalsHtml}
      ${predRow}
      ${statsBtn}
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATS MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function openStats(matchId) {
  openModal('statsModal');
  $('statsContent').innerHTML = '<div class="empty"><span class="empty-icon">â³</span><span class="empty-text">Cargando...</span></div>';
  try {
    const r = await fetch(`${API_V1}/lookupevent.php?id=${matchId}`);
    const data = await r.json();
    const ev = data?.events?.[0];
    if (!ev) { $('statsContent').innerHTML='<div class="empty"><span class="empty-text">Sin datos disponibles</span></div>'; return; }

    const hs = ev.intHomeScore??'?', as = ev.intAwayScore??'?';
    let html = `
      <div style="text-align:center;margin-bottom:20px;">
        <div style="font-size:0.75em;color:var(--muted2);margin-bottom:6px;">${ev.strLeague}</div>
        <div style="font-family:var(--font-h);font-size:1.1em;margin-bottom:8px;">${ev.strHomeTeam}</div>
        <div style="display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:8px;">
          <span style="font-family:var(--font-h);font-size:3em;color:${isLive(ev.strStatus)?'var(--red)':'var(--green)'};">${hs}</span>
          <span style="color:var(--muted);font-family:var(--font-h);font-size:1.5em;">â€”</span>
          <span style="font-family:var(--font-h);font-size:3em;color:${isLive(ev.strStatus)?'var(--red)':'var(--green)'};">${as}</span>
        </div>
        <div style="font-family:var(--font-h);font-size:1.1em;margin-bottom:6px;">${ev.strAwayTeam}</div>
        <span class="${isLive(ev.strStatus)?'badge-live':'badge-done'}">${statusLabel(ev.strStatus)}</span>
      </div>`;

    // Goals
    if (ev.strHomeGoalDetails||ev.strAwayGoalDetails) {
      html += `<div style="font-weight:800;font-size:0.82em;text-transform:uppercase;letter-spacing:1px;color:var(--muted2);margin-bottom:8px;">âš½ Goles</div>`;
      if (ev.strHomeGoalDetails) ev.strHomeGoalDetails.split(';').filter(Boolean).forEach(g=>{
        html += `<div class="info-row"><span class="info-label">ğŸ  ${ev.strHomeTeam}</span><span class="info-val">${g.trim()}</span></div>`;
      });
      if (ev.strAwayGoalDetails) ev.strAwayGoalDetails.split(';').filter(Boolean).forEach(g=>{
        html += `<div class="info-row"><span class="info-label">âœˆï¸ ${ev.strAwayTeam}</span><span class="info-val">${g.trim()}</span></div>`;
      });
    }
    if (ev.strHomeRedCards||ev.strAwayRedCards) {
      html += `<div style="font-weight:800;font-size:0.82em;text-transform:uppercase;letter-spacing:1px;color:var(--muted2);margin-top:12px;margin-bottom:8px;">ğŸŸ¥ Tarjetas Rojas</div>`;
      if (ev.strHomeRedCards) html+=`<div class="info-row"><span class="info-label">${ev.strHomeTeam}</span><span class="info-val">${ev.strHomeRedCards}</span></div>`;
      if (ev.strAwayRedCards) html+=`<div class="info-row"><span class="info-label">${ev.strAwayTeam}</span><span class="info-val">${ev.strAwayRedCards}</span></div>`;
    }
    $('statsContent').innerHTML = html;
  } catch(e) {
    $('statsContent').innerHTML=`<div class="empty"><span class="empty-text">Error: ${e.message}</span></div>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVE PREDICTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function savePreds() {
  if (!me?.uid) return;
  if (bettingClosed()) { toast('â›” Predicciones cerradas â€” ya iniciÃ³ un partido','error'); return; }

  const jDate = dayMatches[0]?.date;
  if (!jDate) { toast('Sin partidos disponibles','error'); return; }

  const preds = [];
  dayMatches.forEach(m=>{
    const hi=$(`hi_${m.id}`),ai=$(`ai_${m.id}`);
    if(hi&&ai) preds.push({matchId:String(m.id),h:+hi.value||0,a:+ai.value||0,match:m});
  });
  if (!preds.length) { toast('Sin predicciones para guardar','error'); return; }

  // Get my groups
  const grpSnap = await db.collection('groups').get();
  const myGroups = grpSnap.docs.map(d=>({id:d.id,...d.data()})).filter(g=>g.members?.some(m=>m.userId===me.uid));
  if (!myGroups.length) { toast('No perteneces a ningÃºn grupo','error'); return; }

  if (myGroups.length === 1) {
    await doSavePreds(preds, jDate, myGroups[0]);
  } else {
    // Show group selector
    const list = $('grpPickList');
    list.innerHTML = '';
    myGroups.forEach(g=>{
      const btn = document.createElement('button');
      btn.className = 'btn btn-ghost';
      btn.style.marginBottom = '8px';
      btn.innerHTML = `ğŸ‘¥ ${g.name} <span style="color:var(--muted2);font-size:0.8em;">Â· ${g.members?.length||0} jugadores</span>`;
      btn.onclick = async()=>{ closeModal('grpPickModal'); await doSavePreds(preds,jDate,g); };
      list.appendChild(btn);
    });
    openModal('grpPickModal');
  }
}

async function doSavePreds(preds, jDate, group) {
  // Check already saved for this group+date
  try {
    const ex = await db.collection('predictions')
      .where('userId','==',me.uid).where('jornadaDate','==',jDate).where('groupId','==',group.id).limit(1).get();
    if (!ex.empty) { toast(`Ya predijiste para "${group.name}" hoy`,'error'); return; }
  } catch(e) {}

  const summary = preds.map(p=>`${p.match.home} ${p.h}â€”${p.a} ${p.match.away}`).join('\n');
  if (!confirm(`ğŸ“‹ GRUPO: ${group.name}\n\n${summary}\n\nÂ¿Confirmar predicciones? No podrÃ¡s cambiarlas.`)) return;

  try {
    const b = db.batch();
    preds.forEach(p=>{
      const docId = `${me.uid}_${group.id}_${p.matchId}`;
      b.set(db.collection('predictions').doc(docId),{
        userId:me.uid, username:me.username,
        groupId:group.id, groupName:group.name,
        matchId:String(p.matchId),
        predictedHomeScore:p.h, predictedAwayScore:p.a,
        home:p.match.home, away:p.match.away,
        tournamentId:p.match.tournamentId, jornadaDate:jDate,
        evaluated:false,
        timestamp:firebase.firestore.FieldValue.serverTimestamp()
      });
    });
    await b.commit();
    userEnteringPreds = false;
    toast(`âœ… ${preds.length} predicciones guardadas para "${group.name}"!`,'success');
  } catch(e) {
    toast('Error al guardar: '+e.message,'error');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PREDICTIONS SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderPreds() {
  const el = $('screenPreds');
  el.innerHTML = '<div class="empty"><span class="empty-icon">â³</span></div>';
  const closed = bettingClosed();
  const canSearch = me.isAdmin || closed;

  let html = `<div class="section-header"><span class="section-title">ğŸ¯ Mis Predicciones</span></div>`;

  // Search section
  if (!canSearch) {
    html += `<div class="locked-box">
      <span class="lock-icon">ğŸ”’</span>
      <p>Disponible cuando empiece el primer partido</p>
      <small>Las predicciones de otros jugadores son visibles una vez iniciados los juegos</small>
    </div>`;
  } else {
    html += `<div class="card" style="margin-bottom:14px;">
      <p style="font-weight:700;font-size:0.85em;margin-bottom:10px;">ğŸ” Ver predicciones de otros jugadores</p>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">
        <div class="field" style="margin:0;"><input type="text" id="su1" placeholder="Jugador 1" style="text-transform:uppercase;" oninput="this.value=this.value.toUpperCase()"></div>
        <div class="field" style="margin:0;"><input type="text" id="su2" placeholder="Jugador 2" style="text-transform:uppercase;" oninput="this.value=this.value.toUpperCase()"></div>
      </div>
      <div class="field" style="margin-bottom:8px;"><input type="text" id="su3" placeholder="Jugador 3 (opcional)" style="text-transform:uppercase;" oninput="this.value=this.value.toUpperCase()"></div>
      <button class="btn btn-ghost btn-sm" onclick="searchPreds()">ğŸ” Buscar</button>
      <div id="searchRes" style="margin-top:12px;"></div>
    </div>`;
  }

  html += `<div style="font-weight:800;font-size:0.82em;text-transform:uppercase;letter-spacing:1px;color:var(--muted2);margin-bottom:10px;">ğŸ“‹ Tus Predicciones</div>`;

  try {
    // Limit to 30 most recent predictions (reduce reads)
    const snap = await db.collection('predictions').where('userId','==',me.uid).orderBy('timestamp','desc').limit(30).get();
    if (snap.empty) {
      html += `<div class="empty"><span class="empty-icon">ğŸ“­</span><span class="empty-text">AÃºn no has predicho</span></div>`;
    } else {
      snap.docs.forEach(d=>{
        const p = d.data();
        const match = allMatches.find(m=>String(m.id)===String(p.matchId));
        const hasReal = match && match.homeScore!=null;
        let ptsCls = 'pts-pending', ptsLabel = 'â³';
        if (p.evaluated) {
          if (p.pointsAwarded===5) { ptsCls='pts-5'; ptsLabel='â­ 5pts'; }
          else if (p.pointsAwarded===3) { ptsCls='pts-3'; ptsLabel='ğŸ¯ 3pts'; }
          else { ptsCls='pts-0'; ptsLabel='âŒ 0pts'; }
        } else if (hasReal && isFinished(match.status)) {
          ptsLabel='â³ Eval.';
        }
        html += `
          <div class="pred-item">
            <div>
              <div class="pred-match-name">${p.home}</div>
              <div class="pred-match-sub">vs ${p.away}</div>
            </div>
            <div class="pred-score-box">${p.predictedHomeScore}â€”${p.predictedAwayScore}</div>
            ${hasReal?`<div class="pred-real-box">Real<span class="pred-real-score">${match.homeScore}â€”${match.awayScore}</span></div>`:'<div></div>'}
            <div class="pred-pts-box ${ptsCls}">${ptsLabel}</div>
          </div>`;
      });
    }
  } catch(e) {
    html += `<div class="empty"><span class="empty-text">Error: ${e.message}</span></div>`;
  }

  el.innerHTML = html;
}

async function searchPreds() {
  const names = ['su1','su2','su3'].map(id=>$(id)?.value.trim().toUpperCase()).filter(Boolean);
  if (!names.length) { toast('Escribe al menos un nombre','error'); return; }
  const res = $('searchRes');
  res.innerHTML = '<div style="color:var(--muted2);font-size:0.85em;">Buscando...</div>';
  let html = '';
  for (const uname of names) {
    const uSnap = await db.collection('users').where('username','==',uname).limit(1).get();
    if (uSnap.empty) { html+=`<div style="color:var(--red);font-size:0.85em;padding:8px 0;">âŒ "${uname}" no encontrado</div>`; continue; }
    const u = {id:uSnap.docs[0].id,...uSnap.docs[0].data()};
    const ps = await db.collection('predictions').where('userId','==',u.id).limit(30).get();
    html += `<div class="card" style="margin-bottom:10px;">
      <div style="font-weight:800;margin-bottom:8px;">ğŸ‘¤ ${u.username} <span style="color:var(--muted2);font-size:0.8em;">#${u.playerNumber||'?'}</span></div>`;
    ps.docs.forEach(d=>{
      const p=d.data();
      html+=`<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:0.82em;">
        <span>${p.home} vs ${p.away}</span>
        <span style="font-family:var(--font-h);color:var(--primary2);">${p.predictedHomeScore}â€”${p.predictedAwayScore}</span>
      </div>`;
    });
    html += `</div>`;
  }
  res.innerHTML = html || '<div style="color:var(--muted2);">Sin resultados</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initChat() {
  const screen = $('screenChat');
  screen.innerHTML = `
    <div class="chat-header" style="padding-top:16px;">
      <div class="chat-online"></div>
      <div class="chat-header-info">
        <h3>ğŸ’¬ Chat Quiniela</h3>
        <p>Todos los grupos Â· En vivo</p>
      </div>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input-bar">
      <textarea class="chat-input" id="chatInput" placeholder="Escribe un mensaje..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat();}"></textarea>
      <button class="chat-send" onclick="sendChat()">â¤</button>
    </div>`;

  // Use onSnapshot but limit to last 40 messages to reduce reads
  if (chatUnsub) chatUnsub();
  chatUnsub = db.collection('chat').orderBy('ts').limitToLast(CHAT_PAGE_SIZE)
    .onSnapshot({includeMetadataChanges: false}, snap=>{
      const el=$('chatMessages');
      if(!el) return;
      // Only re-render on actual data changes (not metadata)
      if (snap.metadata.fromCache && !snap.docChanges().length) return;
      el.innerHTML='';
      snap.docs.forEach(d=>{
        const c=d.data();
        const mine=c.uid===me.uid;
        const time=c.ts?.toDate?.()||new Date();
        const hm=time.toLocaleTimeString('es-VE',{hour:'2-digit',minute:'2-digit'});
        if(c.type==='system'){
          el.innerHTML+=`<div class="chat-system">${c.text}</div>`;
        } else {
          el.innerHTML+=`<div class="chat-msg ${mine?'mine':'theirs'}">
            ${!mine?`<span class="chat-name">${c.username}</span>`:''}
            <div class="chat-bubble">${escapeHtml(c.text)}</div>
            <span class="chat-time">${hm}</span>
          </div>`;
        }
      });
      el.scrollTop=el.scrollHeight;
    });
}

async function sendChat() {
  const input=$('chatInput');
  const text=input.value.trim();
  if(!text) return;
  input.value='';
  try {
    await db.collection('chat').add({
      uid:me.uid, username:me.username,
      text, ts:firebase.firestore.FieldValue.serverTimestamp()
    });
  } catch(e){ toast('Error al enviar','error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOURNAMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTournaments() {
  const el = $('screenTournaments');
  let html = `<div class="section-header"><span class="section-title">ğŸ† Torneos</span></div>
    <p style="color:var(--muted2);font-size:0.85em;margin-bottom:16px;">Selecciona las ligas para las que quieres predecir:</p>`;
  TOURNAMENTS.forEach(t=>{
    const sel = myTournaments.includes(t.id);
    html += `<div class="tourn-item ${sel?'selected':''}" onclick="toggleTournament('${t.id}',this)">
      <div class="tourn-left">
        <span style="font-size:1.3em;">${t.flag}</span>
        <span>${t.name}</span>
      </div>
      <div class="tourn-check">${sel?'âœ“':''}</div>
    </div>`;
  });
  html += `<button class="btn btn-primary" style="margin-top:8px;" onclick="saveTournaments()">ğŸ’¾ Guardar selecciÃ³n</button>`;
  el.innerHTML = html;
}

function toggleTournament(id, el) {
  const sel = myTournaments.includes(id);
  if(sel) myTournaments=myTournaments.filter(t=>t!==id); else myTournaments.push(id);
  el.classList.toggle('selected',!sel);
  el.querySelector('.tourn-check').textContent=!sel?'âœ“':'';
}

async function saveTournaments() {
  await db.collection('users').doc(me.uid).update({tournaments:myTournaments});
  me.tournaments=myTournaments;
  toast('âœ… Torneos guardados','success');
  await doSync();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GROUPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderGroups() {
  const el = $('screenGroups');
  el.innerHTML = '<div class="empty"><span class="empty-icon">â³</span></div>';

  let html = `<div class="section-header">
    <span class="section-title">ğŸ‘¥ Grupos</span>
    <div style="display:flex;gap:8px;">
      <button class="btn btn-ghost btn-sm" onclick="openModal('createModal')">â• Crear</button>
      <button class="btn btn-ghost btn-sm" onclick="openModal('joinModal')">ğŸ”— Unirse</button>
    </div>
  </div>`;

  try {
    const snap = await db.collection('groups').get();
    if(me.isAdmin) html+=`<div style="background:rgba(108,71,255,0.1);border:1px solid rgba(108,71,255,0.3);border-radius:var(--r-sm);padding:8px 12px;margin-bottom:12px;font-size:0.78em;color:var(--primary2);font-weight:700;">ğŸ‘‘ Admin â€” ves todos los grupos</div>`;

    let found=0;
    snap.docs.forEach(doc=>{
      const g=doc.data();
      if(!me.isAdmin&&!g.members?.some(m=>m.userId===me.uid)) return;
      found++;
      const isMine=g.members?.some(m=>m.userId===me.uid);
      html+=`<div class="group-card">
        <div class="group-card-header">
          <div>
            <div class="group-name">${g.name} ${isMine?'ğŸ‘‘':''}</div>
            <div class="group-meta">ğŸ‘¥ ${g.members?.length||0}/${g.maxMembers} jugadores</div>
          </div>
          <div class="group-code">
            <span class="group-code-label">CÃ³digo</span>
            <span class="group-code-val">${g.code}</span>
          </div>
        </div>
        <div class="group-actions">
          ${me.isAdmin?`<button class="btn-del" onclick="deleteGroup('${doc.id}','${g.name}')">ğŸ—‘ï¸</button>`:''}
          <button class="btn-rank" onclick="openGroupRanking('${doc.id}')">ğŸ† Ver ClasificaciÃ³n</button>
          <button class="btn-wa" onclick="shareGroup('${g.code}','${g.name}')">ğŸ“²</button>
        </div>
      </div>`;
    });

    if(!found) html+=`<div class="empty"><span class="empty-icon">ğŸ‘¥</span><span class="empty-text">Sin grupos. Crea o Ãºnete a uno.</span></div>`;
  } catch(e) {
    html+=`<div class="empty"><span class="empty-text">Error: ${e.message}</span></div>`;
  }
  el.innerHTML=html;
}

async function doCreateGroup() {
  const name=$('createName').value.trim();
  const max=+$('createMax').value;
  if(!name){toast('Ingresa un nombre','error');return;}
  const total=await db.collection('groups').get();
  if(total.size>=5){toast('MÃ¡ximo 5 grupos permitidos','error');return;}
  const btn=$('createBtn'); btn.disabled=true;
  try {
    const code=randCode();
    await db.collection('groups').add({
      name,code,maxMembers:max,
      createdBy:me.uid,
      createdAt:new Date().toISOString(),
      members:[{userId:me.uid,username:me.username,joinedAt:new Date().toISOString(),isAdmin:true}]
    });
    closeModal('createModal');
    $('createName').value='';
    toast(`âœ… Grupo "${name}" creado Â· CÃ³digo: ${code}`,'success',5000);
    renderGroups();
  } catch(e){toast('Error: '+e.message,'error');}
  finally{btn.disabled=false;}
}

async function doJoinGroup() {
  const code=$('joinCode').value.trim().toUpperCase();
  const statusEl=$('joinStatus');
  const btn=$('joinBtn');
  const setS=(msg,t)=>{ statusEl.innerHTML=`<div class="status-box status-${t}">${msg}</div>`; };
  if(code.length!==6){setS('El cÃ³digo debe tener 6 caracteres','error');return;}
  btn.disabled=true; setS('ğŸ” Buscando grupo...','info');
  try {
    const snap=await db.collection('groups').where('code','==',code).limit(1).get();
    if(snap.empty){setS('âŒ CÃ³digo incorrecto. Verifica con el admin.','error');btn.disabled=false;return;}
    const gdoc=snap.docs[0]; const g=gdoc.data();
    if(g.members?.some(m=>m.userId===me.uid)){setS(`âœ… Ya eres miembro de "${g.name}"`,'success');setTimeout(()=>closeModal('joinModal'),1500);btn.disabled=false;return;}
    if(g.members?.length>=g.maxMembers){setS(`âŒ Grupo lleno (${g.members.length}/${g.maxMembers})`,'error');btn.disabled=false;return;}
    setS(`âœ… Grupo encontrado: "${g.name}" Â· ${g.members?.length||0}/${g.maxMembers} jugadores`,'success');
    await gdoc.ref.update({members:firebase.firestore.FieldValue.arrayUnion({userId:me.uid,username:me.username,joinedAt:new Date().toISOString(),isAdmin:false})});
    $('joinCode').value='';
    setTimeout(()=>{closeModal('joinModal');toast(`ğŸ‰ Â¡Bienvenido a "${g.name}"!`,'success');renderGroups();},1500);
  } catch(e){setS('Error: '+e.message,'error');btn.disabled=false;}
}

async function deleteGroup(gid, name) {
  if(!confirm(`Â¿Eliminar el grupo "${name}"? Esta acciÃ³n no se puede deshacer.`)) return;
  await db.collection('groups').doc(gid).delete();
  toast('âœ… Grupo eliminado','success');
  renderGroups();
}

function shareGroup(code, name) {
  const msg=encodeURIComponent(`Â¡Ãšnete a "${name}" en Quiniela Luan! âš½\nCÃ³digo: *${code}*\n\nEntra a la app â†’ Grupos â†’ Unirse â†’ escribe el cÃ³digo.`);
  window.open(`https://wa.me/?text=${msg}`,'_blank');
}

async function openGroupRanking(gid) {
  openModal('rankModal');
  $('rankModalList').innerHTML='<div class="empty"><span class="empty-icon">â³</span></div>';

  const gdoc=await db.collection('groups').doc(gid).get();
  const g=gdoc.data();
  $('rankModalTitle').textContent=`ğŸ† ${g.name}`;
  $('rankModalCode').textContent=`ğŸ” CÃ³digo: ${g.code}`;

  const memberIds=g.members.map(m=>m.userId);
  const ptMap={};
  memberIds.forEach(id=>{ptMap[id]={pts:0,exact:0,correct:0};});

  try {
    // New predictions with groupId
    const pSnap=await db.collection('predictions').where('groupId','==',gid).where('evaluated','==',true).get();
    pSnap.docs.forEach(d=>{
      const p=d.data();
      if(!ptMap[p.userId]) ptMap[p.userId]={pts:0,exact:0,correct:0};
      ptMap[p.userId].pts+=p.pointsAwarded||0;
      if(p.pointsAwarded===5) ptMap[p.userId].exact++;
      else if(p.pointsAwarded===3) ptMap[p.userId].correct++;
    });
    // Old predictions without groupId â€” single batch query, not per-user
    // Only do this if there are members (max 10 per Firestore 'in' query)
    if (memberIds.length <= 10) {
      const oldPreds = await db.collection('predictions')
        .where('userId','in',memberIds)
        .where('evaluated','==',true)
        .get();
      oldPreds.docs.forEach(d=>{
        const p=d.data();
        if(p.groupId) return; // Already counted above
        if(!ptMap[p.userId]) ptMap[p.userId]={pts:0,exact:0,correct:0};
        ptMap[p.userId].pts+=p.pointsAwarded||0;
        if(p.pointsAwarded===5) ptMap[p.userId].exact++;
        else if(p.pointsAwarded===3) ptMap[p.userId].correct++;
      });
    }

    // Get users
    const allU=[];
    for(let i=0;i<memberIds.length;i+=10){
      const chunk=memberIds.slice(i,i+10);
      const us=await db.collection('users').where(firebase.firestore.FieldPath.documentId(),'in',chunk).get();
      us.docs.forEach(d=>allU.push({id:d.id,...d.data()}));
    }

    const ranked=allU.map(u=>({...u,grpPts:ptMap[u.id]?.pts||0,grpExact:ptMap[u.id]?.exact||0,grpCorrect:ptMap[u.id]?.correct||0}))
      .sort((a,b)=>b.grpPts-a.grpPts||b.grpExact-a.grpExact);

    let html=`<div style="display:flex;justify-content:space-between;font-size:0.72em;color:var(--muted2);font-weight:700;text-transform:uppercase;letter-spacing:1px;padding:0 12px 8px;">
      <span>Jugador</span><span>â­Exactos</span><span>Pts</span></div>`;
    ranked.forEach((u,i)=>{
      const isMe=u.id===me.uid;
      const medal=i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':`#${i+1}`;
      html+=`<div class="rank-row ${isMe?'me':''}">
        <span class="rank-pos">${medal}</span>
        <div class="rank-name">${u.username}${isMe?' <span style="color:var(--primary2);font-size:0.75em;">(TÃš)</span>':''}
          <div class="rank-sub">ğŸ¯ ${u.grpCorrect} correctos</div>
        </div>
        <div style="text-align:center;min-width:50px;font-size:0.85em;color:var(--muted2);">${u.grpExact}</div>
        <div class="rank-pts">${u.grpPts}</div>
      </div>`;
    });
    $('rankModalList').innerHTML=html||'<div class="empty"><span class="empty-text">Sin datos aÃºn</span></div>';
  } catch(e){
    $('rankModalList').innerHTML=`<div class="empty"><span class="empty-text">Error: ${e.message}</span></div>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO EVALUATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function autoEval() {
  const finished = allMatches.filter(m=>isFinished(m.status)&&m.homeScore!=null);
  if(!finished.length) return;

  let evaluated=0;
  for(const match of finished){
    const rh=+match.homeScore, ra=+match.awayScore;
    const rr=rh===ra?'empate':rh>ra?'home':'away';
    try {
      const snaps=await Promise.all([
        db.collection('predictions').where('matchId','==',String(match.id)).where('evaluated','==',false).get(),
        db.collection('predictions').where('matchId','==',match.id).where('evaluated','==',false).get()
      ]);
      const seen=new Set(); const docs=[];
      snaps.forEach(s=>s.docs.forEach(d=>{if(!seen.has(d.id)){seen.add(d.id);docs.push(d);}}));
      for(const pd of docs){
        const p=pd.data();
        const ph=+p.predictedHomeScore, pa=+p.predictedAwayScore;
        const pr=ph===pa?'empate':ph>pa?'home':'away';
        let pts=0;
        if(ph===rh&&pa===ra) pts=5;
        else if(pr===rr) pts=3;
        await pd.ref.update({evaluated:true,pointsAwarded:pts,realHome:rh,realAway:ra});
        if(pts>0){
          const upd={points:firebase.firestore.FieldValue.increment(pts)};
          if(pts===5) upd.exactPredictions=firebase.firestore.FieldValue.increment(1);
          if(pts===3) upd.correctResults=firebase.firestore.FieldValue.increment(1);
          await db.collection('users').doc(p.userId).update(upd);
        }
        evaluated++;
      }
    } catch(e){}
  }
  if(evaluated>0) toast(`ğŸ† ${evaluated} predicciones evaluadas`,'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADMIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAdmin() {
  const el=$('screenAdmin');
  el.innerHTML=`
    <div class="section-header"><span class="section-title">âš™ï¸ Admin</span></div>
    <div class="card-glow" style="margin-bottom:16px;">
      <div style="font-family:var(--font-h);font-size:0.8em;color:var(--muted2);margin-bottom:4px;">PANEL ADMIN</div>
      <div style="font-family:var(--font-h);font-size:1.3em;">ğŸ‘‘ ${me.username}</div>
    </div>
    <div class="admin-grid">
      <button class="admin-btn" onclick="adminUsers()">ğŸ‘¥<br>Ver Usuarios</button>
      <button class="admin-btn" onclick="adminEval()">âš¡<br>Evaluar Partidos</button>
      <button class="admin-btn warn" onclick="adminEvalManual()">ğŸ”§<br>Evaluar Manual</button>
      <button class="admin-btn accent" onclick="adminShowGroups()">ğŸ“‹<br>CÃ³digos Grupos</button>
      <button class="admin-btn full" onclick="adminSync()">ğŸ”„ Sincronizar Partidos Ahora</button>
      <button class="admin-btn full danger" onclick="adminReset()">ğŸ—‘ï¸ Borrar Datos</button>
    </div>
    <div class="admin-output" id="adminOut"><span style="color:var(--muted2);">Selecciona una acciÃ³n...</span></div>`;
}

async function adminUsers() {
  const out=$('adminOut');
  out.innerHTML='â³ Cargando...';
  const snap=await db.collection('users').orderBy('playerNumber').get();
  let html=`<div class="big-stat"><span class="big-stat-num">${snap.size}</span><span class="big-stat-label">Jugadores Registrados</span></div>`;
  snap.docs.forEach(d=>{
    const u=d.data();
    html+=`<div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--r-sm);padding:12px;margin-bottom:8px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
        <div>
          <span style="color:var(--muted2);font-size:0.75em;">#${u.playerNumber||'?'}</span>
          <strong style="margin-left:6px;">${u.username}</strong>
          ${u.isAdmin?'ğŸ‘‘':''}
        </div>
        <span style="font-family:var(--font-h);color:var(--primary2);">${u.points||0}pts</span>
      </div>
      <div style="font-size:0.72em;color:var(--muted2);">${u.phoneDisplay||u.phone||'â€”'} Â· Inv: ${u.personalInviteCode}</div>
      <div style="display:flex;gap:6px;margin-top:8px;">
        <button class="btn-wa" style="flex:1;" onclick="adminWA('${u.username}','${u.phone||''}')">ğŸ“² WhatsApp</button>
        <button style="flex:1;padding:9px;background:rgba(245,197,66,0.15);border:1px solid rgba(245,197,66,0.3);color:var(--gold);border-radius:var(--r-sm);font-family:var(--font-b);font-weight:700;font-size:0.75em;cursor:pointer;" onclick="adminResetUserPass('${u.username}','${u.phone||''}','${d.id}')">ğŸ”‘ Reset Clave</button>
      </div>
    </div>`;
  });
  out.innerHTML=html;
}

function adminWA(username, phone) {
  if(!phone){toast('Sin telÃ©fono registrado','error');return;}
  const num=phone.replace(/[^0-9]/g,'');
  const msg=encodeURIComponent(`Hola ${username}! ğŸ‘‹ Te escribimos desde Quiniela Luan âš½`);
  window.open(`https://wa.me/${num}?text=${msg}`,'_blank');
}

async function adminResetUserPass(username, phone, uid) {
  // Generate temp password
  const tempPass = 'Luan' + Math.floor(1000+Math.random()*9000);
  if (!confirm(`Â¿Resetear contraseÃ±a de ${username}?\n\nContraseÃ±a temporal: ${tempPass}\n\nSe la enviarÃ¡s por WhatsApp.`)) return;

  try {
    // Update password using Firebase Auth REST API (client-side trick via re-auth)
    // We store the temp pass request in Firestore â€” user must change on next login
    await db.collection('passResets').doc(uid).set({
      uid, username,
      tempPass,
      requestedBy: me.uid,
      requestedAt: firebase.firestore.FieldValue.serverTimestamp(),
      used: false
    });

    // Send via WhatsApp
    const num = phone.replace(/[^0-9]/g,'');
    const msg = encodeURIComponent(
      `ğŸ”‘ Quiniela Luan â€” Reset de contraseÃ±a\n\n` +
      `Hola ${username}! Tu contraseÃ±a temporal es:\n\n` +
      `*${tempPass}*\n\n` +
      `Entra con esta clave y cÃ¡mbiala desde el menÃº de tu perfil.`
    );
    window.open(`https://wa.me/${num}?text=${msg}`, '_blank');
    toast(`âœ… ContraseÃ±a temporal generada para ${username}`,'success');
  } catch(e) {
    toast('Error: '+e.message,'error');
  }
}

async function adminEval() {
  if(!confirm('Â¿Evaluar todos los partidos finalizados?')) return;
  const out=$('adminOut'); out.innerHTML='â³ Evaluando...';
  try {
    const fsSnap=await db.collection('matches').get();
    if(!fsSnap.empty) allMatches=fsSnap.docs.map(d=>({id:d.id,...d.data()}));
  } catch(e){}
  const fin=allMatches.filter(m=>isFinished(m.status)&&m.homeScore!=null);
  if(!fin.length){out.innerHTML='âš ï¸ Sin partidos finalizados en memoria. Haz Sync primero.';return;}
  let total=0,pts=0;
  for(const match of fin){
    const rh=+match.homeScore,ra=+match.awayScore;
    const rr=rh===ra?'empate':rh>ra?'home':'away';
    const s1=await db.collection('predictions').where('matchId','==',String(match.id)).where('evaluated','==',false).get();
    const s2=await db.collection('predictions').where('matchId','==',match.id).where('evaluated','==',false).get();
    const seen=new Set();const docs=[];
    [s1,s2].forEach(s=>s.docs.forEach(d=>{if(!seen.has(d.id)){seen.add(d.id);docs.push(d);}}));
    for(const pd of docs){
      const p=pd.data();let points=0;
      const ph=+p.predictedHomeScore,pa=+p.predictedAwayScore;
      const pr=ph===pa?'empate':ph>pa?'home':'away';
      if(ph===rh&&pa===ra) points=5;
      else if(pr===rr) points=3;
      pts+=points;
      await pd.ref.update({evaluated:true,pointsAwarded:points,realHome:rh,realAway:ra});
      if(points>0){
        const upd={points:firebase.firestore.FieldValue.increment(points)};
        if(points===5) upd.exactPredictions=firebase.firestore.FieldValue.increment(1);
        if(points===3) upd.correctResults=firebase.firestore.FieldValue.increment(1);
        await db.collection('users').doc(p.userId).update(upd);
      }
      total++;
    }
  }
  out.innerHTML=`âœ… ${total} predicciones evaluadas Â· ${pts} puntos distribuidos`;
}

async function adminEvalManual() {
  const matchesWithScores=allMatches.filter(m=>m.homeScore!=null&&m.awayScore!=null);
  if(!matchesWithScores.length){out.innerHTML='âš ï¸ Sin partidos con resultados en memoria.';return;}
  if(!confirm(`Â¿Evaluar usando ${matchesWithScores.length} partidos con resultados?`)) return;
  const out=$('adminOut'); out.innerHTML='â³ Evaluando...';
  let total=0,pts=0;
  for(const match of matchesWithScores){
    const rh=+match.homeScore,ra=+match.awayScore;
    const rr=rh===ra?'empate':rh>ra?'home':'away';
    const s1=await db.collection('predictions').where('matchId','==',String(match.id)).where('evaluated','==',false).get();
    const s2=await db.collection('predictions').where('matchId','==',match.id).where('evaluated','==',false).get();
    const seen=new Set();const docs=[];
    [s1,s2].forEach(s=>s.docs.forEach(d=>{if(!seen.has(d.id)){seen.add(d.id);docs.push(d);}}));
    for(const pd of docs){
      const p=pd.data();let points=0;
      const ph=+p.predictedHomeScore,pa=+p.predictedAwayScore;
      const pr=ph===pa?'empate':ph>pa?'home':'away';
      if(ph===rh&&pa===ra) points=5;
      else if(pr===rr) points=3;
      pts+=points;
      await pd.ref.update({evaluated:true,pointsAwarded:points,realHome:rh,realAway:ra});
      if(points>0){
        const upd={points:firebase.firestore.FieldValue.increment(points)};
        if(points===5) upd.exactPredictions=firebase.firestore.FieldValue.increment(1);
        if(points===3) upd.correctResults=firebase.firestore.FieldValue.increment(1);
        await db.collection('users').doc(p.userId).update(upd);
      }
      total++;
    }
  }
  out.innerHTML=total?`âœ… ${total} predicciones evaluadas Â· ${pts} puntos`:'âš ï¸ Sin predicciones sin evaluar';
}

async function adminShowGroups() {
  const out=$('adminOut'); out.innerHTML='â³ Cargando...';
  const snap=await db.collection('groups').get();
  if(snap.empty){out.innerHTML='Sin grupos creados';return;}
  let html=`<p style="font-weight:800;margin-bottom:12px;color:var(--primary2);">ğŸ“‹ GRUPOS (${snap.size}/5)</p>`;
  snap.docs.forEach(doc=>{
    const g=doc.data();
    html+=`<div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--r-sm);padding:12px;margin-bottom:8px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <strong>${g.name}</strong>
        <span style="font-family:var(--font-h);font-size:1.4em;color:var(--primary2);letter-spacing:3px;">${g.code}</span>
      </div>
      <div style="font-size:0.75em;color:var(--muted2);margin-bottom:8px;">ğŸ‘¥ ${g.members?.length||0}/${g.maxMembers}</div>
      <div style="display:flex;gap:8px;">
        <button class="btn-wa" style="flex:1;" onclick="shareGroup('${g.code}','${g.name}')">ğŸ“² Compartir WA</button>
        <button class="btn btn-ghost btn-sm" onclick="copyCode('${g.code}','${g.name}')">ğŸ“‹ Copiar</button>
      </div>
    </div>`;
  });
  out.innerHTML=html;
}

function copyCode(code, name) {
  const msg=`Ãšnete a "${name}" en Quiniela Luan âš½\nCÃ³digo: ${code}`;
  navigator.clipboard?.writeText(msg).then(()=>toast('âœ… Copiado','success')).catch(()=>toast(`CÃ³digo: ${code}`,'info',6000));
}

async function adminSync() {
  const out=$('adminOut'); out.innerHTML='â³ Sincronizando...';
  await doSync();
  out.innerHTML=`âœ… Sync completado Â· ${allMatches.length} partidos`;
}

async function adminReset() {
  const opt=confirm('MODO A: Solo predicciones (Aceptar)\nMODO B: Todo (Cancelar)');
  if(opt===null) return;
  if(opt){
    if(!confirm('Â¿Borrar predicciones y resetear puntos?')) return;
    const ps=await db.collection('predictions').get();
    const b=db.batch(); ps.docs.forEach(d=>b.delete(d.ref)); await b.commit();
    const us=await db.collection('users').get();
    const b2=db.batch(); us.docs.forEach(d=>b2.update(d.ref,{points:0,exactPredictions:0,correctResults:0})); await b2.commit();
    toast('âœ… Predicciones borradas','success');
  } else {
    const code=prompt('Escribe BORRAR-TODO para confirmar:');
    if(code!=='BORRAR-TODO'){toast('Cancelado','error');return;}
    for(const col of ['users','predictions','groups','chat']){
      const s=await db.collection(col).get();
      const b=db.batch(); s.docs.forEach(d=>b.delete(d.ref)); await b.commit();
    }
    toast('âœ… Base de datos limpiada','success');
    doLogout();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ONLINE / OFFLINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('online',  ()=>toast('âœ… ConexiÃ³n restaurada','success'));
window.addEventListener('offline', ()=>toast('âš ï¸ Sin conexiÃ³n','warning'));

console.log('%câš½ QUINIELA LUAN V3 â€” REESCRITURA TOTAL','color:#9d7dff;font-size:16px;font-weight:bold;');
</script>
</body>
</html>


