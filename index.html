<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>âš½ Quiniela Luan</title>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@400;600;700;900&display=swap');

:root {
  --bg: #0a0a0f;
  --card: #13131a;
  --card2: #1a1a24;
  --border: #2a2a3a;
  --accent: #7c3aed;
  --accent2: #a855f7;
  --green: #10b981;
  --red: #ef4444;
  --yellow: #f59e0b;
  --blue: #3b82f6;
  --text: #f1f0ff;
  --muted: #6b6b8a;
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

body {
  font-family: 'Outfit', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  padding: 12px;
}

/* TYPOGRAPHY */
.title-font { font-family: 'Bebas Neue', sans-serif; letter-spacing: 2px; }

/* LAYOUT */
.container { max-width: 480px; margin: 0 auto; }
.wide { max-width: 900px; margin: 0 auto; }

/* CARDS */
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 12px;
}

.card-glow {
  background: linear-gradient(135deg, #1a0a2e, #0a0a1e);
  border: 1px solid #3d1a6e;
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 12px;
  box-shadow: 0 0 30px rgba(124,58,237,0.2);
}

/* BUTTONS */
.btn {
  display: block;
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: 12px;
  font-family: 'Outfit', sans-serif;
  font-weight: 700;
  font-size: 0.95em;
  cursor: pointer;
  transition: all 0.2s;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.btn-purple {
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: white;
  box-shadow: 0 4px 20px rgba(124,58,237,0.4);
}
.btn-purple:hover { transform: translateY(-1px); box-shadow: 0 6px 25px rgba(124,58,237,0.5); }

.btn-green {
  background: linear-gradient(135deg, #059669, var(--green));
  color: white;
  box-shadow: 0 4px 15px rgba(16,185,129,0.3);
}

.btn-red {
  background: linear-gradient(135deg, #dc2626, var(--red));
  color: white;
}

.btn-gray {
  background: var(--card2);
  color: var(--muted);
  border: 1px solid var(--border);
}

.btn-sm {
  display: inline-block;
  width: auto;
  padding: 8px 16px;
  font-size: 0.8em;
}

.btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }

/* INPUTS */
.field { margin-bottom: 14px; }
.field label {
  display: block;
  font-size: 0.78em;
  font-weight: 700;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 6px;
}
.field input, .field select, .field textarea {
  width: 100%;
  padding: 12px 14px;
  background: var(--card2);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text);
  font-family: 'Outfit', sans-serif;
  font-size: 0.95em;
  font-weight: 600;
  transition: border-color 0.2s;
}
.field input:focus, .field select:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(124,58,237,0.15);
}

/* ALERTS */
.alert {
  padding: 12px 16px;
  border-radius: 10px;
  font-weight: 700;
  font-size: 0.9em;
  margin-bottom: 14px;
  border-left: 3px solid;
}
.alert-success { background: rgba(16,185,129,0.1); border-color: var(--green); color: var(--green); }
.alert-error { background: rgba(239,68,68,0.1); border-color: var(--red); color: var(--red); }
.alert-info { background: rgba(59,130,246,0.1); border-color: var(--blue); color: var(--blue); }
.alert-warning { background: rgba(245,158,11,0.1); border-color: var(--yellow); color: var(--yellow); }

/* HIDDEN */
.hidden { display: none !important; }

/* NAV TABS */
.tabs {
  display: flex;
  gap: 6px;
  overflow-x: auto;
  padding-bottom: 2px;
  margin-bottom: 14px;
  scrollbar-width: none;
}
.tabs::-webkit-scrollbar { display: none; }
.tab {
  flex-shrink: 0;
  padding: 8px 14px;
  border-radius: 8px;
  background: var(--card2);
  border: 1px solid var(--border);
  color: var(--muted);
  font-weight: 700;
  font-size: 0.8em;
  cursor: pointer;
  transition: all 0.2s;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.tab.active {
  background: var(--accent);
  border-color: var(--accent);
  color: white;
  box-shadow: 0 2px 10px rgba(124,58,237,0.4);
}

/* MATCH CARD */
.match-item {
  background: var(--card2);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px;
  margin-bottom: 10px;
  transition: border-color 0.2s;
}
.match-item:hover { border-color: var(--accent); }
.match-item.live { border-color: var(--red); background: rgba(239,68,68,0.05); }
.match-item.finished { border-color: var(--green); background: rgba(16,185,129,0.05); }

.match-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  font-size: 0.72em;
  font-weight: 700;
  color: var(--muted);
  text-transform: uppercase;
}

.match-teams {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
}

.team-side { text-align: center; }
.team-flag { font-size: 1.8em; display: block; margin-bottom: 4px; }
.team-name { font-size: 0.7em; font-weight: 700; color: var(--muted); text-transform: uppercase; }
.team-score-big { font-family: 'Bebas Neue', sans-serif; font-size: 2.5em; color: var(--accent2); line-height: 1; }

.vs-divider { font-family: 'Bebas Neue', sans-serif; font-size: 1.2em; color: var(--border); }

.score-row {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 12px;
}

.score-box {
  width: 64px;
  height: 64px;
  text-align: center;
  font-family: 'Bebas Neue', sans-serif;
  font-size: 2em;
  background: var(--card);
  border: 2px solid var(--accent);
  border-radius: 10px;
  color: var(--text);
  -moz-appearance: textfield;
}
.score-box::-webkit-outer-spin-button,
.score-box::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
.score-box:focus { outline: none; border-color: var(--accent2); box-shadow: 0 0 0 3px rgba(168,85,247,0.2); }

.score-dash { font-family: 'Bebas Neue', sans-serif; font-size: 1.5em; color: var(--muted); }

/* BADGE */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 8px;
  border-radius: 6px;
  font-size: 0.7em;
  font-weight: 700;
  text-transform: uppercase;
}
.badge-live { background: rgba(239,68,68,0.2); color: var(--red); border: 1px solid var(--red); animation: pulse 2s infinite; }
.badge-done { background: rgba(16,185,129,0.2); color: var(--green); border: 1px solid var(--green); }
.badge-admin { background: rgba(245,158,11,0.2); color: var(--yellow); border: 1px solid var(--yellow); }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.6} }

/* RANKING */
.rank-row {
  display: grid;
  grid-template-columns: 40px 1fr auto auto;
  align-items: center;
  gap: 10px;
  padding: 12px 14px;
  background: var(--card2);
  border: 1px solid var(--border);
  border-radius: 10px;
  margin-bottom: 8px;
  transition: all 0.2s;
}
.rank-row:hover { border-color: var(--accent); }
.rank-row.me { border-color: var(--yellow); background: rgba(245,158,11,0.08); }
.rank-pos { font-family: 'Bebas Neue', sans-serif; font-size: 1.4em; text-align: center; }
.rank-name { font-weight: 700; font-size: 0.9em; }
.rank-exact { font-size: 0.8em; color: var(--muted); text-align: center; }
.rank-pts { font-family: 'Bebas Neue', sans-serif; font-size: 1.6em; color: var(--accent2); }

/* HEADER */
.app-header {
  background: linear-gradient(135deg, #1a0a2e, #0d0d1a);
  border: 1px solid #3d1a6e;
  border-radius: 16px;
  padding: 16px 20px;
  margin-bottom: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* CHAT */
.chat-box {
  background: var(--card2);
  border: 1px solid var(--border);
  border-radius: 12px;
  height: 400px;
  overflow-y: auto;
  padding: 14px;
  margin-bottom: 10px;
  scroll-behavior: smooth;
}
.msg {
  margin-bottom: 10px;
  max-width: 80%;
  animation: fadeIn 0.3s ease;
}
.msg.own { margin-left: auto; text-align: right; }
.msg-bubble {
  display: inline-block;
  padding: 8px 14px;
  border-radius: 14px;
  font-size: 0.88em;
  font-weight: 600;
  word-break: break-word;
}
.msg.own .msg-bubble { background: var(--accent); color: white; border-bottom-right-radius: 4px; }
.msg.other .msg-bubble { background: var(--card); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
.msg-user { font-size: 0.72em; color: var(--muted); margin-bottom: 3px; font-weight: 700; }
.chat-input-row { display: flex; gap: 8px; }
.chat-input-row input {
  flex: 1;
  padding: 12px 14px;
  background: var(--card2);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text);
  font-family: 'Outfit', sans-serif;
  font-weight: 600;
}
.chat-input-row input:focus { outline: none; border-color: var(--accent); }
.chat-send {
  padding: 12px 18px;
  background: var(--accent);
  border: none;
  border-radius: 10px;
  color: white;
  font-size: 1.1em;
  cursor: pointer;
  transition: all 0.2s;
}
.chat-send:hover { background: var(--accent2); }

/* TOAST */
.toast-wrap { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 8px; align-items: center; }
.toast-msg {
  background: var(--card2);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 10px 20px;
  font-weight: 700;
  font-size: 0.88em;
  box-shadow: 0 8px 25px rgba(0,0,0,0.5);
  animation: slideUp 0.3s ease;
  white-space: nowrap;
}
@keyframes slideUp { from{transform:translateY(20px);opacity:0} to{transform:translateY(0);opacity:1} }
@keyframes fadeIn { from{opacity:0} to{opacity:1} }

/* MODAL */
.modal { display:none; position:fixed; z-index:9999; inset:0; background:rgba(0,0,0,0.85); backdrop-filter:blur(8px); overflow-y:auto; padding:20px; }
.modal-box { background:var(--card); border:1px solid var(--border); border-radius:20px; padding:24px; max-width:480px; margin:0 auto; position:relative; }
.modal-close { position:absolute; top:16px; right:16px; background:none; border:none; color:var(--muted); font-size:1.4em; cursor:pointer; }

/* EMPTY */
.empty { text-align:center; padding:40px 20px; color:var(--muted); }
.empty .icon { font-size:3em; margin-bottom:12px; display:block; }

/* DIVIDER */
.divider { border:none; border-top:1px solid var(--border); margin:16px 0; }

/* GRID */
.grid2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }

/* COUNTDOWN */
.countdown-box {
  background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(245,158,11,0.05));
  border: 1px solid rgba(245,158,11,0.3);
  border-radius: 12px;
  padding: 14px 18px;
  margin-bottom: 14px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.countdown-time {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 2.2em;
  color: var(--yellow);
  line-height: 1;
}

/* PREDICTION RESULT */
.pred-item {
  background: var(--card2);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 12px 14px;
  margin-bottom: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
}
.pred-match { font-size: 0.82em; font-weight: 700; flex: 1; }
.pred-score { font-family: 'Bebas Neue', sans-serif; font-size: 1.5em; color: var(--accent2); min-width: 60px; text-align: center; }
.pred-pts { font-size: 0.8em; font-weight: 700; }

/* GROUP CARD */
.group-card {
  background: var(--card2);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 10px;
}

/* ADMIN GRID */
.admin-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:16px; }
.admin-btn {
  padding: 14px;
  border-radius: 10px;
  background: var(--card2);
  border: 1px solid var(--border);
  color: var(--text);
  font-family: 'Outfit', sans-serif;
  font-weight: 700;
  font-size: 0.82em;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
}
.admin-btn:hover { border-color: var(--accent); color: var(--accent2); }

/* VZ TIME */
.vz-time { font-family:'Bebas Neue',sans-serif; font-size:1.3em; color:var(--accent2); }

/* COUNTRY SELECTOR */
.phone-row { display:flex; gap:8px; align-items:stretch; }
.country-btn {
  display:flex; align-items:center; gap:6px;
  padding:12px 10px;
  background:var(--card2); border:1px solid var(--border);
  border-radius:10px; color:var(--text);
  font-weight:700; font-size:0.9em; cursor:pointer;
  white-space:nowrap; min-width:90px;
  transition:border-color 0.2s;
}
.country-btn:hover { border-color:var(--accent); }
.country-dropdown {
  position:absolute; z-index:9999;
  background:var(--card); border:1px solid var(--border);
  border-radius:12px; width:280px; max-height:320px;
  overflow-y:auto; box-shadow:0 8px 30px rgba(0,0,0,0.5);
  margin-top:4px;
}
.country-search {
  padding:10px 14px; background:var(--card2);
  border:none; border-bottom:1px solid var(--border);
  color:var(--text); font-family:'Outfit',sans-serif;
  font-weight:600; width:100%; font-size:0.9em;
}
.country-search:focus { outline:none; }
.country-option {
  padding:10px 14px; cursor:pointer;
  font-size:0.88em; font-weight:600;
  display:flex; align-items:center; gap:10px;
  transition:background 0.15s;
}
.country-option:hover { background:var(--card2); }
.country-option .code { color:var(--accent2); font-weight:700; min-width:45px; }

@media(max-width:400px) {
  .score-box { width:56px; height:56px; font-size:1.7em; }
  .rank-row { grid-template-columns:32px 1fr auto auto; }
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     AUTH SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="authScreen" class="container">
  <div style="text-align:center;padding:40px 0 30px;">
    <div style="font-size:3.5em;margin-bottom:12px;">âš½</div>
    <h1 class="title-font" style="font-size:2.8em;background:linear-gradient(135deg,#a855f7,#7c3aed);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">QUINIELA LUAN</h1>
    <p style="color:var(--muted);font-size:0.85em;margin-top:6px;font-weight:600;">V16 ULTIMATE Â· SISTEMA MULTI-TORNEO</p>
  </div>

  <div id="alertAuth"></div>

  <div class="tabs" style="margin-bottom:20px;">
    <div class="tab active" onclick="showTab('loginTab','loginTabBtn')" id="loginTabBtn">ğŸ”‘ Entrar</div>
    <div class="tab" onclick="showTab('registerTab','registerTabBtn')" id="registerTabBtn">âœ¨ Registro</div>
  </div>

  <!-- LOGIN -->
  <div id="loginTab" class="card">
    <div class="field">
      <label>ğŸ“± TelÃ©fono</label>
      <div class="phone-row">
        <button type="button" id="countryBtnLogin" class="country-btn" onclick="openCountryDropdown('login')">ğŸ‡»ğŸ‡ª +58 â–¾</button>
        <input type="tel" id="loginPhone" placeholder="4141234567" autocomplete="tel" style="flex:1;" onkeydown="if(event.key==='Enter') doLogin()">
      </div>
    </div>
    <div class="field">
      <label>ğŸ”‘ ContraseÃ±a</label>
      <input type="password" id="loginPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" onkeydown="if(event.key==='Enter') doLogin()">
    </div>
    <button class="btn btn-purple" onclick="doLogin()" id="loginBtn">ğŸš€ Iniciar SesiÃ³n</button>
    <p style="text-align:center;margin-top:14px;font-size:0.82em;">
      <a href="#" onclick="showResetPass()" style="color:var(--accent2);font-weight:700;">Â¿Olvidaste tu contraseÃ±a?</a>
    </p>
  </div>

  <!-- REGISTER -->
  <div id="registerTab" class="card hidden">
    <div class="card-glow" style="margin-bottom:14px;padding:12px 16px;">
      <p style="font-size:0.8em;color:var(--yellow);font-weight:700;">ğŸ‘‘ CÃ“DIGO ADMIN: <span style="color:white;">70484251307</span></p>
      <p style="font-size:0.75em;color:var(--muted);margin-top:4px;">Usa este cÃ³digo si eres el administrador. Otros necesitan cÃ³digo de invitaciÃ³n.</p>
    </div>
    <div class="field"><label>ğŸ‘¤ Nombre</label><input type="text" id="regName" placeholder="Luis LÃ¡rez"></div>
    <div class="field"><label>ğŸ“± TelÃ©fono</label>
      <div class="phone-row">
        <button type="button" id="countryBtnReg" class="country-btn" onclick="openCountryDropdown('reg')">ğŸ‡»ğŸ‡ª +58 â–¾</button>
        <input type="tel" id="regPhone" placeholder="4141234567" autocomplete="tel" style="flex:1;">
      </div>
    </div>
    <div class="field"><label>ğŸ® Usuario (mÃ¡x. 8 letras)</label><input type="text" id="regUser" placeholder="alias" autocomplete="username" oninput="this.value=this.value.toUpperCase().slice(0,8)" style="text-transform:uppercase;" maxlength="8"></div>
    <div class="field"><label>ğŸ”‘ ContraseÃ±a</label><input type="password" id="regPass" placeholder="mÃ­nimo 6 caracteres" autocomplete="new-password"></div>
    <div class="field"><label>ğŸ”‘ Confirmar</label><input type="password" id="regPass2" placeholder="repite la contraseÃ±a" autocomplete="new-password"></div>
    <div class="field"><label>ğŸŸï¸ CÃ³digo de acceso</label><input type="text" id="regCode" placeholder="Admin o invitaciÃ³n"></div>
    <div id="regSteps" style="margin-bottom:12px;"></div>
    <button class="btn btn-green" onclick="doRegister()" id="regBtn">âœ¨ Crear Cuenta</button>
    <button class="btn btn-gray" onclick="showTab('loginTab','loginTabBtn')" style="margin-top:8px;">â† Volver</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="mainScreen" class="wide hidden">

  <!-- HEADER -->
  <div class="app-header">
    <div>
      <div style="font-size:0.75em;color:var(--muted);font-weight:700;text-transform:uppercase;">Bienvenido</div>
      <div style="font-weight:900;font-size:1.1em;">
        <span id="hdrPlayerNum" style="color:var(--muted);font-size:0.75em;margin-right:2px;"></span><span id="hdrName">â€”</span>
        <span id="hdrAdmin" class="badge badge-admin hidden" style="margin-left:8px;">ğŸ‘‘ Admin</span>
      </div>
      <div style="font-size:0.75em;color:var(--muted);margin-top:2px;">InvitaciÃ³n: <strong id="hdrCode" style="color:var(--accent2);">â€”</strong></div>
    </div>
    <div style="text-align:right;">
      <div class="vz-time" id="vzTime">00:00:00</div>
      <div style="font-size:0.7em;color:var(--muted);">Venezuela</div>
      <button class="btn btn-red btn-sm" onclick="doLogout()" style="margin-top:6px;width:auto;padding:6px 14px;font-size:0.75em;">ğŸšª Salir</button>
    </div>
  </div>

  <!-- NAV -->
  <div class="tabs">
    <div class="tab active" onclick="showScreen('matches')">âš½ Partidos</div>
    <div class="tab" onclick="showScreen('predictions')">ğŸ¯ Predicciones</div>
    <div class="tab" onclick="showScreen('ranking')">ğŸ“Š Pizarra</div>
    <div class="tab" onclick="showScreen('chat')">ğŸ’¬ Chat</div>
    <div class="tab" onclick="showScreen('tournaments')">ğŸ† Torneos</div>
    <div class="tab" onclick="showScreen('groups')">ğŸ‘¥ Grupos</div>
    <div class="tab hidden" id="adminTab" onclick="showScreen('admin')">âš™ï¸ Admin</div>
  </div>

  <div id="mainAlert"></div>

  <!-- â”€â”€ PARTIDOS â”€â”€ -->
  <div id="matchesScreen">
    <div class="countdown-box">
      <div>
        <div style="font-size:0.72em;color:var(--muted);font-weight:700;text-transform:uppercase;">â° Cierre de predicciones</div>
        <div style="font-size:0.82em;font-weight:700;margin-top:2px;" id="cdMatch">â€”</div>
      </div>
      <div class="countdown-time" id="cdTimer">--:--:--</div>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <h2 class="title-font" style="font-size:1.8em;">PARTIDOS</h2>
      <button class="btn btn-gray btn-sm" onclick="syncAPI()">ğŸ”„ Sync</button>
    </div>
    <div id="matchesList"></div>
    <button class="btn btn-green" onclick="savePreds()" style="margin-top:8px;">ğŸ’¾ Guardar Predicciones</button>
  </div>

  <!-- â”€â”€ PREDICCIONES â”€â”€ -->
  <div id="predictionsScreen" class="hidden">
    <h2 class="title-font" style="font-size:1.8em;margin-bottom:14px;">MIS PREDICCIONES</h2>

    <div class="card" style="margin-bottom:14px;">
      <p style="font-weight:700;margin-bottom:10px;font-size:0.88em;">ğŸ” Ver predicciones de otros jugadores</p>
      <p style="font-size:0.78em;color:var(--muted);margin-bottom:10px;">ğŸ’¡ Tip: Ve a la <strong style="color:var(--accent2);">Pizarra</strong> para ver los apodos exactos de cada jugador.</p>
      <div class="grid2" style="margin-bottom:8px;">
        <div class="field" style="margin:0;"><input type="text" id="su1" placeholder="Jugador 1" oninput="this.value=this.value.toUpperCase()" style="text-transform:uppercase;"></div>
        <div class="field" style="margin:0;"><input type="text" id="su2" placeholder="Jugador 2" oninput="this.value=this.value.toUpperCase()" style="text-transform:uppercase;"></div>
      </div>
      <div class="field" style="margin-bottom:8px;"><input type="text" id="su3" placeholder="Jugador 3 (opcional)" oninput="this.value=this.value.toUpperCase()" style="text-transform:uppercase;"></div>
      <button class="btn btn-purple" onclick="searchPreds()">ğŸ” Buscar</button>
    </div>

    <div id="searchRes" class="hidden"></div>
    <hr class="divider">
    <h3 style="font-weight:800;margin-bottom:12px;font-size:0.95em;">ğŸ“‹ TUS PREDICCIONES</h3>
    <div id="myPredsList"></div>
  </div>

  <!-- â”€â”€ PIZARRA â”€â”€ -->
  <div id="rankingScreen" class="hidden">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
      <h2 class="title-font" style="font-size:1.8em;">PIZARRA</h2>
      <button class="btn btn-gray btn-sm" onclick="loadRanking()">ğŸ”„</button>
    </div>
    <div id="rankingList"></div>
  </div>

  <!-- â”€â”€ CHAT â”€â”€ -->
  <div id="chatScreen" class="hidden">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
      <h2 class="title-font" style="font-size:1.8em;">CHAT GLOBAL</h2>
      <button class="btn btn-red btn-sm hidden" id="clearChatBtn" onclick="clearChat()">ğŸ—‘ï¸ Limpiar</button>
    </div>
    <div class="chat-box" id="chatBox"></div>
    <div class="chat-input-row">
      <input type="text" id="chatInput" placeholder="Escribe un mensaje..." onkeydown="if(event.key==='Enter')sendMsg()">
      <button class="chat-send" onclick="sendMsg()">â¤</button>
    </div>
  </div>

  <!-- â”€â”€ TORNEOS â”€â”€ -->
  <div id="tournamentsScreen" class="hidden">
    <h2 class="title-font" style="font-size:1.8em;margin-bottom:14px;">TORNEOS</h2>
    <div id="tournamentsList"></div>
    <button class="btn btn-green" onclick="saveTournaments()">ğŸ’¾ Guardar selecciÃ³n</button>
  </div>

  <!-- â”€â”€ GRUPOS â”€â”€ -->
  <div id="groupsScreen" class="hidden">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
      <h2 class="title-font" style="font-size:1.8em;">GRUPOS</h2>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-purple btn-sm" onclick="openModal('createGrpModal')">â• Crear</button>
        <button class="btn btn-gray btn-sm" onclick="openModal('joinGrpModal')">ğŸ”— Unirse</button>
      </div>
    </div>
    <div id="groupsList"></div>
  </div>

  <!-- â”€â”€ ADMIN â”€â”€ -->
  <div id="adminScreen" class="hidden">
    <h2 class="title-font" style="font-size:1.8em;margin-bottom:14px;">PANEL ADMIN</h2>
    <div class="admin-grid">
      <button class="admin-btn" onclick="adminUsers()">ğŸ‘¥ Ver Usuarios</button>
      <button class="admin-btn" onclick="adminEval()">âš¡ Evaluar Partidos</button>
      <button class="admin-btn" onclick="adminPoints()">ğŸ¯ Config Puntos</button>
      <button class="admin-btn" onclick="adminReset()">ğŸ—‘ï¸ Borrar Datos</button>
      <button class="admin-btn" onclick="adminEvalManual()" style="grid-column:span 2;border-color:var(--yellow);color:var(--yellow);">ğŸ”§ Evaluar con Resultados Reales (Manual)</button>
      <button class="admin-btn" onclick="adminShowGroups()" style="grid-column:span 2;border-color:var(--accent2);color:var(--accent2);">ğŸ“‹ Ver CÃ³digos de Grupos</button>
      <button class="admin-btn" onclick="adminResetPass()" style="grid-column:span 2;">ğŸ” Recuperar ContraseÃ±a de Usuario</button>
    </div>
    <div id="adminContent"></div>
  </div>

</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- Reset pass -->
<div class="modal" id="resetPassModal">
  <div class="modal-box">
    <button class="modal-close" onclick="closeModal('resetPassModal')">âœ•</button>
    <h3 style="font-weight:900;margin-bottom:16px;">ğŸ” Recuperar ContraseÃ±a</h3>
    <div class="field"><label>ğŸ“± Tu TelÃ©fono</label>
      <div class="phone-row">
        <button type="button" id="countryBtnReset" class="country-btn" onclick="openCountryDropdown('reset')">ğŸ‡»ğŸ‡ª +58 â–¾</button>
        <input type="tel" id="resetPhone" placeholder="4141234567" style="flex:1;">
      </div>
    </div>
    <button class="btn btn-purple" onclick="sendReset()">ğŸ“¤ Enviar enlace</button>
  </div>
</div>

<!-- Create group -->
<div class="modal" id="createGrpModal">
  <div class="modal-box">
    <button class="modal-close" onclick="closeModal('createGrpModal')">âœ•</button>
    <h3 style="font-weight:900;margin-bottom:16px;">ğŸ‘¥ Crear Grupo</h3>
    <div class="field"><label>Nombre del grupo</label><input type="text" id="grpName" placeholder="Ej: Familia PÃ©rez" maxlength="30"></div>
    <div class="field"><label>MÃ¡ximo miembros</label>
      <select id="grpMax"><option value="10">10</option><option value="20" selected>20</option><option value="50">50</option></select>
    </div>
    <button class="btn btn-green" onclick="createGroup()">ğŸ‰ Crear Grupo</button>
  </div>
</div>

<!-- Join group -->
<div class="modal" id="joinGrpModal">
  <div class="modal-box">
    <button class="modal-close" onclick="closeModal('joinGrpModal')">âœ•</button>
    <h3 style="font-weight:900;margin-bottom:8px;">ğŸ”— Unirse a Grupo</h3>
    <p style="font-size:0.82em;color:var(--muted);margin-bottom:16px;">Escribe el cÃ³digo de 6 letras que te compartiÃ³ el admin</p>
    <div class="field">
      <label>CÃ³digo del grupo</label>
      <input type="text" id="grpCode" placeholder="ABC123" maxlength="6"
        style="text-transform:uppercase;font-size:1.4em;text-align:center;letter-spacing:6px;font-weight:900;"
        oninput="this.value=this.value.toUpperCase();$('joinStatus').innerHTML=''">
    </div>
    <div id="joinStatus" style="margin-bottom:12px;min-height:20px;"></div>
    <button class="btn btn-purple" id="joinBtn" onclick="joinGroup()">âœ… Unirse al Grupo</button>
  </div>
</div>

<!-- Group ranking -->
<div class="modal" id="grpRankModal">
  <div class="modal-box">
    <button class="modal-close" onclick="closeModal('grpRankModal')">âœ•</button>
    <h3 style="font-weight:900;margin-bottom:6px;" id="grpRankTitle">ğŸ† Grupo</h3>
    <p style="font-size:0.8em;color:var(--muted);margin-bottom:16px;">CÃ³digo: <strong id="grpRankCode" style="color:var(--accent2);">â€”</strong></p>
    <div id="grpRankList"></div>
  </div>
</div>

<!-- Points config -->
<div class="modal" id="pointsModal">
  <div class="modal-box">
    <button class="modal-close" onclick="closeModal('pointsModal')">âœ•</button>
    <h3 style="font-weight:900;margin-bottom:16px;">ğŸ¯ Configurar Puntos</h3>
    <div class="field"><label>â­ Exacto (puntos)</label>
      <select id="ptExact"></select>
    </div>
    <div class="field"><label>âœ… Resultado correcto (puntos)</label>
      <select id="ptResult"></select>
    </div>
    <button class="btn btn-green" onclick="savePoints()">ğŸ’¾ Guardar</button>
  </div>
</div>

<!-- Toast container -->
<!-- STATS MODAL -->
<div class="modal" id="statsModal">
  <div class="modal-box" style="max-width:520px;">
    <button class="modal-close" onclick="closeModal('statsModal')">âœ•</button>
    <h3 style="font-weight:900;margin-bottom:4px;" id="statsTitle">ğŸ“Š EstadÃ­sticas</h3>
    <p style="font-size:0.78em;color:var(--muted);margin-bottom:16px;" id="statsSubtitle"></p>
    <div id="statsContent"><div class="empty"><span class="icon">â³</span>Cargando...</div></div>
  </div>
</div>

<!-- GROUP SELECTOR MODAL -->
<div class="modal" id="grpSelectorModal">
  <div class="modal-box" style="max-width:400px;">
    <button class="modal-close" onclick="closeModal('grpSelectorModal')">âœ•</button>
    <h3 style="font-weight:900;margin-bottom:8px;">ğŸ‘¥ Â¿Para quÃ© grupo?</h3>
    <p style="font-size:0.82em;color:var(--muted);margin-bottom:16px;">EstÃ¡s en varios grupos. Elige para cuÃ¡l vas a predecir:</p>
    <div id="grpSelectorList"></div>
  </div>
</div>

<!-- WHATSAPP MODAL -->
<div class="modal" id="waModal">
  <div class="modal-box" style="max-width:520px;">
    <button class="modal-close" onclick="closeModal('waModal')">âœ•</button>
    <h3 style="font-weight:900;margin-bottom:4px;">ğŸ“² Enviar por WhatsApp</h3>
    <p style="font-size:0.8em;color:var(--muted);margin-bottom:16px;">Para: <strong id="waRecipient" style="color:var(--accent2);">â€”</strong></p>

    <div style="margin-bottom:14px;">
      <label style="font-size:0.78em;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1px;display:block;margin-bottom:8px;">ğŸ“‹ Mensajes Predefinidos</label>
      <div id="waMsgList" style="display:flex;flex-direction:column;gap:6px;"></div>
    </div>

    <div style="margin-bottom:14px;">
      <label style="font-size:0.78em;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1px;display:block;margin-bottom:6px;">âœï¸ Mensaje Personalizado</label>
      <textarea id="waCustomMsg" rows="4" style="width:100%;padding:12px;background:var(--card2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:'Outfit',sans-serif;font-size:0.88em;resize:vertical;" placeholder="Escribe tu mensaje aquÃ­..."></textarea>
    </div>

    <div style="margin-bottom:14px;">
      <label style="font-size:0.78em;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1px;display:block;margin-bottom:6px;">ğŸ“± NÃºmero WhatsApp (con cÃ³digo de paÃ­s)</label>
      <input type="tel" id="waPhone" placeholder="Ej: 584141234567" style="width:100%;padding:12px;background:var(--card2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:'Outfit',sans-serif;font-size:0.95em;">
      <p style="font-size:0.72em;color:var(--muted);margin-top:4px;">Venezuela: 58 + nÃºmero sin el 0. Ej: 584141234567</p>
    </div>

    <div style="display:flex;gap:8px;">
      <button class="btn btn-green" onclick="sendWhatsApp()" style="flex:1;">ğŸ“² Abrir WhatsApp</button>
      <button class="btn btn-gray" onclick="closeModal('waModal')" style="width:auto;padding:14px 18px;">âœ•</button>
    </div>
  </div>
</div>

<!-- CAMBIAR USERNAME MODAL -->
<div class="modal" id="changeUserModal" style="z-index:99999;">
  <div class="modal-box" style="max-width:400px;">
    <h3 style="font-weight:900;margin-bottom:8px;">âœï¸ Actualiza tu usuario</h3>
    <p style="font-size:0.85em;color:var(--muted);margin-bottom:16px;">Los nombres de usuario ahora tienen mÃ¡ximo <strong style="color:var(--yellow);">8 letras</strong>. El tuyo es muy largo, elige uno nuevo.</p>
    <div class="field">
      <label>ğŸ® Nuevo Usuario (mÃ¡x. 8 letras)</label>
      <input type="text" id="newUsername" placeholder="ALIAS" maxlength="8" oninput="this.value=this.value.toUpperCase().slice(0,8);$('newUsernameCount').textContent=this.value.length+'/8 letras';" style="text-transform:uppercase;font-size:1.2em;text-align:center;letter-spacing:3px;">
      <p style="font-size:0.72em;color:var(--muted);margin-top:4px;" id="newUsernameCount">0/8 letras</p>
    </div>
    <button class="btn btn-green" onclick="saveNewUsername()">âœ… Guardar</button>
  </div>
</div>

<div class="toast-wrap" id="toastWrap"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JAVASCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FIREBASE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FB_CFG = {
  apiKey: "AIzaSyCGfPIf-Q1x90hTne1tCMWNFuS0hio4CtA",
  authDomain: "quiniela-luan-25.firebaseapp.com",
  projectId: "quiniela-luan-25",
  storageBucket: "quiniela-luan-25.firebasestorage.app",
  messagingSenderId: "360325608839",
  appId: "1:360325608839:web:900af9bafc56bbcbfacf22"
};

const ADMIN_CODE = "70484251307";
const API_KEY    = "333289"; // v1 key en URL â€” funciona desde web

firebase.initializeApp(FB_CFG);
const auth = firebase.auth();
const db   = firebase.firestore();
// Persistencia desactivada â€” causaba bloqueos silenciosos en mÃ³vil

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let me = null;
let manualLogin = false;
let allMatches = [];
let dayMatches = [];
let ptsCfg = { exactScore: 5, correctResult: 3 };
let myTournaments = ['champions','europa','bundesliga','ligue1','seriea','premier','laliga'];
let cdInterval = null;
let vzInterval = null;

const TOURNAMENTS = [
  { id:'champions', name:'âš½ Champions League', lid:'4480' },
  { id:'europa',    name:'ğŸŒ Europa League',    lid:'4481' },
  { id:'bundesliga',name:'ğŸ‡©ğŸ‡ª Bundesliga',      lid:'4331' },
  { id:'ligue1',    name:'ğŸ‡«ğŸ‡· Ligue 1',         lid:'4334' },
  { id:'seriea',    name:'ğŸ‡®ğŸ‡¹ Serie A',          lid:'4332' },
  { id:'premier',   name:'ğŸ´ Premier League',   lid:'4328' },
  { id:'laliga',    name:'ğŸ‡ªğŸ‡¸ LaLiga',           lid:'4335' }
];

const FLAGS = {
  'Switzerland':'ğŸ‡¨ğŸ‡­','Mexico':'ğŸ‡²ğŸ‡½','Chile':'ğŸ‡¨ğŸ‡±','Canada':'ğŸ‡¨ğŸ‡¦','South Africa':'ğŸ‡¿ğŸ‡¦',
  'Croatia':'ğŸ‡­ğŸ‡·','Japan':'ğŸ‡¯ğŸ‡µ','Morocco':'ğŸ‡²ğŸ‡¦','Belgium':'ğŸ‡§ğŸ‡ª','Portugal':'ğŸ‡µğŸ‡¹',
  'Italy':'ğŸ‡®ğŸ‡¹','Brazil':'ğŸ‡§ğŸ‡·','South Korea':'ğŸ‡°ğŸ‡·','Germany':'ğŸ‡©ğŸ‡ª','Colombia':'ğŸ‡¨ğŸ‡´',
  'England':'ğŸ´ó §ó ¢ó ¥ó ®ó §ó ¿','Panama':'ğŸ‡µğŸ‡¦','Ireland':'ğŸ‡®ğŸ‡ª','Paraguay':'ğŸ‡µğŸ‡¾','Australia':'ğŸ‡¦ğŸ‡º',
  'Saudi Arabia':'ğŸ‡¸ğŸ‡¦','New Zealand':'ğŸ‡³ğŸ‡¿','United States':'ğŸ‡ºğŸ‡¸','France':'ğŸ‡«ğŸ‡·',
  'Poland':'ğŸ‡µğŸ‡±','Austria':'ğŸ‡¦ğŸ‡¹','Spain':'ğŸ‡ªğŸ‡¸','Argentina':'ğŸ‡¦ğŸ‡·','Venezuela':'ğŸ‡»ğŸ‡ª',
  'Suiza':'ğŸ‡¨ğŸ‡­','MÃ©xico':'ğŸ‡²ğŸ‡½','Costa Rica':'ğŸ‡¨ğŸ‡·','CanadÃ¡':'ğŸ‡¨ğŸ‡¦','SudÃ¡frica':'ğŸ‡¿ğŸ‡¦',
  'Croacia':'ğŸ‡­ğŸ‡·','JapÃ³n':'ğŸ‡¯ğŸ‡µ','Marruecos':'ğŸ‡²ğŸ‡¦','BÃ©lgica':'ğŸ‡§ğŸ‡ª','Qatar':'ğŸ‡¶ğŸ‡¦',
  'TÃºnez':'ğŸ‡¹ğŸ‡³','Honduras':'ğŸ‡­ğŸ‡³','Corea del Sur':'ğŸ‡°ğŸ‡·','Alemania':'ğŸ‡©ğŸ‡ª','PanamÃ¡':'ğŸ‡µğŸ‡¦',
  'Irlanda':'ğŸ‡®ğŸ‡ª','Arabia Saudita':'ğŸ‡¸ğŸ‡¦','Nueva Zelanda':'ğŸ‡³ğŸ‡¿','Estados Unidos':'ğŸ‡ºğŸ‡¸',
  'Francia':'ğŸ‡«ğŸ‡·','Polonia':'ğŸ‡µğŸ‡±','EspaÃ±a':'ğŸ‡ªğŸ‡¸','MalÃ­':'ğŸ‡²ğŸ‡±'
};

const USER_COLORS = ['#7c3aed','#ec4899','#10b981','#f59e0b','#3b82f6','#ef4444','#06b6d4'];
let colorMap = {};
function getColor(uid) {
  if (!colorMap[uid]) colorMap[uid] = USER_COLORS[Object.keys(colorMap).length % USER_COLORS.length];
  return colorMap[uid];
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UTILS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function $(id) { return document.getElementById(id); }

function alert_(msg, type='info', el='mainAlert') {
  const c = $(el);
  if (!c) return;
  c.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
  setTimeout(() => { if(c) c.innerHTML = ''; }, 5000);
}

function toast(msg, type='success') {
  const w = $('toastWrap');
  const t = document.createElement('div');
  const colors = { success:'#10b981', error:'#ef4444', warning:'#f59e0b', info:'#3b82f6' };
  t.className = 'toast-msg';
  t.style.borderLeft = `3px solid ${colors[type]||colors.info}`;
  t.textContent = msg;
  w.appendChild(t);
  setTimeout(() => t.remove(), 3200);
}

function openModal(id) { $(id).style.display = 'block'; }
function closeModal(id) { $(id).style.display = 'none'; }
window.onclick = e => { if (e.target.classList.contains('modal')) e.target.style.display = 'none'; };

function vzTime(utc) {
  if (!utc) return '--:--';
  const [h,m] = utc.split(':').map(Number);
  let vh = h - 4; if (vh < 0) vh += 24;
  return `${String(vh).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
}

function randCode(len=6) { const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let r=''; for(let i=0;i<len;i++) r+=chars[Math.floor(Math.random()*chars.length)]; return r; }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TABS (auth screen)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showTab(tabId, btnId) {
  ['loginTab','registerTab'].forEach(t => $(t).classList.add('hidden'));
  document.querySelectorAll('#authScreen .tab').forEach(b => b.classList.remove('active'));
  $(tabId).classList.remove('hidden');
  $(btnId).classList.add('active');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// COUNTRY SELECTOR
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COUNTRIES = [
  {flag:'ğŸ‡»ğŸ‡ª',name:'Venezuela',code:'+58'},
  {flag:'ğŸ‡ºğŸ‡¸',name:'Estados Unidos',code:'+1'},
  {flag:'ğŸ‡²ğŸ‡½',name:'MÃ©xico',code:'+52'},
  {flag:'ğŸ‡¨ğŸ‡´',name:'Colombia',code:'+57'},
  {flag:'ğŸ‡µğŸ‡ª',name:'PerÃº',code:'+51'},
  {flag:'ğŸ‡¦ğŸ‡·',name:'Argentina',code:'+54'},
  {flag:'ğŸ‡¨ğŸ‡±',name:'Chile',code:'+56'},
  {flag:'ğŸ‡ªğŸ‡¨',name:'Ecuador',code:'+593'},
  {flag:'ğŸ‡§ğŸ‡´',name:'Bolivia',code:'+591'},
  {flag:'ğŸ‡µğŸ‡¾',name:'Paraguay',code:'+595'},
  {flag:'ğŸ‡ºğŸ‡¾',name:'Uruguay',code:'+598'},
  {flag:'ğŸ‡§ğŸ‡·',name:'Brasil',code:'+55'},
  {flag:'ğŸ‡µğŸ‡¦',name:'PanamÃ¡',code:'+507'},
  {flag:'ğŸ‡¨ğŸ‡·',name:'Costa Rica',code:'+506'},
  {flag:'ğŸ‡¬ğŸ‡¹',name:'Guatemala',code:'+502'},
  {flag:'ğŸ‡­ğŸ‡³',name:'Honduras',code:'+504'},
  {flag:'ğŸ‡¸ğŸ‡»',name:'El Salvador',code:'+503'},
  {flag:'ğŸ‡³ğŸ‡®',name:'Nicaragua',code:'+505'},
  {flag:'ğŸ‡©ğŸ‡´',name:'Rep. Dominicana',code:'+1809'},
  {flag:'ğŸ‡¨ğŸ‡º',name:'Cuba',code:'+53'},
  {flag:'ğŸ‡µğŸ‡·',name:'Puerto Rico',code:'+1787'},
  {flag:'ğŸ‡ªğŸ‡¸',name:'EspaÃ±a',code:'+34'},
  {flag:'ğŸ‡µğŸ‡¹',name:'Portugal',code:'+351'},
  {flag:'ğŸ‡¬ğŸ‡§',name:'Reino Unido',code:'+44'},
  {flag:'ğŸ‡©ğŸ‡ª',name:'Alemania',code:'+49'},
  {flag:'ğŸ‡«ğŸ‡·',name:'Francia',code:'+33'},
  {flag:'ğŸ‡®ğŸ‡¹',name:'Italia',code:'+39'},
  {flag:'ğŸ‡³ğŸ‡±',name:'PaÃ­ses Bajos',code:'+31'},
  {flag:'ğŸ‡§ğŸ‡ª',name:'BÃ©lgica',code:'+32'},
  {flag:'ğŸ‡¨ğŸ‡­',name:'Suiza',code:'+41'},
  {flag:'ğŸ‡¦ğŸ‡¹',name:'Austria',code:'+43'},
  {flag:'ğŸ‡¸ğŸ‡ª',name:'Suecia',code:'+46'},
  {flag:'ğŸ‡³ğŸ‡´',name:'Noruega',code:'+47'},
  {flag:'ğŸ‡©ğŸ‡°',name:'Dinamarca',code:'+45'},
  {flag:'ğŸ‡«ğŸ‡®',name:'Finlandia',code:'+358'},
  {flag:'ğŸ‡µğŸ‡±',name:'Polonia',code:'+48'},
  {flag:'ğŸ‡·ğŸ‡º',name:'Rusia',code:'+7'},
  {flag:'ğŸ‡¹ğŸ‡·',name:'TurquÃ­a',code:'+90'},
  {flag:'ğŸ‡¨ğŸ‡¦',name:'CanadÃ¡',code:'+1'},
  {flag:'ğŸ‡¦ğŸ‡º',name:'Australia',code:'+61'},
  {flag:'ğŸ‡¯ğŸ‡µ',name:'JapÃ³n',code:'+81'},
  {flag:'ğŸ‡¨ğŸ‡³',name:'China',code:'+86'},
  {flag:'ğŸ‡®ğŸ‡³',name:'India',code:'+91'},
  {flag:'ğŸ‡¿ğŸ‡¦',name:'SudÃ¡frica',code:'+27'},
  {flag:'ğŸ‡²ğŸ‡¦',name:'Marruecos',code:'+212'},
  {flag:'ğŸ‡¸ğŸ‡¦',name:'Arabia Saudita',code:'+966'},
  {flag:'ğŸ‡¦ğŸ‡ª',name:'Emiratos Ãrabes',code:'+971'},
];

let selectedCountryReg = COUNTRIES[0]; // Venezuela por defecto
let selectedCountryLogin = COUNTRIES[0];
let countryDropdownTarget = null;

function openCountryDropdown(target) {
  // target: 'reg' or 'login'
  countryDropdownTarget = target;
  const existing = document.getElementById('countryDropdown');
  if (existing) { existing.remove(); return; }

  const dropdown = document.createElement('div');
  dropdown.id = 'countryDropdown';
  dropdown.className = 'country-dropdown';
  dropdown.innerHTML = `<input class="country-search" id="countrySearch" placeholder="ğŸ” Buscar paÃ­s..." oninput="filterCountries(this.value)">
    <div id="countryList"></div>`;

  const btn = document.getElementById(target === 'reg' ? 'countryBtnReg' : 'countryBtnLogin');
  btn.parentElement.style.position = 'relative';
  btn.parentElement.appendChild(dropdown);
  setTimeout(() => document.getElementById('countrySearch')?.focus(), 50);
  renderCountryList(COUNTRIES);

  // Close on outside click
  setTimeout(() => {
    document.addEventListener('click', function closeDD(e) {
      if (!dropdown.contains(e.target) && e.target !== btn) {
        dropdown.remove();
        document.removeEventListener('click', closeDD);
      }
    });
  }, 100);
}

function filterCountries(q) {
  const filtered = COUNTRIES.filter(c =>
    c.name.toLowerCase().includes(q.toLowerCase()) || c.code.includes(q)
  );
  renderCountryList(filtered);
}

function renderCountryList(list) {
  const el = document.getElementById('countryList');
  if (!el) return;
  el.innerHTML = '';
  list.forEach(c => {
    const div = document.createElement('div');
    div.className = 'country-option';
    div.innerHTML = `<span>${c.flag}</span><span class="code">${c.code}</span><span>${c.name}</span>`;
    div.onclick = () => {
      if (countryDropdownTarget === 'reg') {
        selectedCountryReg = c;
        document.getElementById('countryBtnReg').innerHTML = `${c.flag} ${c.code} â–¾`;
      } else if (countryDropdownTarget === 'login') {
        selectedCountryLogin = c;
        document.getElementById('countryBtnLogin').innerHTML = `${c.flag} ${c.code} â–¾`;
      } else {
        document.getElementById('countryBtnReset').innerHTML = `${c.flag} ${c.code} â–¾`;
      }
      document.getElementById('countryDropdown')?.remove();
    };
    el.appendChild(div);
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// AUTH â€” REGISTER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doRegister() {
  const name     = $('regName').value.trim();
  const rawPhone = $('regPhone').value.trim().replace(/[^0-9]/g,'');
  const user     = $('regUser').value.trim();
  const pass     = $('regPass').value;
  const pass2    = $('regPass2').value;
  const code     = $('regCode').value.trim();

  if (!name||!rawPhone||!user||!pass||!pass2||!code) {
    alert_('âŒ Completa todos los campos','error','alertAuth'); return;
  }
  if (rawPhone.length < 10) { alert_('âŒ TelÃ©fono invÃ¡lido. Ej: 4141234567','error','alertAuth'); return; }
  if (user.length > 8) { alert_('âŒ Usuario mÃ¡ximo 8 letras','error','alertAuth'); return; }
  if (pass.length < 6) { alert_('âŒ ContraseÃ±a mÃ­nimo 6 caracteres','error','alertAuth'); return; }
  if (pass !== pass2)  { alert_('âŒ Las contraseÃ±as no coinciden','error','alertAuth'); return; }

  const countryCode = selectedCountryReg.code.replace('+','');
  const phone = countryCode + rawPhone.replace(/^0/,'');
  const email = phone + '@quiniela.app';

  const isAdmin = (code === ADMIN_CODE);
  const btn = $('regBtn');
  if (btn.disabled) return; // Gemini fix: evitar doble clic
  btn.disabled = true;

  const steps = $('regSteps');
  const step = (msg, type='info') => { steps.innerHTML = `<div class="alert alert-${type}" style="font-size:0.82em;">${msg}</div>`; };

  try {
    step('â³ Verificando cÃ³digo...');

    // Verificar cÃ³digo (solo si NO es admin)
    if (!isAdmin) {
      try {
        const snap = await db.collection('users')
          .where('personalInviteCode','==', code.toUpperCase())
          .limit(1).get();
        if (snap.empty) {
          step('âŒ CÃ³digo de invitaciÃ³n invÃ¡lido','error');
          btn.disabled = false; return;
        }
      } catch(queryErr) {
        // Si falla la consulta, buscar en todos los usuarios manualmente
        const allUsers = await db.collection('users').get();
        const found = allUsers.docs.find(d => d.data().personalInviteCode === code.toUpperCase());
        if (!found) {
          step('âŒ CÃ³digo de invitaciÃ³n invÃ¡lido','error');
          btn.disabled = false; return;
        }
      }
    }

    // Verificar que el username no exista ya
    step('â³ Verificando nombre de usuario...');
    let finalUsername = user.toUpperCase();
    try {
      const userSnap = await db.collection('users').where('username','==', finalUsername).limit(1).get();
      if (!userSnap.empty) {
        step('âŒ Ese nombre de usuario ya existe. Elige otro.','error');
        btn.disabled = false; return;
      }
    } catch(e) { /* continuar */ }

    step('â³ Creando cuenta en Firebase...');

    // Crear en Auth
    let fbUser;
    try {
      const cred = await auth.createUserWithEmailAndPassword(email, pass);
      fbUser = cred.user;
    } catch(authErr) {
      let msg = 'âŒ Error: ' + authErr.message;
      if (authErr.code==='auth/email-already-in-use') msg = 'âŒ Este email ya estÃ¡ registrado';
      if (authErr.code==='auth/invalid-email') msg = 'âŒ Email invÃ¡lido';
      if (authErr.code==='auth/weak-password') msg = 'âŒ ContraseÃ±a muy dÃ©bil (mÃ­nimo 6 caracteres)';
      step(msg,'error'); btn.disabled=false; return;
    }

    step('â³ Guardando perfil...');

    // Guardar en Firestore â€” con retry
    const invCode = randCode(6);
    // Obtener nÃºmero de jugador (contador total + 1)
    const allUsersSnap = await db.collection('users').get();
    const playerNumber = allUsersSnap.size + 1;
    const data = {
      name, username: finalUsername, phone: '+' + phone, phoneDisplay: selectedCountryReg.flag + ' ' + selectedCountryReg.code + ' ' + rawPhone, email,
      personalInviteCode: invCode,
      isAdmin,
      points: 0, exactPredictions: 0, correctResults: 0,
      invitedBy: isAdmin ? 'MASTER' : code.toUpperCase(),
      tournaments: myTournaments,
      playerNumber,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    let saved = false;
    for (let attempt = 1; attempt <= 3; attempt++) {
      try {
        await db.collection('users').doc(fbUser.uid).set(data);
        saved = true; break;
      } catch(dbErr) {
        if (attempt === 3) {
          step(`âŒ Error Firestore (intento ${attempt}): ${dbErr.code} â€” ${dbErr.message}`,'error');
          btn.disabled = false; return;
        }
        await new Promise(r => setTimeout(r, 1000 * attempt));
      }
    }

    if (!saved) return;

    me = { uid: fbUser.uid, ...data };
    step(`âœ… ${isAdmin ? 'ğŸ‘‘ Â¡ADMIN CREADO!' : 'Â¡Cuenta creada!'} Entrando...`,'success');

    setTimeout(() => enterApp(), 1200);

  } catch(err) {
    step(`âŒ Error inesperado: ${err.message}`,'error');
    btn.disabled = false;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// AUTH â€” LOGIN
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doLogin() {
  const rawPhone = $('loginPhone').value.trim().replace(/[^0-9]/g,'');
  const pass  = $('loginPass').value;

  if (!rawPhone || !pass) { alert_('âŒ Completa telÃ©fono y contraseÃ±a','error','alertAuth'); return; }
  if (rawPhone.length < 10) { alert_('âŒ TelÃ©fono invÃ¡lido','error','alertAuth'); return; }
  const countryCode = selectedCountryReg.code.replace('+','');
  const phone = countryCode + rawPhone.replace(/^0/,'');
  const email = phone + '@quiniela.app';

  const btn = $('loginBtn');
  btn.disabled = true;
  btn.textContent = 'â³ Entrando...';
  alert_('â³ Verificando...','info','alertAuth');
  manualLogin = true;

  try {
    // Login en Firebase Auth
    let fbUser;
    try {
      const cred = await auth.signInWithEmailAndPassword(email, pass);
      fbUser = cred.user;
    } catch(authErr) {
      let msg = 'âŒ Error al iniciar sesiÃ³n';
      const c = authErr.code;
      if (c==='auth/user-not-found'||c==='auth/invalid-credential') msg = 'âŒ Email o contraseÃ±a incorrectos';
      else if (c==='auth/wrong-password') msg = 'âŒ ContraseÃ±a incorrecta';
      else if (c==='auth/too-many-requests') msg = 'âŒ Demasiados intentos. Espera unos minutos.';
      else if (c==='auth/network-request-failed') msg = 'âŒ Sin conexiÃ³n a internet';
      alert_(msg,'error','alertAuth');
      manualLogin = false; btn.disabled=false; btn.textContent='ğŸš€ Iniciar SesiÃ³n'; return;
    }

    // Obtener perfil de Firestore
    let userDoc;
    try {
      userDoc = await db.collection('users').doc(fbUser.uid).get();
    } catch(dbErr) {
      alert_(`âŒ Error cargando perfil: ${dbErr.message}`,'error','alertAuth');
      btn.disabled=false; btn.textContent='ğŸš€ Iniciar SesiÃ³n'; return;
    }

    if (!userDoc.exists) {
      // Usuario en Auth pero sin perfil en Firestore
      alert_('âŒ Perfil no encontrado. Contacta al admin.','error','alertAuth');
      await auth.signOut();
      btn.disabled=false; btn.textContent='ğŸš€ Iniciar SesiÃ³n'; return;
    }

    me = { uid: fbUser.uid, ...userDoc.data() };
    enterApp();

  } catch(err) {
    alert_(`âŒ Error: ${err.message}`,'error','alertAuth');
    manualLogin=false; btn.disabled=false; btn.textContent='ğŸš€ Iniciar SesiÃ³n';
  }
}

// Auto-login SOLO al recargar pÃ¡gina (no durante login manual)
auth.onAuthStateChanged(async user => {
  if (manualLogin) return; // Si estamos en login manual, ignorar
  if (user && !me) {
    try {
      const doc = await db.collection('users').doc(user.uid).get();
      if (doc.exists) { me = { uid: user.uid, ...doc.data() }; enterApp(); }
      else await auth.signOut();
    } catch(e) { /* sin conexiÃ³n, ignorar */ }
  }
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ENTER APP
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function enterApp() {
  $('authScreen').classList.add('hidden');
  $('mainScreen').classList.remove('hidden');

  $('hdrName').textContent = me.username;
  $('hdrCode').textContent = me.personalInviteCode || 'â€”';
  if (me.playerNumber) {
    const hdrNum = document.getElementById('hdrPlayerNum');
    if (hdrNum) hdrNum.textContent = '#' + me.playerNumber;
  }
  if (me.isAdmin) {
    $('hdrAdmin').classList.remove('hidden');
    $('adminTab').classList.remove('hidden');
    $('clearChatBtn').classList.remove('hidden');
  }
  if (me.tournaments) myTournaments = me.tournaments;
  if (!me.isAdmin) {
    const createBtn = document.querySelector('button[onclick*="createGrpModal"]');
    if (createBtn) createBtn.style.display = 'none';
  }

  startVzTime();
  loadPtsCfg();
  syncAPI();
  loadRanking();
  showScreen('matches');
  toast(`ğŸ‰ Â¡Bienvenido ${me.username}!`,'success');

  // Forzar cambio de username si tiene mÃ¡s de 8 letras
  if (me.username && me.username.length > 8) {
    setTimeout(() => openModal('changeUserModal'), 800);
  }
}

async function saveNewUsername() {
  const newUser = $('newUsername').value.trim();
  if (!newUser || newUser.length < 2) { toast('âŒ MÃ­nimo 2 letras','error'); return; }
  if (newUser.length > 8) { toast('âŒ MÃ¡ximo 8 letras','error'); return; }

  // Verificar que no exista
  try {
    const snap = await db.collection('users').where('username','==', newUser).limit(1).get();
    if (!snap.empty) { toast('âŒ Ese usuario ya existe, elige otro','error'); return; }
  } catch(e) {}

  try {
    await db.collection('users').doc(me.uid).update({ username: newUser });
    me.username = newUser;
    $('hdrName').textContent = newUser;
    closeModal('changeUserModal');
    toast(`âœ… Usuario cambiado a ${newUser}`,'success');
  } catch(e) {
    toast(`âŒ Error: ${e.message}`,'error');
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LOGOUT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doLogout() {
  clearInterval(cdInterval);
  clearInterval(vzInterval);
  clearInterval(autoSyncInterval);
  if (chatUnsubscribe) { chatUnsubscribe(); chatUnsubscribe = null; }
  await auth.signOut();
  me = null; allMatches = []; dayMatches = [];
  $('mainScreen').classList.add('hidden');
  $('authScreen').classList.remove('hidden');
  $('loginBtn').disabled = false;
  $('loginBtn').textContent = 'ğŸš€ Iniciar SesiÃ³n';
  alert_('ğŸ‘‹ SesiÃ³n cerrada','info','alertAuth');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RESET PASSWORD
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showResetPass() { openModal('resetPassModal'); }
async function sendReset() {
  const rawPhone = $('resetPhone').value.trim().replace(/[^0-9]/g,'');
  if (!rawPhone || rawPhone.length < 10) { toast('âŒ TelÃ©fono invÃ¡lido','error'); return; }
  const countryCode = selectedCountryReg.code.replace('+','');
  const phone = countryCode + rawPhone.replace(/^0/,'');
  const email = phone + '@quiniela.app';
  try {
    await auth.sendPasswordResetEmail(email);
    toast('âœ… Enlace enviado. Revisa tu correo asociado.','success');
    closeModal('resetPassModal');
  } catch(e) { toast('âŒ TelÃ©fono no registrado','error'); }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// VENEZUELA TIME + COUNTDOWN
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let autoSyncInterval = null;
let userEnteringPreds = false; // Flag: usuario escribiendo predicciones

// Â¿Ya empezÃ³ algÃºn partido del dÃ­a? â†’ apuestas cerradas â†’ se pueden ver predicciones
function bettingClosed() {
  return dayMatches.some(m => isLiveStatus(m.status) || isFinishedStatus(m.status));
}
function startVzTime() {
  const update = () => {
    const now = new Date();
    $('vzTime').textContent = now.toLocaleTimeString('es-VE',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  };
  update();
  vzInterval = setInterval(update, 1000);
  cdInterval = setInterval(updateCountdown, 1000);
  updateCountdown();
  // FIX 2 & 4: Auto-sync cada 60 segundos durante partidos activos
  autoSyncInterval = setInterval(async () => {
    // NO hacer sync si el usuario estÃ¡ escribiendo predicciones
    if (userEnteringPreds) return;
    const hasLive = dayMatches.some(m => isLiveStatus(m.status) || m.status === 'Not Started');
    if (hasLive) {
      await syncAPI();
      const hasInPlay = dayMatches.some(m => m.status === 'In Play');
      if (hasInPlay && $('rankingScreen') && !$('rankingScreen').classList.contains('hidden')) {
        loadRanking();
      }
    }
  }, 30000);
}

function updateCountdown() {
  const el = $('cdTimer'); const mel = $('cdMatch');
  if (!el) return;
  const pending = dayMatches.filter(m => m.status === 'Not Started');
  if (!pending.length) { el.textContent = '-- : -- : --'; return; }
  const first = pending.sort((a,b)=>(a.time||'23:59').localeCompare(b.time||'23:59'))[0];
  mel.textContent = `${first.home} vs ${first.away}`;
  const dt = new Date(`${first.date}T${first.time||'23:59'}`);
  const diff = dt - Date.now() - 4*3600000;
  if (diff <= 0) { el.textContent = 'CERRADO'; return; }
  const h=Math.floor(diff/3600000), m=Math.floor((diff%3600000)/60000), s=Math.floor((diff%60000)/1000);
  el.textContent = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SCREEN NAVIGATION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SCREENS = ['matches','predictions','ranking','chat','tournaments','groups','admin'];
function showScreen(name) {
  SCREENS.forEach(s => $(s+'Screen').classList.add('hidden'));
  document.querySelectorAll('#mainScreen .tabs .tab').forEach(t => t.classList.remove('active'));
  $(name+'Screen').classList.remove('hidden');

  const tabs = [...document.querySelectorAll('#mainScreen .tabs .tab')];
  const map = { matches:0, predictions:1, ranking:2, chat:3, tournaments:4, groups:5, admin:6 };
  if (tabs[map[name]]) tabs[map[name]].classList.add('active');

  if (name==='matches')     refreshMatchesFromFirestore();
  if (name==='predictions') loadMyPreds();
  if (name==='ranking')     loadRanking();
  if (name==='chat')        loadChat();
  if (name==='tournaments') renderTournaments();
  if (name==='groups')      loadGroups();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// REFRESH MATCHES FROM FIRESTORE (sin llamar API)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function refreshMatchesFromFirestore() {
  try {
    const snap = await db.collection('matches').get();
    if (!snap.empty) {
      allMatches = snap.docs.map(d => ({id: d.id, ...d.data()}));
      loadDayMatches();
      // Si hay partidos en vivo en Firestore, hacer sync inmediato para actualizar marcador
      const hasLive = dayMatches.some(m => m.status === 'In Play');
      if (hasLive) syncAPI();
    }
  } catch(e) { /* ignorar si falla */ }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// API SYNC â€” prÃ³ximos Y pasados (DeepSeek fix)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseEvent(ev, t) {
  // Soporta v1 y v2 field names
  const homeScore = ev.intHomeScore ?? ev.homeScore ?? ev.score_home ?? null;
  const awayScore = ev.intAwayScore ?? ev.awayScore ?? ev.score_away ?? null;
  return {
    id: ev.idEvent || ev.id,
    home: ev.strHomeTeam || ev.home_team || ev.homeTeam,
    away: ev.strAwayTeam || ev.away_team || ev.awayTeam,
    homeFlag: FLAGS[ev.strHomeTeam || ev.home_team]||'âš½',
    awayFlag: FLAGS[ev.strAwayTeam || ev.away_team]||'âš½',
    date: ev.dateEvent || ev.date,
    time: ev.strTime || ev.time || '00:00',
    homeScore: homeScore!=null ? +homeScore : null,
    awayScore: awayScore!=null ? +awayScore : null,
    status: ev.strStatus || ev.status || (homeScore!=null ? 'Match Finished' : 'Not Started'),
    statusLabel: (() => {
      const s = (ev.strStatus||'').toUpperCase();
      if (s==='1H') return 'â± 1er Tiempo';
      if (s==='HT') return 'â¸ Medio Tiempo';
      if (s==='2H') return 'â± 2do Tiempo';
      if (s==='ET') return 'â± Tiempo Extra';
      if (s==='P')  return 'ğŸ¥… Penaltis';
      if (s==='FT'||s==='MATCH FINISHED') return 'âœ… Final';
      if (s==='AET') return 'âœ… Final (T. Extra)';
      if (s==='AP'||s==='PEN') return 'âœ… Final (Penaltis)';
      return s;
    })(),
    minute: ev.strProgress || ev.intProgress || ev.minute || null,
    homeGoals: ev.strHomeGoalDetails || '',
    awayGoals: ev.strAwayGoalDetails || '',
    venue: ev.strVenue || ev.venue || 'â€”',
    round: ev.intRound || ev.round || 1,
    tournamentId: t.id, tournamentName: t.name
  };
}

// API v1 â€” key en URL, funciona desde web sin CORS issues
async function apiGet(endpoint) {
  const res = await fetch(`https://www.thesportsdb.com/api/v1/json/${API_KEY}/${endpoint}`);
  if (!res.ok) throw new Error(`API error ${res.status}`);
  return res.json();
}

async function syncAPI() {
  alert_('ğŸ”„ Sincronizando partidos...','info');
  const found = [];
  try {
    for (const t of TOURNAMENTS) {
      if (!myTournaments.includes(t.id)) continue;

      // PrÃ³ximos partidos
      try {
        const dataNext = await apiGet(`eventsnextleague.php?id=${t.lid}`);
        (dataNext?.events || []).forEach(ev => found.push(parseEvent(ev, t)));
      } catch(e) { console.warn('Next:', t.name, e.message); }

      // Partidos pasados â€” para resultados reales
      try {
        const dataPast = await apiGet(`eventspastleague.php?id=${t.lid}`);
        (dataPast?.events || []).forEach(ev => found.push(parseEvent(ev, t)));
      } catch(e) { console.warn('Past:', t.name, e.message); }
    }

    if (found.length) {
      // API devolviÃ³ partidos â€” mergear con lo que hay en Firestore
      const unique = new Map();
      // Primero cargar Firestore (base)
      try {
        const fsSnap = await db.collection('matches').get();
        fsSnap.docs.forEach(d => unique.set(d.id, {id:d.id,...d.data()}));
      } catch(e) {}
      // Luego sobreescribir con datos frescos de API
      found.forEach(m => unique.set(m.id, m));
      allMatches = Array.from(unique.values());
      const b = db.batch();
      found.forEach(m => b.set(db.collection('matches').doc(m.id), m, {merge:true}));
      await b.commit();
      loadDayMatches();
      alert_(`âœ… Partidos actualizados Â· ${found.length} de API + guardados`,'success');
      // Auto-evaluar partidos finalizados
      await autoEvalFinished();
    } else {
      // API no devolviÃ³ nada â€” cargar desde Firestore y actualizar marcadores individualmente
      try {
        const snap = await db.collection('matches').get();
        if (!snap.empty) {
          allMatches = snap.docs.map(d=>({id:d.id,...d.data()}));
          loadDayMatches();
          alert_('ğŸ“‚ Cargando datos guardados Â· Actualizando marcadores...','info');
          // Buscar marcador actual de cada partido por ID
          await refreshLiveScores();
        } else {
          alert_('âš ï¸ Sin partidos. Selecciona torneos y sincroniza.','warning');
        }
      } catch(e2) {
        alert_('âŒ Sin conexiÃ³n y sin datos guardados','error');
      }
    }
  } catch(e) {
    alert_(`âš ï¸ Error API. Cargando datos guardados...`,'warning');
    try {
      const snap = await db.collection('matches').get();
      allMatches = snap.docs.map(d=>({id:d.id,...d.data()}));
      loadDayMatches();
    } catch(e2) { console.error(e2); }
  }
}

async function refreshLiveScores() {
  // Obtener marcador actual de cada partido del dÃ­a via lookupevent
  const nowVZ = new Date(Date.now() - 4*3600000);
  const today = nowVZ.toISOString().split('T')[0];
  const todayMatches = allMatches.filter(m => m.date === today || m.date >= today);
  if (!todayMatches.length) return;

  let updated = 0;
  const batch = db.batch();

  for (const m of todayMatches) {
    try {
      const res = await fetch(`https://www.thesportsdb.com/api/v1/json/${API_KEY}/lookupevent.php?id=${m.id}`);
      if (!res.ok) continue;
      const data = await res.json();
      const ev = data?.events?.[0];
      if (!ev) continue;

      const homeScore = ev.intHomeScore != null ? +ev.intHomeScore : null;
      const awayScore = ev.intAwayScore != null ? +ev.intAwayScore : null;
      const status = ev.strStatus || (homeScore != null ? 'Match Finished' : 'Not Started');
      const minute = ev.strProgress || ev.intProgress || null;
      const homeGoals = ev.strHomeGoalDetails || '';
      const awayGoals = ev.strAwayGoalDetails || '';

      // Actualizar en memoria
      const idx = allMatches.findIndex(x => x.id === m.id);
      if (idx !== -1) {
        allMatches[idx] = { ...allMatches[idx], homeScore, awayScore, status, minute, homeGoals, awayGoals };
        updated++;
      }

      // Guardar en Firestore
      batch.set(db.collection('matches').doc(m.id),
        { homeScore, awayScore, status, minute, homeGoals, awayGoals },
        { merge: true }
      );
    } catch(e) { console.warn('lookupevent fail:', m.id, e.message); }
  }

  if (updated > 0) {
    try { await batch.commit(); } catch(e) {}
    loadDayMatches();
    alert_(`âœ… ${updated} marcadores actualizados`, 'success');
    // Auto-evaluar partidos que terminaron
    await autoEvalFinished();
  } else {
    alert_('ğŸ“‚ Datos guardados cargados', 'info');
  }
}

// EvaluaciÃ³n automÃ¡tica â€” corre despuÃ©s de cada Sync
async function autoEvalFinished() {
  const finished = allMatches.filter(m => isFinishedStatus(m.status) && m.homeScore != null);
  if (!finished.length) return;

  let total = 0, evaluated = 0;
  for (const match of finished) {
    const realHome = +match.homeScore;
    const realAway = +match.awayScore;
    const realResult = realHome === realAway ? 'empate' : realHome > realAway ? 'home' : 'away';

    // Buscar predicciones no evaluadas de este partido (cualquier grupo)
    try {
      const pSnap = await db.collection('predictions')
        .where('matchId', '==', String(match.id))
        .where('evaluated', '==', false)
        .get();

      for (const pd of pSnap.docs) {
        const p = pd.data();
        const predHome = +p.predictedHomeScore;
        const predAway = +p.predictedAwayScore;
        const predResult = predHome === predAway ? 'empate' : predHome > predAway ? 'home' : 'away';
        let points = 0;

        if (predHome === realHome && predAway === realAway) {
          points = 5; // Exacto
        } else if (predResult === realResult) {
          points = 3; // Ganador correcto
        }

        await pd.ref.update({
          evaluated: true,
          pointsAwarded: points,
          realHome, realAway
        });
        evaluated++;
      }
      if (pSnap.size > 0) total += pSnap.size;
    } catch(e) { console.warn('autoEval error:', match.id, e.message); }
  }

  if (evaluated > 0) {
    toast(`ğŸ† ${evaluated} predicciones evaluadas automÃ¡ticamente`, 'success');
  }
}

function loadDayMatches() {
  // Gemini fix: fecha basada en hora Venezuela (UTC-4) para evitar error de medianoche
  const nowVZ = new Date(Date.now() - 4*3600000);
  const today = nowVZ.toISOString().split('T')[0];
  const upcoming = allMatches.filter(m => m.date >= today);
  const pool = upcoming.length
    ? allMatches.filter(m => m.date === [...new Set(upcoming.map(m=>m.date))].sort()[0])
    : allMatches.filter(m => m.date === [...allMatches].sort((a,b)=>b.date.localeCompare(a.date))[0]?.date);
  dayMatches = pool;
  renderMatches(dayMatches);
  updateCountdown();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RENDER MATCHES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderMatches(list) {
  const el = $('matchesList');
  if (!list.length) {
    el.innerHTML = `<div class="empty"><span class="icon">ğŸ“­</span>Sin partidos. Pulsa Sync.</div>`;
    return;
  }

  // Guardar predicciones que el usuario ya escribiÃ³ antes de re-renderizar
  const savedPreds = {};
  list.forEach(m => {
    const hi = $(`hs_${m.id}`), ai = $(`as_${m.id}`);
    if (hi && ai && (hi.value !== '0' || ai.value !== '0')) {
      savedPreds[m.id] = { h: hi.value, a: ai.value };
    }
  });

  const sorted = [...list].sort((a,b)=>(a.time||'23:59').localeCompare(b.time||'23:59'));
  el.innerHTML = '';
  sorted.forEach(m => el.appendChild(buildMatchCard(m)));

  // Restaurar predicciones guardadas
  Object.entries(savedPreds).forEach(([mid, vals]) => {
    const hi = $(`hs_${mid}`), ai = $(`as_${mid}`);
    if (hi) hi.value = vals.h;
    if (ai) ai.value = vals.a;
  });
}

function buildMatchCard(m) {
  const div = document.createElement('div');
  div.className = 'match-item' + (m.status==='In Play'?' live':m.status==='Match Finished'?' finished':'');

  const isLive     = isLiveStatus(m.status);
  const isFinished = isFinishedStatus(m.status);

  const badge = isLive
    ? `<span class="badge badge-live">ğŸ”´ ${m.statusLabel||'En Vivo'}</span>`
    : isFinished
    ? `<span class="badge badge-done">${m.statusLabel||'âœ… Final'}</span>`
    : `<span style="font-family:'Bebas Neue',sans-serif;font-size:1.1em;color:var(--accent2);">â° ${vzTime(m.time)}</span>`;

  // Minuto en vivo si existe
  const minuto = isLive && m.minute ? `<span style="color:var(--red);font-weight:900;font-size:0.82em;">â± ${m.minute}'</span>` : '';

  // Info en vivo: goles si los hay
  const liveGoals = (() => {
    if (!isLive && !isFinished) return '';
    const hg = m.homeGoals || ''; const ag = m.awayGoals || '';
    if (!hg && !ag) return '';
    let g = '<div style="margin-top:8px;font-size:0.75em;">';
    if (hg) hg.split(';').filter(Boolean).forEach(x=>{ g+=`<div style="color:var(--green);font-weight:700;">âš½ ${x.trim()}</div>`; });
    if (ag) ag.split(';').filter(Boolean).forEach(x=>{ g+=`<div style="color:var(--blue);font-weight:700;">âš½ ${x.trim()}</div>`; });
    return g + '</div>';
  })();

  const scoreArea = (isLive || isFinished)
    ? `${liveGoals}
       <div style="text-align:center;margin-top:8px;">
        <button onclick="openStats('${m.id}')" style="background:rgba(124,58,237,0.2);border:1px solid var(--accent);color:var(--accent2);padding:6px 16px;border-radius:8px;font-weight:700;font-size:0.78em;cursor:pointer;">ğŸ“Š EstadÃ­sticas & Goles</button>
       </div>`
    : `<div class="score-row">
        <input type="number" min="0" max="20" value="0" id="hs_${m.id}" class="score-box" oninput="userEnteringPreds=true">
        <span class="score-dash">â€”</span>
        <input type="number" min="0" max="20" value="0" id="as_${m.id}" class="score-box" oninput="userEnteringPreds=true">
       </div>`;

  div.innerHTML = `
    <div class="match-meta">
      <span>${m.tournamentName||'Torneo'}</span>
      <div style="display:flex;align-items:center;gap:8px;">${minuto}${badge}</div>
    </div>
    <div class="match-teams">
      <div class="team-side">
        <span class="team-flag">${m.homeFlag}</span>
        <span class="team-name">${m.home}</span>
        ${isLive||isFinished?`<span class="team-score-big" style="color:${isLive?'var(--red)':'var(--accent2)'};">${m.homeScore??0}</span>`:''}
      </div>
      <div class="vs-divider">${isLive||isFinished?'â€”':'VS'}</div>
      <div class="team-side">
        <span class="team-flag">${m.awayFlag}</span>
        <span class="team-name">${m.away}</span>
        ${isLive||isFinished?`<span class="team-score-big" style="color:${isLive?'var(--red)':'var(--accent2)'};">${m.awayScore??0}</span>`:''}
      </div>
    </div>
    ${scoreArea}`;
  return div;
}

// â”€â”€ ESTADÃSTICAS DEL PARTIDO â”€â”€
async function openStats(matchId) {
  openModal('statsModal');
  const match = allMatches.find(m => m.id === matchId);
  if (match) {
    $('statsTitle').textContent = `${match.homeFlag} ${match.home} ${match.homeScore??0} â€” ${match.awayScore??0} ${match.away} ${match.awayFlag}`;
    $('statsSubtitle').textContent = `${match.tournamentName} Â· ${match.status==='In Play'?'ğŸ”´ EN VIVO':'âœ… Finalizado'}`;
  }
  $('statsContent').innerHTML = `<div class="empty"><span class="icon">â³</span>Cargando estadÃ­sticas...</div>`;
  try {
    const res = await fetch(`https://www.thesportsdb.com/api/v1/json/${API_KEY}/lookupevent.php?id=${matchId}`);
    const data = await res.json();
    const ev = data?.events?.[0];
    if (!ev) { $('statsContent').innerHTML = `<div class="empty"><span class="icon">ğŸ“­</span>Sin estadÃ­sticas disponibles aÃºn</div>`; return; }

    // Timeline de goles
    const goals = [];
    for (let i = 1; i <= 5; i++) {
      const detail = ev[`strGoalDetail${i}`] || ev[`strEvent${i}`];
      if (detail) goals.push(detail);
    }

    // Construir HTML de estadÃ­sticas
    let html = '';

    // Marcador grande
    html += `<div style="text-align:center;background:var(--card2);border-radius:12px;padding:16px;margin-bottom:12px;">
      <div style="font-family:'Bebas Neue',sans-serif;font-size:3em;color:var(--accent2);">${ev.intHomeScore??0} â€” ${ev.intAwayScore??0}</div>
      <div style="font-size:0.78em;color:var(--muted);margin-top:4px;">${ev.strStatus||''} ${ev.strProgress||''}</div>
    </div>`;

    // Goles detallados
    const homeGoals = (ev.strHomeGoalDetails||'').split(';').filter(g=>g.trim());
    const awayGoals = (ev.strAwayGoalDetails||'').split(';').filter(g=>g.trim());

    if (homeGoals.length || awayGoals.length) {
      html += `<div style="margin-bottom:12px;">
        <div style="font-weight:900;font-size:0.82em;color:var(--muted);text-transform:uppercase;margin-bottom:8px;">âš½ Goles</div>`;
      homeGoals.forEach(g => { html += `<div style="background:var(--card2);border-left:3px solid var(--green);padding:8px 12px;border-radius:8px;margin-bottom:6px;font-size:0.85em;font-weight:700;">${match?.homeFlag||'âš½'} ${g.trim()}</div>`; });
      awayGoals.forEach(g => { html += `<div style="background:var(--card2);border-left:3px solid var(--blue);padding:8px 12px;border-radius:8px;margin-bottom:6px;font-size:0.85em;font-weight:700;">${match?.awayFlag||'âš½'} ${g.trim()}</div>`; });
      html += `</div>`;
    }

    // Tarjetas
    const homeYellow = ev.strHomeYellowCards||''; const awayYellow = ev.strAwayYellowCards||'';
    const homeRed = ev.strHomeRedCards||''; const awayRed = ev.strAwayRedCards||'';
    if (homeYellow||awayYellow||homeRed||awayRed) {
      html += `<div style="margin-bottom:12px;"><div style="font-weight:900;font-size:0.82em;color:var(--muted);text-transform:uppercase;margin-bottom:8px;">ğŸŸ¨ Tarjetas</div>`;
      if (homeYellow) homeYellow.split(';').filter(Boolean).forEach(p=>{ html+=`<div style="background:var(--card2);border-left:3px solid var(--yellow);padding:6px 12px;border-radius:8px;margin-bottom:4px;font-size:0.82em;">ğŸŸ¨ ${match?.homeFlag||''} ${p.trim()}</div>`; });
      if (awayYellow) awayYellow.split(';').filter(Boolean).forEach(p=>{ html+=`<div style="background:var(--card2);border-left:3px solid var(--yellow);padding:6px 12px;border-radius:8px;margin-bottom:4px;font-size:0.82em;">ğŸŸ¨ ${match?.awayFlag||''} ${p.trim()}</div>`; });
      if (homeRed) homeRed.split(';').filter(Boolean).forEach(p=>{ html+=`<div style="background:var(--card2);border-left:3px solid var(--red);padding:6px 12px;border-radius:8px;margin-bottom:4px;font-size:0.82em;">ğŸŸ¥ ${match?.homeFlag||''} ${p.trim()}</div>`; });
      if (awayRed) awayRed.split(';').filter(Boolean).forEach(p=>{ html+=`<div style="background:var(--card2);border-left:3px solid var(--red);padding:6px 12px;border-radius:8px;margin-bottom:4px;font-size:0.82em;">ğŸŸ¥ ${match?.awayFlag||''} ${p.trim()}</div>`; });
      html += `</div>`;
    }

    // EstadÃ­sticas generales
    const stats = [
      ['âš½ Tiros al arco', ev.intHomeShots, ev.intAwayShots],
      ['ğŸ PosesiÃ³n', ev.strHomeFormation ? ev.strHomeFormation+' - '+ev.strAwayFormation : null, null],
    ].filter(s=>s[1]);

    if (stats.length) {
      html += `<div style="margin-bottom:12px;"><div style="font-weight:900;font-size:0.82em;color:var(--muted);text-transform:uppercase;margin-bottom:8px;">ğŸ“ˆ Stats</div>`;
      stats.forEach(([label, home, away]) => {
        html += `<div style="background:var(--card2);padding:8px 12px;border-radius:8px;margin-bottom:6px;font-size:0.82em;display:flex;justify-content:space-between;">
          <span style="color:var(--green);font-weight:700;">${home||'â€”'}</span>
          <span style="color:var(--muted);">${label}</span>
          <span style="color:var(--blue);font-weight:700;">${away||'â€”'}</span>
        </div>`;
      });
      html += `</div>`;
    }

    if (!html.includes('Goles') && !html.includes('Tarjetas') && !homeGoals.length) {
      html += `<div class="empty"><span class="icon">â³</span>EstadÃ­sticas detalladas aÃºn no disponibles</div>`;
    }

    $('statsContent').innerHTML = html;
  } catch(e) {
    $('statsContent').innerHTML = `<div class="empty"><span class="icon">âŒ</span>Error cargando: ${e.message}</div>`;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SAVE PREDICTIONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function savePreds() {
  if (!me?.uid) return;
  const jDate = dayMatches[0]?.date;
  if (!jDate) { alert_('âŒ No hay partidos cargados','error'); return; }

  // Recoger predicciones del formulario
  const preds = [];
  dayMatches.forEach(m => {
    const hi = $(`hs_${m.id}`), ai = $(`as_${m.id}`);
    if (hi && ai) preds.push({ matchId:m.id, h:+hi.value||0, a:+ai.value||0, match:m });
  });
  if (!preds.length) { alert_('âŒ Sin partidos disponibles','error'); return; }

  // Obtener grupos del jugador para seleccionar
  const grpSnap = await db.collection('groups').get();
  const myGroups = grpSnap.docs
    .map(d=>({id:d.id,...d.data()}))
    .filter(g=>g.members?.some(m=>m.userId===me.uid));

  if (!myGroups.length) {
    alert_('âŒ No perteneces a ningÃºn grupo. Ãšnete a uno primero.','error'); return;
  }

  // Si solo hay un grupo, usarlo directamente
  let selectedGroup = myGroups[0];
  if (myGroups.length > 1) {
    // Mostrar selector de grupo
    openGroupSelector(myGroups, preds, jDate);
    return;
  }

  await doSavePreds(preds, jDate, selectedGroup);
}

async function doSavePreds(preds, jDate, group) {
  // Verificar si ya tiene predicciones para esta jornada EN ESTE GRUPO
  try {
    const existing = await db.collection('predictions')
      .where('userId','==',me.uid)
      .where('jornadaDate','==',jDate)
      .where('groupId','==',group.id)
      .limit(1).get();
    if (!existing.empty) {
      alert_(`âŒ Ya tienes predicciones para esta jornada en "${group.name}".`,'error');
      return;
    }
  } catch(e) {}

  // Confirmar
  let resumen = `âš½ GRUPO: ${group.name}\n\nTUS PREDICCIONES:\n\n`;
  preds.forEach(p => { resumen += `${p.match.home} ${p.h} - ${p.a} ${p.match.away}\n`; });
  resumen += '\nÂ¿EstÃ¡s seguro? NO podrÃ¡s cambiarlas.';
  if (!confirm(resumen)) return;

  try {
    const b = db.batch();
    preds.forEach(p => {
      const docId = `${me.uid}_${group.id}_${p.matchId}`;
      b.set(db.collection('predictions').doc(docId), {
        userId:me.uid, username:me.username,
        groupId:group.id, groupName:group.name,
        matchId:p.matchId, predictedHomeScore:p.h, predictedAwayScore:p.a,
        home:p.match.home, away:p.match.away,
        homeFlag:p.match.homeFlag, awayFlag:p.match.awayFlag,
        tournamentId:p.match.tournamentId, jornadaDate:jDate,
        evaluated:false, timestamp:firebase.firestore.FieldValue.serverTimestamp()
      });
    });
    await b.commit();
    userEnteringPreds = false;
    toast(`âœ… ${preds.length} predicciones guardadas. Â¡Suerte!`,'success');
    alert_(`âœ… ${preds.length} predicciones guardadas correctamente`,'success');
  } catch(e) { toast(`âŒ Error: ${e.message}`,'error'); }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MY PREDICTIONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadMyPreds() {
  // Admin ve siempre Â· Jugadores solo cuando ya empezÃ³ el primer partido
  const canSearch = me.isAdmin || bettingClosed();
  if ($('searchLocked')) $('searchLocked').classList.toggle('hidden', canSearch);
  if ($('searchUnlocked')) $('searchUnlocked').classList.toggle('hidden', !canSearch);
  // Cambiar mensaje del lock si es jugador normal
  if (!canSearch && $('searchLocked')) {
    $('searchLocked').innerHTML = `
      <div style="font-size:2em;margin-bottom:8px;">ğŸ”’</div>
      <p style="font-weight:700;color:var(--yellow);font-size:0.9em;">Disponible cuando empiece el primer partido</p>
      <p style="font-size:0.78em;color:var(--muted);margin-top:4px;">Las predicciones son visibles una vez iniciados los juegos</p>`;
  }

  const el = $('myPredsList');
  el.innerHTML = `<div class="empty"><span class="icon">â³</span>Cargando...</div>`;
  try {
    const snap = await db.collection('predictions').where('userId','==',me.uid).limit(50).get();
    if (snap.empty) { el.innerHTML=`<div class="empty"><span class="icon">ğŸ“­</span>Sin predicciones aÃºn</div>`; return; }
    const preds = snap.docs.map(d=>({id:d.id,...d.data()}))
      .sort((a,b)=>(b.timestamp?.toDate()||0)-(a.timestamp?.toDate()||0));
    el.innerHTML = '';
    preds.forEach(p => {
      const match = allMatches.find(m=>m.id===p.matchId);
      const div = document.createElement('div');
      div.className = 'pred-item';
      div.innerHTML = `
        <div class="pred-match">${p.homeFlag} ${p.home}<br><span style="color:var(--muted);font-size:0.82em;">vs ${p.away} ${p.awayFlag}</span></div>
        <div class="pred-score">${p.predictedHomeScore}â€“${p.predictedAwayScore}</div>
        ${match&&match.homeScore!=null?`<div style="text-align:center;font-size:0.8em;color:var(--muted);">Real<br><strong style="color:${match.homeScore!=null&&isFinishedStatus(match.status)?'var(--green)':'var(--yellow)'};font-size:1.2em;">${match.homeScore}â€“${match.awayScore}</strong></div>`:''}
        <div class="pred-pts" style="color:${p.evaluated?(p.pointsAwarded>0?'var(--green)':'var(--muted)'):'var(--yellow)'};">
          ${p.evaluated ? (p.pointsAwarded===5?'â­ 5pts':p.pointsAwarded===3?'ğŸ¯ 3pts':'âŒ 0pts') : (match&&isFinishedStatus(match.status)?'â³ Evaluando...':'ğŸ”’ En juego')}
        </div>`;
      el.appendChild(div);
    });
  } catch(e) { el.innerHTML=`<div class="empty"><span class="icon">âŒ</span>${e.message}</div>`; }
}

// SEARCH OTHER PLAYERS
async function searchPreds() {
  const names = [$('su1'),$('su2'),$('su3')].map(i=>i.value.trim()).filter(Boolean);
  if (!names.length) { toast('âŒ Escribe al menos un nombre','error'); return; }
  const el = $('searchRes');
  el.classList.remove('hidden');
  el.innerHTML = `<div class="empty"><span class="icon">â³</span>Buscando...</div>`;
  let html = '';
  for (const uname of names) {
    let snap = await db.collection('users').where('username','==',uname).limit(1).get();
    if (snap.empty) snap = await db.collection('users').where('username','==',uname.toLowerCase()).limit(1).get();
    if (snap.empty) { html+=`<div class="card" style="border-color:var(--red);margin-bottom:10px;"><p style="color:var(--red);font-weight:700;">âŒ "${uname}" no encontrado</p></div>`; continue; }
    const user={id:snap.docs[0].id,...snap.docs[0].data()};
    const color=getColor(user.id);
    const ps=await db.collection('predictions').where('userId','==',user.id).limit(30).get();
    html+=`<div class="card" style="border-left:3px solid ${color};margin-bottom:10px;">
      <div style="display:flex;justify-content:space-between;margin-bottom:12px;">
        <strong style="color:${color};">ğŸ‘¤ ${user.username}</strong>
        <span style="background:${color};color:white;padding:3px 10px;border-radius:6px;font-size:0.82em;font-weight:700;">${user.points||0} pts</span>
      </div>`;
    if (ps.empty) { html+=`<p style="color:var(--muted);font-size:0.85em;">Sin predicciones</p>`; }
    else {
      ps.docs.map(d=>({id:d.id,...d.data()})).forEach(p=>{
        const m=allMatches.find(x=>x.id===p.matchId);
        html+=`<div class="pred-item" style="border-color:${color}30;">
          <div class="pred-match">${p.homeFlag} ${p.home} <span style="color:var(--muted);">vs</span> ${p.away} ${p.awayFlag}</div>
          <div class="pred-score" style="color:${color};">${p.predictedHomeScore}â€“${p.predictedAwayScore}</div>
          ${m&&m.homeScore!=null?`<div style="font-size:0.8em;text-align:center;color:var(--green);">Real<br><strong>${m.homeScore}â€“${m.awayScore}</strong></div>`:''}
        </div>`;
      });
    }
    html+=`</div>`;
  }
  el.innerHTML = html || `<div class="empty"><span class="icon">ğŸ”</span>Sin resultados</div>`;
  el.scrollIntoView({behavior:'smooth'});
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RANKING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadRanking() {
  const el = $('rankingList');
  el.innerHTML = `<div class="empty"><span class="icon">â³</span>Cargando...</div>`;
  try {
    const snap = await db.collection('users').orderBy('points','desc').limit(50).get();
    if (snap.empty) { el.innerHTML=`<div class="empty"><span class="icon">ğŸ“­</span>Sin jugadores aÃºn</div>`; return; }
    el.innerHTML='';
    snap.docs.forEach((doc,i)=>{
      const u=doc.data(); const isMe=doc.id===me.uid;
      const medal=i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':`#${i+1}`;
      const div=document.createElement('div');
      div.className='rank-row'+(isMe?' me':'');
      div.innerHTML=`
        <div class="rank-pos" style="color:${i<3?'var(--yellow)':'var(--muted)'};">${medal}</div>
        <div class="rank-name">${u.username}${isMe?' <span style="font-size:0.75em;color:var(--yellow);">(TÃš)</span>':''}</div>
        <div class="rank-exact" title="Exactos">${u.exactPredictions||0} â­</div>
        <div class="rank-pts">${u.points||0}</div>`;
      el.appendChild(div);
    });
  } catch(e) { el.innerHTML=`<div class="empty"><span class="icon">âŒ</span>${e.message}</div>`; }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CHAT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let chatUnsubscribe = null;
function loadChat() {
  const box = $('chatBox');
  box.innerHTML = `<div class="empty" style="padding:20px;"><span class="icon" style="font-size:2em;">â³</span>Cargando...</div>`;
  // Gemini fix: onSnapshot para chat en tiempo real
  if (chatUnsubscribe) chatUnsubscribe();
  chatUnsubscribe = db.collection('chat').orderBy('timestamp','asc').limitToLast(60)
    .onSnapshot(snap => {
      box.innerHTML='';
      if (snap.empty) { box.innerHTML=`<div class="empty" style="padding:20px;"><span class="icon" style="font-size:2em;">ğŸ’¬</span>Sin mensajes aÃºn</div>`; return; }
      snap.forEach(d=>{
        const msg=d.data();
        const isOwn=msg.userId===me.uid;
        const color=msg.userColor||getColor(msg.userId);
        const div=document.createElement('div');
        div.className=`msg ${isOwn?'own':'other'}`;
        div.innerHTML=`${!isOwn?`<div class="msg-user" style="color:${color};">${msg.username}</div>`:''}
          <div class="msg-bubble">${msg.message}</div>`;
        box.appendChild(div);
      });
      box.scrollTop=box.scrollHeight;
    }, e => { console.error(e); });
}

async function sendMsg() {
  const input=$('chatInput'); const msg=input.value.trim();
  if (!msg) return;
  try {
    await db.collection('chat').add({
      userId:me.uid, username:me.username, message:msg,
      userColor:getColor(me.uid),
      timestamp:firebase.firestore.FieldValue.serverTimestamp()
    });
    input.value='';
  } catch(e) { toast('âŒ Error enviando','error'); }
}

async function clearChat() {
  if (!me.isAdmin||!confirm('Â¿Limpiar todo el chat?')) return;
  const snap=await db.collection('chat').get();
  const b=db.batch(); snap.docs.forEach(d=>b.delete(d.ref)); await b.commit();
  await loadChat(); toast('âœ… Chat limpiado','success');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TOURNAMENTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTournaments() {
  const el=$('tournamentsList'); el.innerHTML='';
  TOURNAMENTS.forEach(t=>{
    const sel=myTournaments.includes(t.id);
    const div=document.createElement('div');
    div.className='group-card';
    div.style.borderColor=sel?'var(--accent)':'var(--border)';
    div.style.cursor='pointer';
    div.onclick=()=>{
      const idx=myTournaments.indexOf(t.id);
      if(idx>-1) myTournaments.splice(idx,1); else myTournaments.push(t.id);
      renderTournaments();
    };
    div.innerHTML=`<div style="display:flex;align-items:center;gap:12px;">
      <div style="width:20px;height:20px;border-radius:4px;background:${sel?'var(--accent)':'var(--border)'};display:flex;align-items:center;justify-content:center;font-size:0.75em;">${sel?'âœ“':''}</div>
      <span style="font-weight:700;">${t.name}</span>
    </div>`;
    el.appendChild(div);
  });
}

async function saveTournaments() {
  try {
    await db.collection('users').doc(me.uid).update({tournaments:myTournaments});
    toast(`âœ… ${myTournaments.length} torneos guardados`,'success');
    await syncAPI();
  } catch(e) { toast('âŒ Error','error'); }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// GROUPS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openGroupSelector(groups, preds, jDate) {
  const list = $('grpSelectorList');
  list.innerHTML = '';
  groups.forEach(g => {
    const btn = document.createElement('button');
    btn.style.cssText = 'width:100%;padding:14px;background:var(--card2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:Outfit,sans-serif;font-weight:700;font-size:0.9em;cursor:pointer;margin-bottom:8px;text-align:left;';
    btn.innerHTML = `ğŸ‘¥ ${g.name} <span style="color:var(--muted);font-size:0.78em;">Â· ${g.members?.length||0} jugadores</span>`;
    btn.onclick = async () => {
      closeModal('grpSelectorModal');
      await doSavePreds(preds, jDate, g);
    };
    list.appendChild(btn);
  });
  openModal('grpSelectorModal');
}

async function loadGroups() {
  const el=$('groupsList');
  el.innerHTML=`<div class="empty"><span class="icon">â³</span>Cargando...</div>`;
  try {
    // Refrescar datos del usuario para asegurar isAdmin actualizado
    try {
      const freshDoc = await db.collection('users').doc(me.uid).get();
      if (freshDoc.exists) me = { uid: me.uid, ...freshDoc.data() };
    } catch(e2) {}
    const snap=await db.collection('groups').get();
    el.innerHTML = me.isAdmin
      ? `<div style="background:rgba(245,158,11,0.1);border:1px solid var(--yellow);border-radius:8px;padding:8px 12px;margin-bottom:10px;font-size:0.78em;color:var(--yellow);font-weight:700;">ğŸ‘‘ Admin â€” ves todos los grupos</div>`
      : '';
    let found=0;
    snap.forEach(doc=>{
      const g=doc.data();
      if (!me.isAdmin && !g.members?.some(m=>m.userId===me.uid)) return;
      found++;
      const isMember=g.members?.some(m=>m.userId===me.uid);
      const isGrpAdmin=g.members?.find(m=>m.userId===me.uid)?.isAdmin;
      const div=document.createElement('div');
      div.className='group-card';
      div.innerHTML=`
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <strong style="font-size:1.05em;">${g.name}</strong>
          <div style="display:flex;gap:6px;align-items:center;">
            ${isGrpAdmin?`<span class="badge badge-admin">ğŸ‘‘</span>`:''}
            ${(me.isAdmin===true||me.isAdmin==="true")?`<button onclick="deleteGroup('${doc.id}','${g.name}')" style="background:rgba(239,68,68,0.2);border:1px solid var(--red);color:var(--red);padding:4px 10px;border-radius:6px;font-size:0.75em;font-weight:700;cursor:pointer;">ğŸ—‘ï¸ Borrar</button>`:''}
          </div>
        </div>
        <p style="font-size:0.82em;color:var(--muted);margin-bottom:10px;">ğŸ” CÃ³digo: <strong style="color:var(--accent2);">${g.code}</strong> Â· ğŸ‘¥ ${g.members?.length||0}/${g.maxMembers}</p>
        <button class="btn btn-purple" style="font-size:0.82em;padding:10px;" onclick="viewGroup('${doc.id}')">ğŸ† Ver ClasificaciÃ³n</button>`;
      el.appendChild(div);
    });
    if (!found) el.innerHTML=`<div class="empty"><span class="icon">ğŸ‘¥</span>No hay grupos aÃºn</div>`;
  } catch(e) { el.innerHTML=`<div class="empty"><span class="icon">âŒ</span>${e.message}</div>`; }
}

async function deleteGroup(gid, gname) {
  if (!me.isAdmin) return;
  if (!confirm(`Â¿Borrar el grupo "${gname}"? Esta acciÃ³n no se puede deshacer.`)) return;
  try {
    await db.collection('groups').doc(gid).delete();
    toast(`âœ… Grupo "${gname}" eliminado`,'success');
    loadGroups();
  } catch(e) {
    toast(`âŒ Error: ${e.message}`,'error');
  }
}

async function viewGroup(gid) {
  const gdoc = await db.collection('groups').doc(gid).get();
  const g = gdoc.data();
  $('grpRankTitle').textContent = `ğŸ† ${g.name}`;
  $('grpRankCode').textContent = g.code;
  const el = $('grpRankList');
  el.innerHTML = `<div class="empty"><span class="icon">â³</span>Calculando pizarra...</div>`;
  openModal('grpRankModal');

  const memberIds = g.members.map(m => m.userId);
  const pointsMap = {};
  memberIds.forEach(id => { pointsMap[id] = {pts:0, exact:0, correct:0}; });

  try {
    // Leer predicciones evaluadas â€” con groupId (nuevas) Y sin groupId (viejas)
    // Para cada miembro, buscar sus predicciones evaluadas
    for (const uid of memberIds) {
      try {
        const pSnap = await db.collection('predictions')
          .where('userId','==', uid)
          .where('evaluated','==', true)
          .get();
        pSnap.docs.forEach(d => {
          const p = d.data();
          // Incluir si: tiene el groupId de este grupo, O no tiene groupId (predicciÃ³n vieja)
          const belongsHere = !p.groupId || p.groupId === gid;
          if (!belongsHere) return;
          if (!pointsMap[uid]) pointsMap[uid] = {pts:0, exact:0, correct:0};
          const pts = p.pointsAwarded || 0;
          pointsMap[uid].pts += pts;
          if (pts === 5) pointsMap[uid].exact++;
          else if (pts === 3) pointsMap[uid].correct++;
        });
      } catch(e) { console.warn('preds error:', uid, e.message); }
    }

    // Leer datos de usuarios â€” en chunks de 10 (lÃ­mite Firestore)
    const allUsers = [];
    for (let i = 0; i < memberIds.length; i += 10) {
      const chunk = memberIds.slice(i, i+10);
      const uSnap = await db.collection('users')
        .where(firebase.firestore.FieldPath.documentId(),'in',chunk).get();
      uSnap.docs.forEach(d => allUsers.push({id:d.id,...d.data()}));
    }

    const users = allUsers
      .map(u=>({...u,
        grpPts: pointsMap[u.id]?.pts || 0,
        grpExact: pointsMap[u.id]?.exact || 0,
        grpCorrect: pointsMap[u.id]?.correct || 0
      }))
      .sort((a,b) => b.grpPts - a.grpPts || b.grpExact - a.grpExact);

    el.innerHTML = '';

    // Header con info del grupo
    const header = document.createElement('div');
    header.style.cssText = 'background:var(--card2);border-radius:10px;padding:10px 14px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;font-size:0.8em;';
    header.innerHTML = `<span style="color:var(--muted);">ğŸ‘¥ ${memberIds.length} jugadores</span><span style="color:var(--accent2);font-weight:700;">ğŸ” ${g.code}</span>`;
    el.appendChild(header);

    users.forEach((u,i) => {
      const isMe = u.id === me.uid;
      const medal = i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':`#${i+1}`;
      const div = document.createElement('div');
      div.className = 'rank-row'+(isMe?' me':'');
      div.innerHTML = `
        <div class="rank-pos" style="color:${i<3?'var(--yellow)':'var(--muted)'};">${medal}</div>
        <div class="rank-name">
          ${u.username}${isMe?' <span style="color:var(--accent2);font-size:0.75em;">(TÃš)</span>':''}
          <div style="font-size:0.7em;color:var(--muted);">â­${u.grpExact} exactos Â· ğŸ¯${u.grpCorrect} correctos</div>
        </div>
        <div class="rank-pts" style="font-size:1.3em;">${u.grpPts}</div>`;
      el.appendChild(div);
    });

    if (!users.length) el.innerHTML += `<div class="empty"><span class="icon">ğŸ“­</span>Sin jugadores en este grupo</div>`;
  } catch(e) {
    el.innerHTML = `<div class="empty"><span class="icon">âŒ</span>${e.message}</div>`;
  }
}


async function createGroup() {
  if (!me || !me.isAdmin) { toast('âŒ Solo el admin puede crear grupos','error'); closeModal('createGrpModal'); return; }
  const name=$('grpName').value.trim(), max=$('grpMax').value;
  if (!name) { toast('âŒ Nombre requerido','error'); return; }
  // MÃ¡ximo 5 grupos en toda la app
  const totalGroups = await db.collection('groups').get();
  if (totalGroups.size >= 5) {
    toast('âŒ MÃ¡ximo 5 grupos permitidos. Borra uno antes de crear otro.','error');
    return;
  }
  const btn = document.querySelector('#createGrpModal .btn-green');
  if (btn) btn.disabled = true;
  try {
    const code=randCode(6);
    await db.collection('groups').add({
      name, code, maxMembers:+max,
      createdBy:me.uid, createdAt:new Date().toISOString(),
      members:[{userId:me.uid,username:me.username,joinedAt:new Date().toISOString(),isAdmin:true}]
    });
    closeModal('createGrpModal');
    $('grpName').value = '';
    // Mostrar cÃ³digo en toast largo
    toast(`âœ… Grupo "${name}" creado Â· CÃ³digo: ${code}`,'success');
    // Mostrar automÃ¡ticamente la lista de grupos con cÃ³digos
    adminShowGroups();
    loadGroups();
  } catch(e) {
    toast(`âŒ Error creando grupo: ${e.message}`,'error');
  } finally {
    if (btn) btn.disabled = false;
  }
}

async function joinGroup() {
  const code = $('grpCode').value.trim().toUpperCase();
  const statusEl = $('joinStatus');
  const btn = $('joinBtn');

  const setStatus = (msg, type='info') => {
    const colors = { info:'var(--blue)', success:'var(--green)', error:'var(--red)', warning:'var(--yellow)' };
    statusEl.innerHTML = `<div style="padding:10px 14px;background:rgba(0,0,0,0.2);border-left:3px solid ${colors[type]};border-radius:8px;font-weight:700;font-size:0.88em;color:${colors[type]};">${msg}</div>`;
  };

  if (code.length !== 6) { setStatus('âŒ El cÃ³digo debe tener 6 caracteres','error'); return; }

  btn.disabled = true;
  setStatus('ğŸ” Buscando grupo...','info');

  try {
    const snap = await db.collection('groups').where('code','==',code).limit(1).get();

    if (snap.empty) {
      setStatus('âŒ CÃ³digo incorrecto. Verifica con el admin que te invitÃ³.','error');
      btn.disabled = false; return;
    }

    const gdoc = snap.docs[0];
    const g = gdoc.data();

    if (g.members.some(m => m.userId === me.uid)) {
      setStatus(`âœ… Ya eres miembro de "${g.name}"`, 'success');
      setTimeout(() => closeModal('joinGrpModal'), 1500);
      btn.disabled = false; return;
    }

    if (g.members.length >= g.maxMembers) {
      setStatus(`âŒ El grupo "${g.name}" estÃ¡ lleno (${g.members.length}/${g.maxMembers})`, 'error');
      btn.disabled = false; return;
    }

    setStatus(`âœ… Grupo encontrado: "${g.name}" Â· ${g.members.length}/${g.maxMembers} jugadores`, 'success');

    await gdoc.ref.update({ members: firebase.firestore.FieldValue.arrayUnion({
      userId: me.uid, username: me.username,
      joinedAt: new Date().toISOString(), isAdmin: false
    })});

    $('grpCode').value = '';

    // Mostrar pantalla de bienvenida al grupo
    setStatus(`ğŸ‰ Â¡Bienvenido a "${g.name}"! Ya puedes ver la clasificaciÃ³n del grupo.`, 'success');
    setTimeout(() => {
      closeModal('joinGrpModal');
      toast(`ğŸ‰ Â¡Entraste a "${g.name}"!`, 'success');
      loadGroups();
    }, 2000);

  } catch(e) {
    setStatus(`âŒ Error de conexiÃ³n: ${e.message}`, 'error');
    btn.disabled = false;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// POINTS CONFIG
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPtsCfg() {
  try {
    const doc=await db.collection('system').doc('pointsConfig').get();
    if (doc.exists) ptsCfg={...ptsCfg,...doc.data()};
  } catch(e) { /* usa defaults */ }
}

function adminPoints() {
  const es=$('ptExact'), rs=$('ptResult');
  es.innerHTML=''; rs.innerHTML='';
  for(let i=2;i<=10;i++){const o=document.createElement('option');o.value=i;o.textContent=`${i} pts`;if(i===ptsCfg.exactScore)o.selected=true;es.appendChild(o);}
  for(let i=1;i<=9;i++){const o=document.createElement('option');o.value=i;o.textContent=`${i} pts`;if(i===ptsCfg.correctResult)o.selected=true;rs.appendChild(o);}
  openModal('pointsModal');
}

async function savePoints() {
  ptsCfg={exactScore:+$('ptExact').value, correctResult:+$('ptResult').value};
  await db.collection('system').doc('pointsConfig').set(ptsCfg);
  toast('âœ… Puntos guardados','success');
  closeModal('pointsModal');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ADMIN FUNCTIONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function adminUsers() {
  const el=$('adminContent');
  el.innerHTML=`<div class="empty"><span class="icon">â³</span>Cargando...</div>`;
  const snap=await db.collection('users').orderBy('points','desc').get();

  // Construir pizarra actual para incluir en mensajes
  let pizarra = 'ğŸ“Š *PIZARRA QUINIELA LUAN*\n';
  pizarra += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
  snap.docs.forEach((doc,i) => {
    const u=doc.data();
    const medal = i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':`#${i+1}`;
    pizarra += `${medal} ${u.username} â€” *${u.points||0} pts* (â­${u.exactPredictions||0} exactos)\n`;
  });
  pizarra += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
  pizarra += 'âš½ _Quiniela Luan_';

  window._pizarraText = pizarra;

  let html=`<div style="background:rgba(124,58,237,0.15);border:1px solid var(--accent);border-radius:10px;padding:12px 16px;margin-bottom:14px;text-align:center;"><span style="font-family:'Bebas Neue',sans-serif;font-size:2em;color:var(--accent2);">${snap.size}</span><span style="font-weight:700;color:var(--muted);font-size:0.88em;margin-left:8px;">JUGADORES REGISTRADOS</span></div>`;
  snap.docs.forEach((doc,i)=>{
    const u=doc.data();
    const medal=i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':`#${i+1}`;
    html+=`<div style="background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:12px 14px;margin-bottom:8px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <div>
          <div style="font-weight:700;font-size:0.9em;">
            <span style="color:var(--muted);font-size:0.8em;margin-right:6px;">#${u.playerNumber||'?'}</span>
            ${u.username} ${u.isAdmin?'ğŸ‘‘':''}
          </div>
          <div style="font-size:0.72em;color:var(--muted);">${u.phoneDisplay||u.phone||u.email} Â· Inv: <strong>${u.personalInviteCode}</strong></div>
        </div>
        <div style="text-align:right;">
          <div style="font-family:'Bebas Neue',sans-serif;font-size:1.4em;color:var(--accent2);">${u.points||0}</div>
          <div style="font-size:0.7em;color:var(--muted);">â­${u.exactPredictions||0} exactos</div>
        </div>
      </div>
      <button onclick="openWA('${u.username}', '${u.phone||''}')" style="width:100%;padding:8px;background:rgba(37,211,102,0.15);border:1px solid #25d366;color:#25d366;border-radius:8px;font-weight:700;font-size:0.78em;cursor:pointer;">ğŸ“² Enviar WhatsApp</button>
    </div>`;
  });
  el.innerHTML=html;
}

function openWA(username, phone) {
  $('waRecipient').textContent = username;
  // Pre-llenar telÃ©fono sin el + para wa.me
  $('waPhone').value = phone ? phone.replace('+','') : '';
  $('waCustomMsg').value = '';

  const pizarra = window._pizarraText || 'ğŸ“Š Pizarra no disponible';

  // Mensajes predefinidos
  const mensajes = [
    {
      label: 'ğŸ“Š Enviar Pizarra',
      texto: `Hola ${username}! ğŸ‘‹\n\n${pizarra}\n\nâš½ Â¡Sigue jugando!`
    },
    {
      label: 'ğŸ¯ Invitar a jugar maÃ±ana',
      texto: `Hola ${username}! ğŸ†\n\n${pizarra}\n\nÂ¡MaÃ±ana hay mÃ¡s partidos! No olvides entrar y hacer tus predicciones a tiempo ğŸ”¥\n\nâš½ _Quiniela Luan_`
    },
    {
      label: 'ğŸ‰ Felicitar al lÃ­der',
      texto: `ğŸ¥‡ Â¡Felicitaciones ${username}! Vas liderando la Quiniela Luan. Â¡MantÃ©n ese nivel! ğŸ’ª\n\n${pizarra}\n\nâš½ _Quiniela Luan_`
    },
    {
      label: 'â° Recordatorio predicciones',
      texto: `â° Hola ${username}! Recuerda hacer tus predicciones antes de que empiecen los partidos de hoy. Â¡No pierdas la oportunidad de sumar puntos! âš½\n\n_Quiniela Luan_`
    },
    {
      label: 'ğŸ™ Gracias por participar',
      texto: `Hola ${username}! ğŸ™ Gracias por ser parte de la Quiniela Luan. Tu participaciÃ³n hace el juego mÃ¡s emocionante. \n\n${pizarra}\n\nÂ¡Nos vemos maÃ±ana! âš½`
    },
  ];

  const lista = $('waMsgList');
  lista.innerHTML = '';
  mensajes.forEach(m => {
    const btn = document.createElement('button');
    btn.style.cssText = 'width:100%;padding:10px 14px;background:var(--card2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:Outfit,sans-serif;font-weight:700;font-size:0.8em;cursor:pointer;text-align:left;transition:all 0.2s;';
    btn.textContent = m.label;
    btn.onclick = () => {
      $('waCustomMsg').value = m.texto;
      lista.querySelectorAll('button').forEach(b=>b.style.borderColor='var(--border)');
      btn.style.borderColor = 'var(--accent)';
      btn.style.color = 'var(--accent2)';
    };
    lista.appendChild(btn);
  });

  openModal('waModal');
}

function sendWhatsApp() {
  const phone = $('waPhone').value.trim().replace(/[^0-9]/g,'');
  const msg = $('waCustomMsg').value.trim();
  if (!phone) { toast('âŒ Ingresa el nÃºmero de WhatsApp','error'); return; }
  if (!msg) { toast('âŒ Selecciona o escribe un mensaje','error'); return; }
  const encoded = encodeURIComponent(msg);
  window.open(`https://wa.me/${phone}?text=${encoded}`, '_blank');
}

function isFinishedStatus(s) {
  if (!s) return false;
  const st = s.toLowerCase();
  // TheSportsDB status values: FT=Full Time, AET=After Extra Time, PEN=Penalties
  // Match Finished = generic, AP = After Penalties
  return ['ft','match finished','finished','aet','pen','ap','complete','final','after penalties','after extra time'].includes(st);
}

function isLiveStatus(s) {
  if (!s) return false;
  const st = s.toLowerCase();
  // 1H=First Half, 2H=Second Half, HT=Half Time, ET=Extra Time, P=Penalties shootout
  return ['1h','2h','ht','et','p','in play','live','extra time','penalties'].includes(st);
}

async function adminShowGroups() {
  const el = $('adminContent');
  el.innerHTML = `<div class="empty"><span class="icon">â³</span>Cargando grupos...</div>`;
  try {
    const snap = await db.collection('groups').get();
    if (snap.empty) { el.innerHTML = `<div class="empty"><span class="icon">ğŸ“­</span>No hay grupos creados aÃºn</div>`; return; }

    let html = `<p style="font-weight:900;font-size:0.9em;margin-bottom:12px;color:var(--accent2);">ğŸ“‹ GRUPOS ACTIVOS (${snap.size}/5)</p>`;

    snap.docs.forEach((doc, i) => {
      const g = doc.data();
      const memberCount = g.members?.length || 0;
      html += `
      <div style="background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:10px;">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;">
          <div>
            <div style="font-weight:900;font-size:1em;">ğŸ‘¥ ${g.name}</div>
            <div style="font-size:0.75em;color:var(--muted);margin-top:2px;">${memberCount}/${g.maxMembers} jugadores</div>
          </div>
          <div style="text-align:center;background:var(--bg);border:2px solid var(--accent);border-radius:10px;padding:8px 14px;">
            <div style="font-size:0.65em;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:1px;">CÃ³digo</div>
            <div style="font-family:'Bebas Neue',sans-serif;font-size:1.8em;color:var(--accent2);letter-spacing:4px;">${g.code}</div>
          </div>
        </div>
        <div style="background:var(--bg);border-radius:8px;padding:10px;margin-bottom:10px;font-size:0.8em;color:var(--muted);">
          ğŸ“² Mensaje para compartir:<br>
          <span style="color:var(--text);font-weight:700;">"Ãšnete a ${g.name} en Quiniela Luan. CÃ³digo: ${g.code}"</span>
        </div>
        <div style="display:flex;gap:8px;">
          <button onclick="copyGroupCode('${g.code}','${g.name}')" style="flex:1;padding:8px;background:rgba(124,58,237,0.2);border:1px solid var(--accent);color:var(--accent2);border-radius:8px;font-weight:700;font-size:0.78em;cursor:pointer;">ğŸ“‹ Copiar mensaje</button>
          <button onclick="shareGroupWA('${g.code}','${g.name}')" style="flex:1;padding:8px;background:rgba(37,211,102,0.15);border:1px solid #25d366;color:#25d366;border-radius:8px;font-weight:700;font-size:0.78em;cursor:pointer;">ğŸ“² Compartir WA</button>
        </div>
      </div>`;
    });

    el.innerHTML = html;
  } catch(e) {
    el.innerHTML = `<div class="empty"><span class="icon">âŒ</span>${e.message}</div>`;
  }
}

function copyGroupCode(code, name) {
  const msg = `Ãšnete a "${name}" en Quiniela Luan ğŸ†\nCÃ³digo de acceso: ${code}\n\nDescarga la app y Ãºsalo al registrarte en Grupos.`;
  navigator.clipboard?.writeText(msg).then(() => toast('âœ… Mensaje copiado','success'))
    .catch(() => toast(`CÃ³digo: ${code}`,'info'));
}

function shareGroupWA(code, name) {
  const msg = encodeURIComponent(`Ãšnete a "${name}" en Quiniela Luan ğŸ†\nCÃ³digo de acceso: *${code}*\n\nâš½ Entra a la app y en Grupos â†’ Unirse â†’ escribe el cÃ³digo.`);
  window.open(`https://wa.me/?text=${msg}`, '_blank');
}

async function adminEval() {
  if (!confirm('Â¿Evaluar todos los partidos finalizados?')) return;
  alert_('â³ Evaluando...','info');
  // Primero refrescar desde Firestore para tener datos actuales
  try {
    const fsSnap = await db.collection('matches').get();
    if (!fsSnap.empty) allMatches = fsSnap.docs.map(d=>({id:d.id,...d.data()}));
  } catch(e) {}
  const fin = allMatches.filter(m => isFinishedStatus(m.status) && m.homeScore != null);
  if (!fin.length) {
    alert_(`âš ï¸ Sin partidos finalizados en memoria (${allMatches.length} cargados). Haz Sync primero.`,'warning');
    return;
  }
  let total=0, pts=0;
  for (const match of fin) {
    const realHome = match.homeScore;
    const realAway = match.awayScore;
    const realResult = realHome === realAway ? 'empate' : realHome > realAway ? 'home' : 'away';
    const psnap=await db.collection('predictions').where('matchId','==',String(match.id)).where('evaluated','==',false).get();
    const psnap2=await db.collection('predictions').where('matchId','==',match.id).where('evaluated','==',false).get();
    const allPDocs=[...psnap.docs,...psnap2.docs.filter(d2=>!psnap.docs.find(d1=>d1.id===d2.id))];
    for (const pd of allPDocs) {
      const p=pd.data(); let points=0;
      const predHome = +p.predictedHomeScore;
      const predAway = +p.predictedAwayScore;
      const predResult = predHome === predAway ? 'empate' : predHome > predAway ? 'home' : 'away';
      if (predHome === realHome && predAway === realAway) {
        points = 5; // Exacto
      } else if (predResult === realResult) {
        points = 3; // Ganador correcto o empate sin exacto
      }
      pts += points;
      await pd.ref.update({evaluated:true, pointsAwarded:points, realHome, realAway});
      total++;
    }
  }
  alert_(`âœ… ${total} predicciones evaluadas Â· ${pts} puntos distribuidos`,'success');
  loadRanking();
}

async function adminEvalManual() {
  // Carga todas las predicciones no evaluadas y cruza con los resultados reales
  // que ya estÃ¡n en memoria (allMatches) independientemente del status
  const matchesWithScores = allMatches.filter(m => m.homeScore != null && m.awayScore != null);
  
  if (!matchesWithScores.length) {
    // Si allMatches no tiene datos, cargar desde Firestore
    try {
      const snap = await db.collection('matches').get();
      const fsMatches = snap.docs.map(d=>({id:d.id,...d.data()})).filter(m=>m.homeScore!=null&&m.awayScore!=null);
      if (!fsMatches.empty && fsMatches.length) {
        await evalWithMatches(fsMatches);
        return;
      }
    } catch(e) {}
    
    // Si tampoco hay en Firestore, pedir resultados manualmente
    alert_('âš ï¸ No hay resultados en memoria. Ingresa los resultados manualmente.','warning');
    await adminEvalInputManual();
    return;
  }
  
  if (!confirm(`Â¿Evaluar usando ${matchesWithScores.length} partidos con resultados disponibles?`)) return;
  await evalWithMatches(matchesWithScores);
}

async function evalWithMatches(matches) {
  alert_('â³ Evaluando...','info');
  let total=0, pts=0;
  for (const match of matches) {
    const realHome = +match.homeScore;
    const realAway = +match.awayScore;
    const realResult = realHome===realAway?'empate':realHome>realAway?'home':'away';
    // Buscar predicciones con matchId como string O nÃºmero
    const psnap = await db.collection('predictions')
      .where('matchId','==',String(match.id))
      .where('evaluated','==',false).get();
    const psnap2 = await db.collection('predictions')
      .where('matchId','==',match.id)
      .where('evaluated','==',false).get();
    const allDocs = [...psnap.docs, ...psnap2.docs.filter(d2=>!psnap.docs.find(d1=>d1.id===d2.id))];
    for (const pd of allDocs) {
      const p=pd.data(); let points=0;
      const predHome=+p.predictedHomeScore, predAway=+p.predictedAwayScore;
      const predResult=predHome===predAway?'empate':predHome>predAway?'home':'away';
      if (predHome===realHome && predAway===realAway) {
        points=5;
        await db.collection('users').doc(p.userId).update({exactPredictions:firebase.firestore.FieldValue.increment(1)});
      } else if (predResult===realResult) {
        points=3;
        await db.collection('users').doc(p.userId).update({correctResults:firebase.firestore.FieldValue.increment(1)});
      }
      if (points>0) { await db.collection('users').doc(p.userId).update({points:firebase.firestore.FieldValue.increment(points)}); pts+=points; }
      await pd.ref.update({evaluated:true,pointsAwarded:points,realHome,realAway});
      total++;
    }
  }
  if (total===0) {
    alert_('âš ï¸ No hay predicciones sin evaluar para esos partidos.','warning');
    return;
  }
  alert_(`âœ… ${total} predicciones evaluadas Â· ${pts} puntos distribuidos`,'success');
  loadRanking();
}

async function adminEvalInputManual() {
  // Obtener predicciones Ãºnicas por matchId
  const psnap = await db.collection('predictions').where('evaluated','==',false).get();
  if (psnap.empty) { alert_('âš ï¸ No hay predicciones sin evaluar','warning'); return; }
  
  const matchIds = [...new Set(psnap.docs.map(d=>d.data().matchId))];
  const matchNames = {};
  psnap.docs.forEach(d=>{ const p=d.data(); matchNames[p.matchId]=`${p.home} vs ${p.away}`; });
  
  const results = {};
  for (const mid of matchIds) {
    const name = matchNames[mid] || mid;
    const rh = prompt(`âš½ ${name}\n\nGoles LOCAL (equipo de casa):`);
    if (rh===null) return;
    const ra = prompt(`âš½ ${name}\n\nGoles VISITANTE:`);
    if (ra===null) return;
    results[mid] = { homeScore: parseInt(rh)||0, awayScore: parseInt(ra)||0 };
  }
  
  // Evaluar con resultados ingresados
  let total=0, pts=0;
  for (const pd of psnap.docs) {
    const p=pd.data();
    const r=results[p.matchId];
    if (!r) continue;
    let points=0;
    const predResult=p.predictedHomeScore===p.predictedAwayScore?'empate':p.predictedHomeScore>p.predictedAwayScore?'home':'away';
    const realResult=r.homeScore===r.awayScore?'empate':r.homeScore>r.awayScore?'home':'away';
    if (p.predictedHomeScore===r.homeScore && p.predictedAwayScore===r.awayScore) {
      points=5;
      await db.collection('users').doc(p.userId).update({exactPredictions:firebase.firestore.FieldValue.increment(1)});
    } else if (predResult===realResult) {
      points=3;
      await db.collection('users').doc(p.userId).update({correctResults:firebase.firestore.FieldValue.increment(1)});
    }
    if (points>0) { await db.collection('users').doc(p.userId).update({points:firebase.firestore.FieldValue.increment(points)}); pts+=points; }
    await pd.ref.update({evaluated:true,pointsAwarded:points,realHomeScore:r.homeScore,realAwayScore:r.awayScore});
    total++;
  }
  alert_(`âœ… ${total} evaluadas Â· ${pts} puntos distribuidos`,'success');
  loadRanking();
}

async function adminResetPass() {
  const rawPhone = prompt('ğŸ“± TelÃ©fono del usuario (sin +58, ej: 4141234567):');
  if (!rawPhone) return;
  const phone = '58' + rawPhone.trim().replace(/^0/,'').replace(/[^0-9]/g,'');
  const email = phone + '@quiniela.app';
  try {
    await auth.sendPasswordResetEmail(email);
    toast(`âœ… Enlace enviado al telÃ©fono +${phone}`,'success');
  } catch(e) {
    if (e.code === 'auth/user-not-found') toast('âŒ TelÃ©fono no registrado','error');
    else toast(`âŒ Error: ${e.message}`,'error');
  }
}

async function adminReset() {
  const opt=confirm('MODO A: Solo predicciones (OK)\nMODO B: Todo (Cancelar)');
  if (opt===null) return;
  if (opt) { // Modo A
    if (!confirm('Â¿Borrar predicciones y resetear puntos?')) return;
    const ps=await db.collection('predictions').get();
    const b=db.batch(); ps.docs.forEach(d=>b.delete(d.ref)); await b.commit();
    const us=await db.collection('users').get();
    const b2=db.batch(); us.docs.forEach(d=>b2.update(d.ref,{points:0,exactPredictions:0,correctResults:0})); await b2.commit();
    toast('âœ… Predicciones borradas','success');
  } else { // Modo B
    const code=prompt('Escribe BORRAR-TODO para confirmar eliminaciÃ³n completa:');
    if (code!=='BORRAR-TODO') { toast('âŒ Cancelado','error'); return; }
    for (const col of ['users','predictions','groups','chat']) {
      const s=await db.collection(col).get();
      const b=db.batch(); s.docs.forEach(d=>b.delete(d.ref)); await b.commit();
    }
    toast('âœ… Base de datos limpiada','success');
    doLogout();
  }
}

// Online/offline
window.addEventListener('online',  ()=>toast('âœ… ConexiÃ³n restaurada','success'));
window.addEventListener('offline', ()=>toast('âš ï¸ Sin conexiÃ³n','warning'));

console.log('%câš½ QUINIELA LUAN V2 â€” REESCRITURA COMPLETA','color:#a855f7;font-size:16px;font-weight:bold;');
</script>
</body>
</html>



